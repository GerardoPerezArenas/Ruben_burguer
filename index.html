<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="#F85065" name="theme-color"/>
<meta content="My Little Diner TPV" name="apple-mobile-web-app-title"/>
<meta content="My Little Diner TPV" name="application-name"/>
<meta content="telephone=no" name="format-detection"/>
<meta content="no" name="msapplication-tap-highlight"/>
<title>My Little Diner TPV v9</title>
<!-- PWA Manifest -->
<link href="./manifest.json" rel="manifest"/>
<script>
  // Desactivar manifest en file:// para evitar CORS en origen 'null'
  try {
    if (location.protocol === 'file:') {
      const linkManifest = document.querySelector('link[rel="manifest"]');
      if (linkManifest) {
        linkManifest.parentNode && linkManifest.parentNode.removeChild(linkManifest);
        console.log('Manifest deshabilitado en file:// para evitar CORS');
      }
    }
  } catch(e) { /* noop */ }
  
function actualizarListaUsuarios() {
  const select = document.getElementById("loginUser");
  if (!select) return;
  select.innerHTML = '<option value="">-- Seleccionar Usuario --</option>';
  Object.keys(estado.usuarios).forEach(username => {
    const user = estado.usuarios[username];
    select.innerHTML += `<option value="${username}">${user.nombre}</option>`;
  });
}

</script>
<!-- Iconos para diferentes dispositivos -->
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='0.9em' font-size='90'&gt;馃崝&lt;/text&gt;&lt;/svg&gt;" rel="icon"/>
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='0.9em' font-size='90'&gt;馃崝&lt;/text&gt;&lt;/svg&gt;" rel="apple-touch-icon"/>
<style>
      :root {
        --c-brand: #f85065;
        --c-brand-light: #f6a9bc;
        --c-accent: #63907a;
        --c-accent-light: #b9fad8;
        --c-warn: #efe48c;
        --c-dark: #1e1413;
        --c-light: #ffffff;
        /* Logo por defecto (SVG embebido); puede ser sobrescrito por --logo-image-override */
        --logo-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' rx='24' ry='24' fill='%23f6a9bc'/%3E%3Ctext x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='140'%3E%F0%9F%8D%94%3C/text%3E%3C/svg%3E");
        
        /* Optimizaciones de rendimiento */
        --border-radius: 12px;
        --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
        --transition-fast: 0.15s ease-out;
        --transition-normal: 0.2s ease-out;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        touch-action: manipulation;
      }

      input,
      textarea,
      select {
        user-select: text !important;
        -webkit-user-select: text !important;
      }

      input[type="text"],
      input[type="password"],
      input[type="search"],
      input[type="number"],
      input[type="date"],
      textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        font-size: 16px !important;
      }
      /* Marca de agua login, m谩s grande y m谩s visible */
      #loginScreen {
        position: relative;
      }
      .login-box {
        position: relative;
        z-index: 1;
      }

      #loginScreen::after {
        content: "";
        position: absolute;
        right: max(4vw, 32px);
        top: 50%;
        transform: translateY(-50%);
        width: min(62vw, 820px);
        height: min(62vw, 820px);
        background-image: none;
        opacity: 0.94;
        pointer-events: none;
        z-index: 0;
        filter: saturate(1.1) contrast(1.05);
      }

      /* Carga diferida de la marca de agua: usa el mismo logo que el resto */
      #loginScreen.watermark-loaded::after {
        background-image: var(--logo-image-override, var(--logo-image));
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
      }

      /* En m贸viles, algo menor para no tapar la caja */
      @media (max-width: 500px) {
        #loginScreen::after {
          opacity: 1; /* doble de lo anterior (tope m谩ximo visible) */
          width: 70vw;
          height: 70vw;
          right: 12px;
        }
      }

      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-display: swap;
      }

      body {
        background: linear-gradient(
          135deg,
          var(--c-accent-light) 0%,
          var(--c-brand-light) 100%
        );
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-top: env(safe-area-inset-top);
        /* GPU acceleration */
        will-change: scroll-position;
        transform: translateZ(0);
      }

      /* LOGIN SCREEN */
      #loginScreen {
        position: fixed;
        inset: 0;
        background: linear-gradient(
          135deg,
          var(--c-accent-light) 0%,
          var(--c-brand-light) 100%
        );
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        will-change: opacity, transform;
      }

      #loginScreen.hidden {
        opacity: 0;
        transform: translateY(-100%);
        pointer-events: none;
      }

      .login-box {
        background: var(--c-light);
        border-radius: 30px;
        padding: 35px 25px;
        width: 100%;
        max-width: 960px;
        margin: 0 auto;
        box-shadow: 0 20px 60px rgba(248, 80, 101, 0.3);
        animation: fadeInUp 0.5s;
      }

      /* Dos columnas en escritorio: formulario + logo */
      .login-two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        align-items: center;
        gap: 28px;
      }

      .login-form-col {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .login-logo-col {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* La caja de login queda centrada en todas las resoluciones */

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-logo {
        /* Mostrar el logo como imagen de fondo, reutilizando el override si existe */
        background-image: var(--logo-image-override, var(--logo-image));
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        width: clamp(140px, 28vw, 320px);
        height: clamp(140px, 28vw, 320px);
        margin: 0 auto 15px auto;
        filter: drop-shadow(0 4px 6px rgba(248, 80, 101, 0.3));
        /* Ocultar cualquier contenido textual (emoji anterior) */
        font-size: 0;
        line-height: 0;
      }

      .login-title {
        text-align: center;
        color: var(--c-brand);
        font-size: 2em;
        font-weight: 900;
        margin-bottom: 8px;
        letter-spacing: -1px;
      }

      .login-subtitle {
        text-align: center;
        color: var(--c-accent);
        font-size: 1em;
        margin-bottom: 30px;
        font-weight: 500;
      }

      /* En m贸vil, apilar columnas y mostrar el logo arriba */
      @media (max-width: 700px) {
        .login-two-col {
          grid-template-columns: 1fr;
        }
        .login-logo-col {
          order: -1;
        }
      }

      /* Si usamos el logo a un lado en escritorio, ocultamos la marca de agua de fondo */
      @media (min-width: 900px) {
        #loginScreen::after {
          opacity: 0;
        }
        #loginScreen.watermark-loaded::after {
          opacity: 0;
        }
      }

      .login-select,
      .login-input {
        width: 100%;
        padding: 18px;
        border: 3px solid var(--c-brand);
        border-radius: 15px;
        font-size: 17px;
        margin-bottom: 15px;
        font-weight: 600;
        color: var(--c-dark);
      }

      .login-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F85065' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 15px center;
        background-repeat: no-repeat;
        background-size: 20px;
        padding-right: 45px;
      }

      .login-button {
        width: 100%;
        padding: 20px;
        background: linear-gradient(
          135deg,
          var(--c-brand) 0%,
          var(--c-brand-light) 100%
        );
        color: var(--c-light);
        border: none;
        border-radius: 15px;
        font-size: 18px;
        font-weight: 800;
        cursor: pointer;
        text-transform: uppercase;
        box-shadow: 0 10px 30px rgba(248, 80, 101, 0.3);
      }

      .login-button:active {
        transform: scale(0.98);
      }

      .login-error {
        background: var(--c-brand);
        color: var(--c-light);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
        display: none;
      }

      .login-error.show {
        display: block;
        animation: shake 0.5s;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      /* MAIN SCREEN */
      #mainScreen {
        display: none;
        width: 100%;
        padding: 15px;
        padding-bottom: calc(85px + env(safe-area-inset-bottom));
        background: var(--c-light);
        min-height: 100vh;
      }

      #mainScreen.active {
        display: block;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--c-brand) 0%,
          var(--c-brand-light) 100%
        );
        color: var(--c-light);
        padding: 18px;
        border-radius: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 25px rgba(248, 80, 101, 0.25);
      }

      .header-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.3em;
        font-weight: 800;
      }

      /* (Logo en cabecera revertido por petici贸n) */

      .header-user {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85em;
      }

      .user-badge {
        padding: 6px 12px;
        background: var(--c-light);
        color: var(--c-brand);
        border-radius: 20px;
        font-size: 0.75em;
        font-weight: 700;
        text-transform: uppercase;
      }

      .user-badge.admin {
        background: var(--c-accent);
        color: var(--c-light);
      }

      .btn-logout {
        padding: 8px 14px;
        background: var(--c-light);
        color: var(--c-brand);
        border: none;
        border-radius: 20px;
        font-size: 0.75em;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
      }

      /* ADMIN PANEL */
      .admin-panel {
        background: linear-gradient(
          135deg,
          var(--c-accent) 0%,
          var(--c-accent) 100%
        );
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        display: none;
        box-shadow: 0 8px 25px rgba(99, 144, 122, 0.25);
      }

      .admin-panel.show {
        display: block;
      }

      .admin-title {
        color: var(--c-light);
        font-size: 1.1em;
        font-weight: 800;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
      }

      .admin-btn {
        padding: 18px 12px;
        background: var(--c-light);
        color: var(--c-accent);
        border: none;
        border-radius: 15px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        transition: all 0.2s ease-out;
        text-transform: uppercase;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .admin-btn:active {
        transform: scale(0.95);
        background: var(--c-accent-light);
      }

      .admin-btn .icon {
        font-size: 1.8em;
      }

      /* STATS BAR */
      .stats-bar {
        background: linear-gradient(
          135deg,
          var(--c-accent-light) 0%,
          var(--c-warn) 100%
        );
        border-radius: 20px;
        padding: 18px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-around;
        gap: 10px;
        overflow-x: auto;
        box-shadow: 0 6px 20px rgba(185, 250, 216, 0.4);
      }

      .stat-item {
        text-align: center;
        flex: 1;
        min-width: 65px;
      }

      .stat-value {
        font-size: 1.6em;
        font-weight: 900;
        color: var(--c-brand);
      }

      .stat-label {
        font-size: 0.65em;
        text-transform: uppercase;
        color: var(--c-accent);
        margin-top: 2px;
        font-weight: 600;
      }

      /* ZONES & TABLES */
      .zones {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .zone {
        background: var(--c-light);
        border-radius: 20px;
        padding: 18px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--c-accent-light);
      }

      .zone h2 {
        color: var(--c-brand);
        margin-bottom: 15px;
        font-size: 1em;
        font-weight: 800;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tables {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 12px;
      }

      .table {
        aspect-ratio: 1;
        border: 3px solid var(--c-accent-light);
        border-radius: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 700;
        position: relative;
        min-height: 80px;
        font-size: 0.9em;
        background: var(--c-light);
      }

      .table:active {
        transform: scale(0.95);
      }

      .table.libre {
        background: linear-gradient(
          135deg,
          var(--c-accent-light) 0%,
          var(--c-accent-light) 100%
        );
        border-color: var(--c-accent);
        color: var(--c-dark);
      }

      .table.ocupada {
        background: linear-gradient(
          135deg,
          var(--c-brand) 0%,
          var(--c-brand-light) 100%
        );
        border-color: var(--c-brand);
        color: var(--c-light);
        animation: pulse 2s infinite;
      }

      .table.pagado {
        background: linear-gradient(135deg, var(--c-warn) 0%, #ffd700 100%);
        border-color: #ffd700;
        color: var(--c-dark);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .table .time-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--c-brand);
        color: var(--c-light);
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
      }

      .numero-mesa {
        font-size: 1.2em;
        font-weight: 900;
      }

      .precio-mesa {
        font-size: 1em;
        margin-top: 5px;
        font-weight: 700;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: var(--c-light);
        z-index: 1000;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        overflow: hidden;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: var(--c-light);
        border-radius: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: fadeInModal 0.25s ease-out;
      }

      @keyframes fadeInModal {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--c-brand);
        color: white;
        padding: 20px;
        flex-shrink: 0;
      }

      .modal-title {
        margin: 0;
        font-size: 1.3em;
        font-weight: 800;
        color: white;
        text-transform: uppercase;
      }

      .modal-close {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 1.8em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .modal-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Asegurar que todos los modales sean pantalla completa */
      body.modal-open {
        overflow: hidden;
      }

      .modal.show {
        display: flex !important;
      }

      /* Estilos para admin-grid dentro de modales */
      .modal .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        padding: 20px 0;
      }

      /* ===================== */
      /* Marca de agua general */
      /* ===================== */
      .watermark {
        position: relative;
        isolation: isolate; /* asegura capa propia para z-index del ::after */
      }
      .watermark::after {
        content: "";
        position: absolute;
        inset: 0;
  /* usa logo por defecto o el override si est谩 definido */
  background-image: var(--logo-image-override, var(--logo-image));
        background-repeat: no-repeat;
        background-position: right 40px center;
        background-size: min(38vw, 520px);
        opacity: 0.045; /* muy fino */
        pointer-events: none;
        z-index: 0;
        mix-blend-mode: multiply;
      }
      /* Asegura el contenido encima de la marca */
      .watermark > * {
        position: relative;
        z-index: 1;
      }

      /* Responsivo: en m贸viles baja tama帽o */
      @media (max-width: 640px) {
        .watermark::after {
          background-position: right 20px center;
          background-size: 60vw;
          opacity: 0.05;
        }
      }
      /* Evita solapar en pantallas muy bajas */
      @media (max-height: 580px) {
        .watermark::after {
          display: none;
        }
      }

      /* ======================= */
      /* Marca de agua en modal */
      /* ======================= */
      .watermark-modal {
        position: relative;
      }
      .watermark-modal::before {
        content: "";
        position: absolute;
        inset: 12px; /* respeta bordes redondeados */
  background-image: var(--logo-image-override, var(--logo-image));
        background-repeat: no-repeat;
        background-position: center 65%;
        background-size: min(42vw, 480px);
        opacity: 0.035;
        pointer-events: none;
        z-index: 0;
        mix-blend-mode: multiply;
      }
      /* Eleva el contenido del modal sobre la marca */
      .modal-content > * {
        position: relative;
        z-index: 1;
      }

      /* SEARCH & CATEGORIES */
      .search-bar {
        position: sticky;
        top: -25px;
        background: var(--c-light);
        z-index: 10;
        padding: 15px 0;
        margin: -15px 0 20px 0;
      }

      .search-bar input {
        width: 100%;
        padding: 18px;
        border: 3px solid var(--c-accent-light);
        border-radius: 15px;
        font-size: 16px !important;
        font-weight: 600;
      }

      .search-bar input:focus {
        outline: none;
        border-color: var(--c-brand);
        box-shadow: 0 0 0 4px rgba(248, 80, 101, 0.1);
      }

      .category-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 5px;
      }

      .category-tab {
        padding: 14px 20px;
        background: var(--c-light);
        border: 3px solid var(--c-accent-light);
        border-radius: 15px;
        color: var(--c-accent);
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
        text-transform: uppercase;
        flex-shrink: 0;
        font-size: 0.85em;
      }

      .category-tab.active {
        background: linear-gradient(
          135deg,
          var(--c-brand) 0%,
          var(--c-brand-light) 100%
        );
        color: var(--c-light);
        border-color: var(--c-brand);
      }

      /* PRODUCTS */
      .products {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 20px 0;
      }

      .product {
        padding: 18px;
        border: 3px solid var(--c-accent-light);
        border-radius: 18px;
        background: var(--c-light);
        cursor: pointer;
        text-align: center;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: relative;
      }

      .product:active {
        transform: scale(0.95);
        background: var(--c-accent-light);
      }

      .product-name {
        font-weight: 800;
        font-size: 0.95em;
        color: var(--c-dark);
        text-transform: uppercase;
        margin-bottom: 6px;
      }

      .product-price {
        color: var(--c-brand);
        font-size: 1.2em;
        font-weight: 900;
      }

      .product-description {
        color: var(--c-accent);
        font-size: 0.75em;
        margin-top: 4px;
        font-weight: 500;
      }

      .product-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--c-brand);
        color: var(--c-light);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.7em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
      }

      /* MODIFICATIONS */
      .modifications-panel {
        background: var(--c-accent-light);
        border-radius: 18px;
        padding: 18px;
        margin: 18px 0;
      }

      .modifications-panel h4 {
        color: var(--c-dark);
        margin-bottom: 12px;
        font-size: 1em;
        font-weight: 800;
        text-transform: uppercase;
      }

      .mod-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .mod-item {
        padding: 12px;
        border: 2px solid var(--c-accent);
        border-radius: 12px;
        background: var(--c-light);
        cursor: pointer;
        font-size: 0.85em;
        text-align: center;
        font-weight: 600;
        color: var(--c-accent);
      }

      .mod-item.selected {
        background: var(--c-brand);
        color: var(--c-light);
        border-color: var(--c-brand);
      }

      .allergen-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .allergen-tag {
        padding: 8px 14px;
        border: 2px solid var(--c-brand-light);
        border-radius: 20px;
        background: var(--c-light);
        font-size: 0.75em;
        font-weight: 600;
        color: var(--c-brand);
      }

      /* CART */
      .cart {
        border-top: 3px solid var(--c-accent-light);
        margin-top: 25px;
        padding-top: 20px;
      }

      .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .cart-header h3 {
        font-size: 1.1em;
        font-weight: 800;
        color: var(--c-brand);
        text-transform: uppercase;
      }

      .cart-total {
        font-size: 1.3em;
        font-weight: 900;
        color: var(--c-accent);
      }

      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
        background: var(--c-accent-light);
        border-radius: 12px;
        margin-bottom: 10px;
      }

      .cart-item-info {
        flex: 1;
        margin-right: 10px;
      }

      .cart-item-name {
        font-weight: 700;
        font-size: 0.9em;
        color: var(--c-dark);
        text-transform: uppercase;
      }

      .cart-item-details {
        color: var(--c-accent);
        font-size: 0.75em;
        margin-top: 3px;
        font-weight: 500;
      }

      .cart-item-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .quantity-btn {
        width: 32px;
        height: 32px;
        border: 2px solid var(--c-brand);
        border-radius: 50%;
        background: var(--c-light);
        color: var(--c-brand);
        font-size: 1.2em;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quantity-value {
        font-weight: 800;
        min-width: 25px;
        text-align: center;
        color: var(--c-dark);
      }

      .cart-item-price {
        font-weight: 800;
        margin-left: 12px;
        color: var(--c-brand);
        font-size: 1em;
      }

      /* BUTTONS */
      .btn {
        padding: 18px 25px;
        border: none;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 0.95em;
        min-height: 52px;
        text-transform: uppercase;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .btn:active:not(:disabled) {
        transform: scale(0.95);
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--c-brand) 0%,
          var(--c-brand-light) 100%
        );
        color: var(--c-light);
      }

      .btn-success {
        background: linear-gradient(
          135deg,
          var(--c-accent) 0%,
          var(--c-accent) 100%
        );
        color: var(--c-light);
      }

      .btn-danger {
        background: var(--c-light);
        color: var(--c-brand);
        border: 3px solid var(--c-brand);
      }

      .btn-info {
        background: linear-gradient(
          135deg,
          var(--c-accent-light) 0%,
          var(--c-warn) 100%
        );
        color: var(--c-dark);
      }

      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .action-buttons .btn {
        flex: 1;
        min-width: calc(50% - 6px);
      }

      /* FAB RESUMEN */
      .fab-resumen {
        position: fixed;
        top: calc(100px + env(safe-area-inset-top));
        right: 20px;
        padding: 12px 18px;
        border-radius: 25px;
        background: var(--c-light);
        color: var(--c-brand);
        border: 3px solid var(--c-brand);
        box-shadow: 0 6px 20px rgba(248, 80, 101, 0.3);
        font-size: 0.85em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 998;
        cursor: pointer;
      }

      /* FAB PARA LLEVAR */
      .fab {
        position: fixed;
        bottom: calc(20px + env(safe-area-inset-bottom));
        right: 20px;
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--c-accent) 0%,
          var(--c-accent) 100%
        );
        color: var(--c-light);
        border: 3px solid var(--c-light);
        box-shadow: 0 6px 20px rgba(99, 144, 122, 0.4);
        font-size: 1.6em;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 998;
        cursor: pointer;
      }

      .fab-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--c-brand);
        color: var(--c-light);
        min-width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7em;
        font-weight: 800;
        border: 2px solid var(--c-light);
      }

      /* TOAST */
      .toast {
        position: fixed;
        bottom: calc(100px + env(safe-area-inset-bottom));
        left: 50%;
        transform: translateX(-50%);
        background: var(--c-dark);
        color: var(--c-light);
        padding: 16px 24px;
        border-radius: 25px;
        box-shadow: 0 6px 20px rgba(30, 20, 19, 0.3);
        z-index: 9999;
        display: none;
        font-size: 0.9em;
        font-weight: 600;
        max-width: 85%;
        text-align: center;
      }

      .toast.show {
        display: block;
        animation: toastSlideIn 0.3s;
      }

      @keyframes toastSlideIn {
        from {
          transform: translate(-50%, 100%);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      .toast.success {
        background: var(--c-accent);
      }
      .toast.error {
        background: var(--c-brand);
      }

      /* FORM GESTOR */
      .form-gestor {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .form-gestor label {
        font-weight: 600;
        color: var(--c-accent);
        font-size: 0.9em;
      }
      .form-gestor input,
      .form-gestor select,
      .form-gestor textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--c-accent-light);
        border-radius: 12px;
        font-size: 16px !important;
      }

      .item-gestor {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--c-accent-light);
        border-radius: 12px;
        margin-bottom: 10px;
      }

      .item-gestor-info {
        font-weight: 600;
      }

      .item-gestor-actions button {
        margin-left: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: var(--c-light);
      }

      /* REPORTS */
      .report-section {
        margin-bottom: 25px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 15px;
        overflow: hidden;
      }

      .report-section summary {
        font-weight: 800;
        font-size: 1.1em;
        color: var(--c-brand);
        padding: 15px;
        cursor: pointer;
        background: #fff;
      }

      .report-section[open] summary {
        border-bottom: 1px solid #eee;
      }

      .report-content {
        padding: 15px;
      }

      .report-item {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--c-accent-light);
      }

      .report-item:last-child {
        border-bottom: none;
      }

      .report-sub-item {
        list-style: none;
        padding-left: 15px;
        margin-top: 5px;
        font-size: 0.9em;
        color: var(--c-accent);
      }

      .camarero-item {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
      }
		/* Modal tipo pantalla completa */
.pantalla-completa.modal {
  position: fixed;
  inset: 0;
  background: var(--c-light);
  z-index: 10000;
  display: none;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  overflow: hidden;
}

.pantalla-completa.modal.show {
  display: flex;
}

.pantalla-completa .modal-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0;
  margin: 0;
  border-radius: 0;
  background: var(--c-light);
  animation: fadeInModal 0.25s ease-out;
  overflow: hidden;
}

.pantalla-completa .modal-header {
  background: var(--c-brand);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.pantalla-completa .modal-title {
  margin: 0;
  font-size: 1.2em;
  font-weight: 600;
}

.pantalla-completa .modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.8em;
  cursor: pointer;
  padding: 8px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
  font-weight: bold;
  line-height: 1;
}

.pantalla-completa .modal-close:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

/* Estilos para modal-content con close button */
.modal-content .close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(0, 0, 0, 0.1);
  border: none;
  color: var(--c-dark);
  font-size: 1.5em;
  cursor: pointer;
  padding: 8px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
  font-weight: bold;
  z-index: 1001;
}

.modal-content .close-btn:hover {
  background: rgba(248, 80, 101, 0.1);
  color: var(--c-brand);
  transform: scale(1.1);
}

.pantalla-completa #modalBody {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: var(--c-light);
}

/* Estilos espec铆ficos para el contenido del modal */
.pantalla-completa #modalBody .action-buttons {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.pantalla-completa #modalBody .action-buttons .btn {
  flex: 1;
  padding: 15px 20px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.pantalla-completa #modalBody .btn-danger {
  background: #f85065;
  color: white;
}

.pantalla-completa #modalBody .btn-success {
  background: #63907a;
  color: white;
}

.pantalla-completa #modalBody .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Asegurar que no hay altura m谩xima problem谩tica */
.pantalla-completa .modal-content {
  min-height: 100vh;
  height: 100vh;
}

/* Estilos para inputs en el modal */
.pantalla-completa #modalBody input[type="text"] {
  background: white;
  border: 2px solid var(--c-accent-light);
  padding: 15px;
  border-radius: 12px;
  font-size: 16px;
  width: 100%;
  box-sizing: border-box;
}

.pantalla-completa #modalBody input[type="text"]:focus {
  outline: none;
  border-color: var(--c-brand);
  box-shadow: 0 0 0 3px rgba(248, 80, 101, 0.1);
}


@keyframes fadeInModal {
from {
transform: translateY(100%);
opacity: 0;
}
to {
transform: translateY(0%);
opacity: 1;
}
}

/* ======================= */
/* Estilos para Combos Paso a Paso */
/* ======================= */
.combo-step {
  transition: all 0.3s ease-out;
  position: relative;
  width: 100%;
  opacity: 1;
  transform: translateX(0);
}

.combo-step:not(.active):not([style*="display: block"]) {
  display: none !important;
}

.modal-content {
  background: var(--c-light);
  border-radius: 30px 30px 0 0;
  padding: 25px 20px;
  width: 100%;
  max-height: 92vh;
  overflow-y: auto;
  overflow-x: hidden; /* Evitar scroll horizontal */
  -webkit-overflow-scrolling: touch;
  animation: slideInUp 0.3s;
  padding-bottom: calc(25px + env(safe-area-inset-bottom));
  position: relative;
}

.progress-dots {
  align-items: center;
  z-index: 10;
  position: relative;
}

.progress-dot {
  transition: background-color 0.3s ease;
}

.step-header {
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 5;
}

.patatas-option, .bebida-option {
  transform: scale(1);
  transition: all 0.2s ease;
}

.patatas-option:hover, .bebida-option:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

.patatas-option.selected, .bebida-option.selected {
  transform: scale(1.02);
  box-shadow: 0 4px 20px rgba(248, 80, 101, 0.3);
  border-color: var(--c-brand) !important;
  background: var(--c-accent-light) !important;
}

.burger-mod {
  transform: scale(1);
  transition: all 0.2s ease;
}

.burger-mod:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.burger-mod.selected {
  border-color: var(--c-brand) !important;
  background: var(--c-accent-light) !important;
  transform: scale(1.02);
}

.btn-step-next, .btn-step-back, .btn-step-final {
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-step-next:hover, .btn-step-back:hover, .btn-step-final:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.summary-item {
  transition: all 0.2s ease;
}

.summary-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Responsive para m贸viles */
@media (max-width: 640px) {
  .patatas-grid, .bebida-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
  }
  
  .mod-grid {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
  }
  
  .step-header h4 {
    font-size: 1em;
  }
  
  .final-actions {
    flex-direction: column;
  }
  
  .final-actions button {
    margin-bottom: 10px;
  }
}
</style>

<style>
/* MLD: Fix legibilidad informes - texto en filas de camarero y productos */
.report-section .report-content .report-item,
.report-section .report-content .report-item span {
  color: #222 !important;
  opacity: 1 !important;
}
</style>

</head>
<body>

<style>
  /* Legibilidad en "Gestionar Productos" dentro del modal */
  .modal .categorias-productos summary {
    color: var(--c-brand) !important; /* rosa corporativo */
    font-weight: 900;
    text-transform: uppercase;
  }
  .modal .categorias-productos details {
    background: #ffffff;
    border: 2px solid var(--c-accent-light);
    border-radius: 12px;
    margin-bottom: 12px;
  }
  .modal .categorias-productos .item-gestor,
  .modal .categorias-productos .item-gestor * {
    color: #111 !important; /* texto negro para contraste */
  }
  .modal .categorias-productos .item-gestor-actions button {
    color: var(--c-brand) !important;
    border: 2px solid var(--c-brand);
    background: #fff;
  }
</style>


<body>
<!-- LOGIN SCREEN -->
<div id="loginScreen">
<div class="login-box">
  <div class="login-two-col">
    <div class="login-form-col">
      <h1 class="login-title">MY LITTLE DINER</h1>
      <p class="login-subtitle">Sistema TPV Profesional v3.5</p>
      <div class="login-error" id="loginError"></div>
      <select class="login-select" id="loginUser">
        <option value="">-- Seleccionar Usuario --</option>
      </select>
      <input
        type="password"
        id="loginPassword"
        class="login-input"
        placeholder="Contrase帽a"
        inputmode="numeric"
        pattern="[0-9]*"
        autocomplete="off"
        enterkeyhint="done"
        onkeyup="if(event.key==='Enter') intentarLogin()"
      />
      <button class="login-button" onclick="intentarLogin()">Iniciar Sesi贸n</button>
    </div>
    <div class="login-logo-col">
      <div class="login-logo" aria-hidden="true"></div>
    </div>
  </div>
</div>
</div>
<!-- MAIN SCREEN -->
<div class="watermark" id="mainScreen">
<header class="header">
<div class="header-title">
<span>馃崝</span><span id="headerTitle">MY LITTLE DINER</span>
</div>
<div class="header-user">
<span id="userDisplay"></span>
<span class="user-badge" id="userRole"></span>
<button class="btn-logout" onclick="cerrarSesion()">Salir</button>
</div>
</header>
<div class="admin-panel" id="adminPanel"></div>
<div class="stats-bar">
<div class="stat-item">
<div class="stat-value" id="mesasOcupadas">0</div>
<div class="stat-label">Ocupadas</div>
</div>
<div class="stat-item">
<div class="stat-value" id="serviciosHoy">0</div>
<div class="stat-label">Servicios</div>
</div>
<div class="stat-item">
<div class="stat-value" id="ventasHoy">0鈧?/div>
<div class="stat-label">Ventas</div>
</div>
<div class="stat-item">
<div class="stat-value" id="ticketMedio">0鈧?/div>
<div class="stat-label">Ticket</div>
</div>
<div class="stat-item">
<div class="stat-value" id="pedidosLlevar">0</div>
<div class="stat-label">Llevar</div>
</div>
</div>
<!-- Bot贸n de resumen eliminado -->
<div class="zones" id="zonas"></div>
<div class="modal pantalla-completa" id="modal">
<div class="modal-content watermark-modal">
<div class="modal-header">
<h2 class="modal-title" id="modalTitle"></h2>
<button class="modal-close" onclick="cerrarModal()">脳</button>
</div>
<div id="modalBody"></div>
</div>
</div>
<button class="fab" onclick="nuevoPedidoParaLlevar()">
        馃泹锔?span class="fab-badge" id="takeawayBadge" style="display: none">0</span>
</button>
<div class="toast" id="toast"></div>
</div>
<script>
  // MODO DEMO apagado por defecto
  window.MODO_DEMO = false;

	
	
      "use strict";

  // --- UX guard: marcar cuando el usuario realiza una interacci贸n (permitir vibraci贸n/AudioContext) ---
  window.userInteracted = false;
  function markUserInteracted() {
    if (window.userInteracted) return;
    window.userInteracted = true;
    // una vez detectada interacci贸n, dejamos de escuchar
    ['pointerdown', 'keydown', 'touchstart', 'click'].forEach(evt => {
      document.removeEventListener(evt, markUserInteracted);
    });
    try {
      // Si hay una AudioContext pausada por falta de gesto, intentar reanudarla
      if (window.__deferredAudioContext && typeof window.__deferredAudioContext.resume === 'function') {
        window.__deferredAudioContext.resume().catch(()=>{});
      }
    } catch(e){}
  }
  ['pointerdown', 'keydown', 'touchstart', 'click'].forEach(evt => {
    document.addEventListener(evt, markUserInteracted, { passive: true, once: false });
  });

      const CONFIG = {
        EMPRESA: "MY LITTLE DINER",
        VERSION: "3.5",
        MONEDA: "鈧?,
      };

      // Cache de elementos DOM para mejor rendimiento
      const DOM_CACHE = {
        loginScreen: null,
        mainScreen: null,
        loginUser: null,
        loginPassword: null,
        loginError: null,
        userDisplay: null,
        userRole: null,
        mesasGrid: null,
        productosGrid: null,
        productosContainer: null,
        combosContainer: null,
        modificacionesModal: null,
        orderItems: null,
        orderTotal: null,
        parallevarContainer: null,
        
        // M茅todo para obtener elementos con cache
        get(id) {
          if (!this[id]) {
            this[id] = document.getElementById(id);
          }
          return this[id];
        },
        
        // M茅todo para limpiar cache si es necesario
        clear() {
          Object.keys(this).forEach(key => {
            if (typeof this[key] !== 'function') {
              this[key] = null;
            }
          });
        }
      };

      // ESTADO GLOBAL
      let estado = {
        usuarios: {},
        productos: {},
        combos: [],
        mesas: new Map(),
        pedidos: [],
        currentOrder: null,
        modificacionesActuales: new Set(),
        categoriaActiva: "combos",
        usuarioActual: null,
        sesionActiva: false,
        turnoInicio: null,
        intentosFallidos: 0,
      };

      // Funci贸n para escapar HTML y prevenir XSS
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // DATOS POR DEFECTO
      function getDefaultData() {
        return {
          usuarios: {
            admin: {
              password: "admin123",
              nombre: "Administrador",
              rol: "admin",
            },
            gerardo: { password: "1234", nombre: "Gerardo", rol: "admin" },
            camarero1: {
              password: "cam1",
              nombre: "Camarero 1",
              rol: "camarero",
            },
            camarero2: {
              password: "cam2",
              nombre: "Camarero 2",
              rol: "camarero",
            },
            cajero: { password: "caja1234", nombre: "Cajero", rol: "cajero" },
          },
          productos: {
            combos: [
              {
                id: 100,
                nombre: "COMBO MARILYN",
                precio: 16.5,
                descripcion: "Burger + Patatas + Bebida",
                ahorro: 2.9,
                incluye: {
                  burger: "MARILYN",
                  patatas: [
                    "Fritas Cl谩sicas",
                    "Deluxe (+1鈧?",
                    "Boniato (+1.5鈧?",
                  ],
                  bebida: ["Coca-Cola", "Coca Zero", "Fanta", "Sprite", "Agua"],
                },
                alergenos: ["gluten", "lactosa"],
                modificaciones: [
                  "Sin cebolla",
                  "Sin pepinillo",
                  "Extra bacon",
                  "Extra queso",
                ],
              },
              {
                id: 101,
                nombre: "COMBO ELVIS",
                precio: 18.5,
                descripcion: "Burger + Patatas + Bebida",
                ahorro: 3.4,
                incluye: {
                  burger: "ELVIS",
                  patatas: [
                    "Fritas Cl谩sicas",
                    "Deluxe (+1鈧?",
                    "Boniato (+1.5鈧?",
                  ],
                  bebida: ["Coca-Cola", "Coca Zero", "Fanta", "Sprite", "Agua"],
                },
                alergenos: ["gluten", "lactosa"],
                modificaciones: [
                  "Sin rulo",
                  "Sin ar谩ndanos",
                  "Extra queso",
                  "Punto carne",
                ],
              },
              {
                id: 102,
                nombre: "COMBO PATTY",
                precio: 19.5,
                descripcion: "Burger + Patatas + Bebida",
                ahorro: 3.9,
                incluye: {
                  burger: "PATTY MELT",
                  patatas: [
                    "Fritas Cl谩sicas",
                    "Deluxe (+1鈧?",
                    "Boniato (+1.5鈧?",
                  ],
                  bebida: ["Coca-Cola", "Coca Zero", "Fanta", "Sprite", "Agua"],
                },
                alergenos: ["gluten", "lactosa"],
                modificaciones: ["Sin cebolla", "Extra queso", "Punto carne"],
              },
            ],
            burgers: [
              {
                id: 1,
                nombre: "MARILYN",
                precio: 12.9,
                descripcion: "Fat Smash, Cheddar, Bacon",
                ingredientes:
                  "Carne 180g, pan brioche, queso cheddar, bacon crujiente",
                alergenos: ["gluten", "lactosa"],
                modificaciones: [
                  "Sin cebolla",
                  "Sin pepinillo",
                  "Extra bacon",
                  "Extra queso",
                  "Punto carne",
                ],
                categoria_impresion: "cocina",
              },
              {
                id: 2,
                nombre: "ELVIS",
                precio: 13.9,
                descripcion: "Doble, Rulo cabra, Ar谩ndanos",
                ingredientes:
                  "Doble carne 360g, pan brioche, rulo de cabra, ar谩ndanos",
                alergenos: ["gluten", "lactosa"],
                modificaciones: [
                  "Sin rulo",
                  "Sin ar谩ndanos",
                  "Extra queso",
                  "Punto carne",
                ],
                categoria_impresion: "cocina",
              },
              {
                id: 3,
                nombre: "PATTY MELT",
                precio: 15.9,
                descripcion: "Doble, Cebolla Jack Daniels",
                ingredientes:
                  "Doble carne 360g, pan de molde tostado, queso suizo",
                alergenos: ["gluten", "lactosa"],
                modificaciones: ["Sin cebolla", "Extra queso", "Punto carne"],
                categoria_impresion: "cocina",
              },
              {
                id: 4,
                nombre: "STEVE MCQUEEN",
                precio: 12.9,
                descripcion: "Cl谩sica americana",
                ingredientes: "Carne 180g, pan brioche, queso americano",
                alergenos: ["gluten", "lactosa", "huevo"],
                modificaciones: [
                  "Sin cebolla",
                  "Sin pepinillo",
                  "Sin lechuga",
                  "Extra queso",
                ],
                categoria_impresion: "cocina",
              },
              {
                id: 5,
                nombre: "GIVE ME MORE",
                precio: 15.9,
                descripcion: "Con donuts!",
                ingredientes: "Carne 180g, donuts glaseados como pan",
                alergenos: ["gluten", "lactosa", "huevo"],
                modificaciones: ["Sin bacon", "Extra queso", "Punto carne"],
                categoria_impresion: "cocina",
              },
            ],
            snacks: [
              {
                id: 10,
                nombre: "POLLO CRUJIENTE",
                precio: 10.5,
                descripcion: "Tiras con 2 salsas",
                alergenos: ["gluten"],
                modificaciones: ["Sin salsa", "Salsa aparte"],
                categoria_impresion: "cocina",
              },
              {
                id: 11,
                nombre: "BACON CHEESE FRIES",
                precio: 10.5,
                descripcion: "Patatas cargadas",
                alergenos: ["lactosa"],
                modificaciones: ["Sin bacon", "Extra queso"],
                categoria_impresion: "cocina",
              },
              {
                id: 12,
                nombre: "NACHOS",
                precio: 11.5,
                descripcion: "Con todo",
                alergenos: ["lactosa"],
                modificaciones: [
                  "Sin jalape帽os",
                  "Sin guacamole",
                  "Extra queso",
                ],
                categoria_impresion: "cocina",
              },
              {
                id: 13,
                nombre: "ALITAS BUFFALO",
                precio: 10.5,
                descripcion: "Picantes",
                alergenos: [],
                modificaciones: ["Menos picante", "Salsa aparte"],
                categoria_impresion: "cocina",
              },
            ],
            postres: [
              {
                id: 20,
                nombre: "BROWNIE DELUXE",
                precio: 6.9,
                descripcion: "Con helado",
                alergenos: ["gluten", "lactosa", "huevo", "frutos-secos"],
                modificaciones: ["Sin helado", "Sin nata"],
                categoria_impresion: "cocina",
              },
              {
                id: 21,
                nombre: "CHEESECAKE",
                precio: 6.5,
                descripcion: "NY Style",
                alergenos: ["gluten", "lactosa", "huevo"],
                modificaciones: ["Sin coulis"],
                categoria_impresion: "cocina",
              },
              {
                id: 22,
                nombre: "HELADO",
                precio: 4.9,
                descripcion: "3 bolas",
                alergenos: ["lactosa"],
                modificaciones: ["Sabores especiales"],
                categoria_impresion: "cocina",
              },
            ],
            bebidas: [
              {
                id: 30,
                nombre: "COCA-COLA",
                precio: 3.5,
                modificaciones: ["Sin hielo", "Mucho hielo"],
                categoria_impresion: "barra",
              },
              {
                id: 31,
                nombre: "COCA ZERO",
                precio: 3.5,
                modificaciones: ["Sin hielo", "Mucho hielo"],
                categoria_impresion: "barra",
              },
              {
                id: 32,
                nombre: "FANTA",
                precio: 3.5,
                modificaciones: ["Sin hielo", "Mucho hielo"],
                categoria_impresion: "barra",
              },
              {
                id: 33,
                nombre: "SPRITE",
                precio: 3.5,
                modificaciones: ["Sin hielo", "Mucho hielo"],
                categoria_impresion: "barra",
              },
              {
                id: 34,
                nombre: "AGUA",
                precio: 2.5,
                categoria_impresion: "barra",
              },
            ],
            cervezas: [
              {
                id: 40,
                nombre: "LAGER 33CL",
                precio: 3.5,
                categoria_impresion: "barra",
              },
              {
                id: 41,
                nombre: "LAGER 50CL",
                precio: 5.5,
                categoria_impresion: "barra",
              },
              {
                id: 42,
                nombre: "0,0",
                precio: 3.5,
                categoria_impresion: "barra",
              },
              {
                id: 43,
                nombre: "SIN GLUTEN",
                precio: 4.0,
                categoria_impresion: "barra",
              },
            ],
            cafes: [
              {
                id: 50,
                nombre: "CAF脡 SOLO",
                precio: 1.5,
                modificaciones: ["Descafeinado", "Con hielo"],
                categoria_impresion: "barra",
              },
              {
                id: 51,
                nombre: "CORTADO",
                precio: 1.7,
                modificaciones: ["Descafeinado", "Leche soja"],
                categoria_impresion: "barra",
              },
              {
                id: 52,
                nombre: "CON LECHE",
                precio: 2.0,
                modificaciones: ["Descafeinado", "Leche soja", "Leche avena"],
                categoria_impresion: "barra",
              },
            ],
          },
        };
      }

      // INICIO
      document.addEventListener("DOMContentLoaded", () => {
        console.log(`馃崝 ${CONFIG.EMPRESA} TPV v${CONFIG.VERSION}`);
        cargarEstado();
actualizarListaUsuarios();

        // Asegurar que no quede ning煤n modal abierto que bloquee la UI
        try {
          document.body.classList.remove('modal-open');
          const modalEl = document.getElementById('modal');
          if (modalEl) {
            modalEl.classList.remove('show');
            modalEl.style.display = 'none';
          }
        } catch (e) {
          console.warn('No fue posible limpiar modales al inicio:', e);
        }

        // Carga diferida de la marca de agua
        setTimeout(() => {
          const loginScreen = DOM_CACHE.get("loginScreen");
          if (loginScreen && !loginScreen.classList.contains("hidden")) {
            loginScreen.classList.add("watermark-loaded");
          }
        }, 500);

        const usuarioGuardado = sessionStorage.getItem("usuario");
        if (usuarioGuardado) {
          try {
            estado.usuarioActual = JSON.parse(usuarioGuardado);
            estado.sesionActiva = true;
            const ls = DOM_CACHE.get("loginScreen"); if (ls) ls.classList.add("hidden");
            const ms = DOM_CACHE.get("mainScreen"); if (ms) ms.classList.add("active");
            configurarInterfazUsuario();
            inicializarSistema();
          } catch (e) {
            sessionStorage.clear();
            location.reload();
          }
        } else {
          poblarSelectorUsuarios();
        }
      });

      // Manejar el cierre de la aplicaci贸n para finalizar sesi贸n de analytics
      window.addEventListener('beforeunload', () => {
        if (analytics) {
          analytics.finalizarSesion();
        }
      });

      function poblarSelectorUsuarios() {
        // Re-consultar el select por si el cache fall贸
        let select = DOM_CACHE.get("loginUser");
        if (!select) {
          select = document.getElementById("loginUser");
          if (select) DOM_CACHE.loginUser = select;
        }
        if (!select) {
          console.error('poblarSelectorUsuarios: no se encontr贸 #loginUser');
          return;
        }

        select.innerHTML = '<option value="">-- Seleccionar Usuario --</option>';
        let count = 0;
        for (const username in estado.usuarios) {
          const user = estado.usuarios[username];
          const option = document.createElement("option");
          option.value = username;
          option.textContent = `馃懁 ${user.nombre} (${user.rol})`;
          select.appendChild(option);
          count++;
        }

        // Forzar interactividad por si alg煤n overlay/estilo lo bloquea
        try {
          select.style.pointerEvents = 'auto';
          select.removeAttribute('disabled');
          select.tabIndex = 0;
        } catch (e) {
          console.warn('No fue posible forzar pointer-events en loginUser', e);
        }

        console.log(`poblarSelectorUsuarios: cargados ${count} usuarios`);
      }

      function intentarLogin() {
        const loginEl = DOM_CACHE.get("loginUser") || document.getElementById('loginUser');
        const username = loginEl ? loginEl.value : null;
        const password = DOM_CACHE.get("loginPassword")
          ? DOM_CACHE.get("loginPassword").value
          : (document.getElementById('loginPassword') || { value: '' }).value;

        console.log('intentarLogin: username=', username, 'password-length=', (password || '').length);
        const user = estado.usuarios[username];

        const setError = (msg) => {
          const errorDiv = DOM_CACHE.get("loginError");
          errorDiv.textContent = msg;
          errorDiv.classList.add("show");
          setTimeout(() => errorDiv.classList.remove("show"), 3000);
        };

        if (!username) return setError("Selecciona un usuario");
        if (!password) return setError("Introduce la contrase帽a");

        if (user && user.password === password) {
          document.getElementById("loginScreen").classList.add("hidden");
          document.getElementById("mainScreen").classList.add("active");
          estado.usuarioActual = { ...user, username };
          estado.sesionActiva = true;
          sessionStorage.setItem(
            "usuario",
            JSON.stringify(estado.usuarioActual)
          );

          DOM_CACHE.get("loginScreen").classList.add("hidden");
          DOM_CACHE.get("mainScreen").classList.add("active");

          configurarInterfazUsuario();
          inicializarSistema();
          mostrarToast(`Bienvenido ${estado.usuarioActual.nombre}`, "success");
        } else {
          setError("Contrase帽a incorrecta");
          DOM_CACHE.get("loginPassword").value = "";
        }
      }

      function cerrarSesion() {
        if (confirm("驴Cerrar sesi贸n?")) {
          sessionStorage.clear();
          location.reload();
        }
      }

      function configurarInterfazUsuario() {
        // Acceso seguro a elementos DOM (sin depender solo del cache)
        const userDisplay = DOM_CACHE.get("userDisplay") || document.getElementById("userDisplay");
        const userRole = DOM_CACHE.get("userRole") || document.getElementById("userRole");
        const adminPanel = DOM_CACHE.get("adminPanel") || document.getElementById("adminPanel");

        const limpiarPanelAdmin = () => {
          if (adminPanel) {
            adminPanel.classList.remove('show');
            adminPanel.innerHTML = '';
            adminPanel.style.display = 'none';
          }
        };

        // Si no hay usuario actual, limpiar y salir
        if (!estado || !estado.usuarioActual) {
          if (userDisplay) userDisplay.textContent = '';
          if (userRole) userRole.textContent = '';
          limpiarPanelAdmin();
          return;
        }

        // Mostrar usuario y rol con seguridad
        const nombre = estado?.usuarioActual?.nombre || '';
        if (userDisplay) userDisplay.textContent = nombre;
        if (userRole) {
          const rol = (estado.usuarioActual.rol || '').toString();
          userRole.textContent = rol.toUpperCase();
          userRole.className = `user-badge ${rol.toLowerCase()}`;
        }

        const rolLower = (estado.usuarioActual.rol || '').toLowerCase();
        const isAdmin = rolLower === 'admin' || rolLower === 'administrador';

        if (isAdmin) {
          if (adminPanel) {
            adminPanel.style.display = 'block';
            adminPanel.classList.add('show');
            adminPanel.innerHTML = `
          <div class="admin-title">
            <span>鈿欙笍</span><span>Panel Administraci贸n</span>
          </div>
          <div class="admin-grid">
            <button class="admin-btn" onclick="mostrarPanelGestion()">
              <span class="icon">馃梻锔?/span>
              <span>Gestionar</span>
            </button>
            <button class="admin-btn" onclick="mostrarResumenSimple()">
              <span class="icon">馃搳</span>
              <span>Resumen</span>
            </button>
          </div>
        `;
          }

          // Ocultar elementos no deseados en modo admin
          const statsBar = document.querySelector('.stats-bar');
          const zonas = document.querySelector('.zones');
          const fab = document.querySelector('.fab');
          const fabResumen = document.querySelector('.fab-resumen');
          if (statsBar) statsBar.style.display = 'none';
          if (zonas) zonas.style.display = 'none';
          if (fab) fab.style.display = 'none';
          if (fabResumen) fabResumen.style.display = 'flex';
        } else {
          // No admin: ocultar panel admin y mostrar UI normal
          limpiarPanelAdmin();
          const statsBar = document.querySelector('.stats-bar');
          const zonas = document.querySelector('.zones');
          const fab = document.querySelector('.fab');
          const fabResumen = document.querySelector('.fab-resumen');
          if (statsBar) {
            // Ocultar la barra de estad铆sticas para camareros
            statsBar.style.display = (rolLower === 'camarero') ? 'none' : 'flex';
          }
          if (zonas) zonas.style.display = 'flex';
          if (fab) fab.style.display = 'block';
          if (fabResumen) fabResumen.style.display = 'none';
        }
      }

      // Funciones auxiliares para evitar errores de objetos no definidos
      function llamarSistemaReportes(metodo, ...args) {
        console.log(`馃攳 Intentando llamar sistemaReportes.${metodo}()`);
        try {
          if (typeof sistemaReportes !== 'undefined' && sistemaReportes[metodo]) {
            console.log(`鉁?sistemaReportes.${metodo}() existe, ejecutando...`);
            return sistemaReportes[metodo](...args);
          } else {
            console.warn(`鈿狅笍 sistemaReportes.${metodo}() no est谩 disponible a煤n`);
            mostrarToast(`Sistema de reportes no disponible. Recargue la p谩gina.`, 'warning');
          }
        } catch (error) {
          console.error(`鉂?Error llamando sistemaReportes.${metodo}():`, error);
          mostrarToast(`Error en sistema de reportes: ${error.message}`, 'error');
        }
      }

      function llamarSistemaLogs(metodo, ...args) {
        console.log(`馃攳 Intentando llamar sistemaLogs.${metodo}()`);
        try {
          if (typeof sistemaLogs !== 'undefined' && sistemaLogs[metodo]) {
            console.log(`鉁?sistemaLogs.${metodo}() existe, ejecutando...`);
            return sistemaLogs[metodo](...args);
          } else {
            console.warn(`鈿狅笍 sistemaLogs.${metodo}() no est谩 disponible a煤n`);
            mostrarToast(`Sistema de logs no disponible. Recargue la p谩gina.`, 'warning');
          }
        } catch (error) {
          console.error(`鉂?Error llamando sistemaLogs.${metodo}():`, error);
          mostrarToast(`Error en sistema de logs: ${error.message}`, 'error');
        }
      }

      function llamarSistemaRecuperacion(metodo, ...args) {
        console.log(`馃攳 Intentando llamar sistemaRecuperacion.${metodo}()`);
        try {
          if (typeof sistemaRecuperacion !== 'undefined' && sistemaRecuperacion[metodo]) {
            console.log(`鉁?sistemaRecuperacion.${metodo}() existe, ejecutando...`);
            return sistemaRecuperacion[metodo](...args);
          } else {
            console.warn(`鈿狅笍 sistemaRecuperacion.${metodo}() no est谩 disponible a煤n`);
            mostrarToast(`Sistema de recuperaci贸n no disponible. Recargue la p谩gina.`, 'warning');
          }
        } catch (error) {
          console.error(`鉂?Error llamando sistemaRecuperacion.${metodo}():`, error);
          mostrarToast(`Error en sistema de recuperaci贸n: ${error.message}`, 'error');
        }
      }

      // Funci贸n de verificaci贸n para debug
      function verificarSistemasDisponibles() {
        console.log('馃攳 Verificando disponibilidad de sistemas...');
        const sistemas = {
          analytics: typeof analytics !== 'undefined',
          sistemaLogs: typeof sistemaLogs !== 'undefined',
          sistemaReportes: typeof sistemaReportes !== 'undefined',
          sistemaRecuperacion: typeof sistemaRecuperacion !== 'undefined'
        };
        console.table(sistemas);
        return sistemas;
      }

      function inicializarSistema() {
        if (estado.usuarioActual.rol !== "admin") {
          inicializarMesas();
          actualizarEstadisticas();
          // Refresco peri贸dico como en V04
          setInterval(() => {
            actualizarEstadisticas();
            estado.mesas.forEach((m) => {
              if (!m.elemento)
                m.elemento = document.getElementById(`mesa-${m.numero}`);
              actualizarVisualMesa(m.numero);
            });
          }, 5000);
        }
        setInterval(guardarEstado, 30000);
        
        // Generar datos de prueba si no hay pedidos
        if (window.MODO_DEMO && estado.pedidos.length === 0) { generarDatosPrueba(); }
      }

      function generarDatosPrueba() {
        const camareros = ['Ana Garc铆a', 'Carlos L贸pez', 'Mar铆a Ruiz', 'David Mart铆n', 'Laura S谩nchez'];
        const clientes = ['Juan P茅rez', 'Ana Torres', 'Pedro Gonz谩lez', 'Carmen D铆az', 'Luis Fern谩ndez', 
                         'Sofia Moreno', 'Miguel 脕ngel', 'Isabel Castro', 'Alejandro Vega', 'Patricia Luna'];
        
        const productos = [
          { nombre: 'Burger Cl谩sica', precio: 8.50, categoria: 'burgers' },
          { nombre: 'Combo Elvis', precio: 18.50, categoria: 'combos' },
          { nombre: 'Patatas Fritas', precio: 4.00, categoria: 'snacks' },
          { nombre: 'Coca Cola', precio: 2.50, categoria: 'bebidas' },
          { nombre: 'Cerveza Estrella', precio: 3.00, categoria: 'cervezas' },
          { nombre: 'Caf茅 Solo', precio: 1.50, categoria: 'cafes' },
          { nombre: 'Brownie', precio: 5.00, categoria: 'postres' }
        ];

        const hoy = new Date();
        const ayer = new Date();
        ayer.setDate(hoy.getDate() - 1);

        // 30 pedidos para hoy
        for (let i = 0; i < 30; i++) {
          const fechaPedido = new Date(hoy);
          fechaPedido.setHours(9 + Math.floor(Math.random() * 12), Math.floor(Math.random() * 60));
          
          const numItems = Math.floor(Math.random() * 4) + 1; // 1-4 productos
          const items = new Map();
          let total = 0;
          
          for (let j = 0; j < numItems; j++) {
            const producto = productos[Math.floor(Math.random() * productos.length)];
            const cantidad = Math.floor(Math.random() * 2) + 1; // 1-2 cantidad
            const key = `${producto.categoria}_${j}_${Date.now() + j}`;
            
            items.set(key, {
              ...producto,
              cantidad: cantidad,
              categoria: producto.categoria,
              modificaciones: []
            });
            
            total += producto.precio * cantidad;
          }

          const pedido = {
            id: `pedido_${Date.now()}_${i}`,
            tipo: Math.random() > 0.3 ? 'MESA' : 'PARALLEVAR',
            mesa: Math.random() > 0.3 ? Math.floor(Math.random() * 10) + 1 : undefined,
            nombreCliente: Math.random() > 0.3 ? undefined : clientes[Math.floor(Math.random() * clientes.length)],
            camarero: camareros[Math.floor(Math.random() * camareros.length)],
            items: items,
            total: Math.round(total * 100) / 100,
            fecha: fechaPedido,
            fechaHora: fechaPedido.toISOString(),
            pagado: true,
            entregado: true,
            horaPago: fechaPedido,
            horaEntrega: new Date(fechaPedido.getTime() + Math.random() * 1800000) // +0-30 min
          };

          estado.pedidos.push(pedido);
        }

        // 15 pedidos para ayer
        for (let i = 0; i < 15; i++) {
          const fechaPedido = new Date(ayer);
          fechaPedido.setHours(10 + Math.floor(Math.random() * 11), Math.floor(Math.random() * 60));
          
          const numItems = Math.floor(Math.random() * 3) + 1; // 1-3 productos
          const items = new Map();
          let total = 0;
          
          for (let j = 0; j < numItems; j++) {
            const producto = productos[Math.floor(Math.random() * productos.length)];
            const cantidad = Math.floor(Math.random() * 2) + 1;
            const key = `${producto.categoria}_${j}_${Date.now() + i + j + 1000}`;
            
            items.set(key, {
              ...producto,
              cantidad: cantidad,
              categoria: producto.categoria,
              modificaciones: []
            });
            
            total += producto.precio * cantidad;
          }

          const pedido = {
            id: `pedido_ayer_${Date.now()}_${i}`,
            tipo: Math.random() > 0.4 ? 'MESA' : 'PARALLEVAR',
            mesa: Math.random() > 0.4 ? Math.floor(Math.random() * 10) + 1 : undefined,
            nombreCliente: Math.random() > 0.4 ? undefined : clientes[Math.floor(Math.random() * clientes.length)],
            camarero: camareros[Math.floor(Math.random() * camareros.length)],
            items: items,
            total: Math.round(total * 100) / 100,
            fecha: fechaPedido,
            fechaHora: fechaPedido.toISOString(),
            pagado: true,
            entregado: true,
            horaPago: fechaPedido,
            horaEntrega: new Date(fechaPedido.getTime() + Math.random() * 1800000)
          };

          estado.pedidos.push(pedido);
        }

        console.log(`鉁?Generados ${estado.pedidos.length} pedidos de prueba`);
        guardarEstado();
      }

      function inicializarMesas() {
        const zonasContainer = document.getElementById("zonas");
        if (!zonasContainer || zonasContainer.innerHTML !== "") return;

        const zonas = [
          { id: "comedor", nombre: "馃嵔锔?Comedor", total: 7, prefijo: "" },
          {
            id: "comedorBar",
            nombre: "馃嵑 Comedor Bar",
            total: 4,
            prefijo: "B",
          },
          { id: "terraza", nombre: "鈽€锔?Terraza", total: 3, prefijo: "T" },
        ];

        zonas.forEach((zona) => {
          const zonaDiv = document.createElement("div");
          zonaDiv.className = "zone";
          zonaDiv.innerHTML = `<h2>${zona.nombre} (${zona.total} mesas)</h2><div class="tables" id="${zona.id}"></div>`;
          zonasContainer.appendChild(zonaDiv);

          for (let i = 1; i <= zona.total; i++) {
            crearMesa(
              `${zona.prefijo}${i}`,
              zona.id,
              zona.nombre.split("(")[0].trim()
            );
          }
        });

        // Reasignar referencia del nodo DOM y repintar
        estado.mesas.forEach((m) => {
          m.elemento = document.getElementById(`mesa-${m.numero}`);
        });
        estado.mesas.forEach((m) => actualizarVisualMesa(m.numero));
      }

      function crearMesa(numero, zonaId, zonaNombre) {
        const mesaDiv = document.createElement("div");
        mesaDiv.className = "table libre";
        mesaDiv.id = `mesa-${numero}`;
        mesaDiv.dataset.mesa = numero;
        mesaDiv.innerHTML = `
          <div class="time-badge" style="display:none"></div>
          <div class="numero-mesa"></div>
          <div class="precio-mesa"></div>
        `;
        mesaDiv.onclick = () => abrirModal(numero, zonaNombre);
        document.getElementById(zonaId).appendChild(mesaDiv);

        if (!estado.mesas.has(numero)) {
          estado.mesas.set(numero, {
            numero,
            zona: zonaNombre,
            estado: "libre",
            pedido: null,
            horaOcupacion: null,
          });
        }
        estado.mesas.get(numero).elemento = mesaDiv;
        actualizarVisualMesa(numero);
      }

      // GESTI脫N DE PEDIDOS
      function abrirModal(numeroMesa, zona) {
        const mesa = estado.mesas.get(numeroMesa);
        
        if (mesa.estado === "libre") {
          estado.currentOrder = {
            tipo: "MESA",
            mesa: numeroMesa,
            zona: zona,
            items: new Map(),
            total: 0,
            fecha: new Date(),
            camarero: estado.usuarioActual ? estado.usuarioActual.nombre : "Usuario",
          };
          
          const contenido = generarFormularioPedido();
          if (mostrarModalEstandar(`Mesa ${numeroMesa}`, contenido)) {
            mostrarCategoria("combos");
            setTimeout(() => {
              const searchInput = document.querySelector(".search-bar input");
              if (searchInput) {
                searchInput.focus();
                searchInput.click();
                searchInput.setAttribute("autofocus", "true");
                searchInput.select();
              }
            }, 100);
          }
        } else if (mesa.estado === "ocupada") {
          estado.currentOrder = mesa.pedido;
          const contenido = generarVistaOcupada(mesa);
          mostrarModalEstandar(`Mesa ${numeroMesa} - ${mesa.pedido.total.toFixed(2)}鈧琡, contenido);
        } else if (mesa.estado === "pagado") {
          const contenido = `
            <div style="text-align:center; padding: 40px 20px;">
              <h3 style="color: var(--c-warn); margin-bottom:20px">鉁?Mesa Cobrada - Pendiente de Liberar</h3>
              <div style="background: var(--c-accent-light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="font-size: 1.2em; font-weight: bold; color: var(--c-dark); margin-bottom: 10px;">
                  Total cobrado: ${mesa.pedido.total.toFixed(2)}鈧?                </div>
                ${
                  mesa.pedido.horaPago
                    ? `<div style="font-size: 0.9em; color: var(--c-accent);">
                        Pagado a las: ${new Date(mesa.pedido.horaPago).toLocaleTimeString()}
                      </div>`
                    : ""
                }
              </div>
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="liberarMesa('${mesa.numero}')">馃攧 Liberar Mesa</button>
              </div>
            </div>
          `;
          mostrarModalEstandar(`Mesa ${numeroMesa} - Pagada`, contenido);
        }

        // Actualizar visual de la mesa
        actualizarVisualMesa(numeroMesa);
      }

      function generarFormularioPedido() {
        const categoriasOrdenadas = [
          "combos",
          "burgers",
          "snacks",
          "postres",
          "bebidas",
          "cervezas",
          "cafes",
        ];
        return `
                <div class="search-bar">
                    <input type="search" placeholder="馃攳 Buscar producto..." autofocus>
                </div>
                <div class="category-tabs">
                    ${categoriasOrdenadas
                      .map((cat) =>
                        estado.productos[cat]
                          ? `<button class="category-tab" data-category="${cat}" onclick="mostrarCategoria('${cat}')">${cat.toUpperCase()}</button>`
                          : ""
                      )
                      .join("")}
                </div>
                <div id="productosLista" class="products"></div>
                <div class="cart">
                    <div class="cart-header">
                        <h3>Pedido</h3>
                        <div class="cart-total">Total: <span id="totalPedido">0.00鈧?/span></div>
                    </div>
                    <div id="cartItems"><p style="text-align: center; color: var(--c-accent); padding: 20px;">Carrito vac铆o</p></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="cerrarModal()">Cancelar</button>
                    
                    <button class="btn btn-success" onclick="confirmarPedido()" id="btnConfirmar" disabled>Confirmar</button>
                </div>
            `;
      }

      document.addEventListener("input", function (e) {
        if (e.target.matches(".search-bar input")) {
          filtrarProductos(e.target.value);
        }
      });

      function mostrarCategoria(categoria) {
        estado.categoriaActiva = categoria;
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.category === categoria);
        });

        const container = document.getElementById("productosLista");
        if (!container) return;

        const productos = estado.productos[categoria] || [];
        container.innerHTML = productos
          .map((producto) => {
            const productoJson = JSON.stringify(producto).replace(
              /'/g,
              "&apos;"
            );
            return `
                    <div class="product" onclick='seleccionarProducto(${productoJson}, "${categoria}")'>
                        <div class="product-name">${escapeHtml(
                          producto.nombre
                        )}</div>
                        <div class="product-price">${producto.precio.toFixed(
                          2
                        )}鈧?/div>
                        ${
                          producto.descripcion
                            ? `<div class="product-description">${escapeHtml(
                                producto.descripcion
                              )}</div>`
                            : ""
                        }
                        ${
                          producto.alergenos?.length
                            ? '<div class="product-badge">!</div>'
                            : ""
                        }
                    </div>
                `;
          })
          .join("");
      }

      function seleccionarProducto(producto, categoria) {
        if (categoria === "combos") {
          mostrarPanelCombo(producto, categoria);
        } else if (
          // Forzar panel de modificaciones en categor铆as con opciones espec铆ficas
          categoria === "cervezas" ||
          categoria === "cafes" ||
          categoria === "bebidas" ||
          (producto.modificaciones && producto.modificaciones.length > 0)
        ) {
          mostrarPanelModificaciones(producto, categoria);
        } else {
          agregarAlCarrito(producto, categoria);
        }
      }

      function mostrarPanelCombo(producto, categoria) {
        const modalBody = document.querySelector(".modal-body");

        let html = `
        <div class="combo-header" style="padding: 20px; border-bottom: 3px solid var(--c-brand); margin-bottom: 20px; text-align: center;">
            <h3 style="color: var(--c-brand); font-weight: 800; margin-bottom: 10px;">${escapeHtml(
              producto.nombre
            )}</h3>
            <div style="color: var(--c-accent); font-weight: 700; font-size: 1.3em;">
                ${Number((producto && producto.precio) ?? 0).toFixed(2)}鈧?                ${typeof producto?.ahorro === 'number' ? `<span style="font-size: 0.8em; color: var(--c-brand);">隆Ahorro: ${Number(producto.ahorro).toFixed(2)}鈧?</span>` : ''}
            </div>
            <div class="combo-progress" style="margin-top: 15px;">
                <div class="progress-dots" style="display: flex; justify-content: center; gap: 10px;">
                    <div class="progress-dot active" data-step="1" style="width: 12px; height: 12px; border-radius: 50%; background: var(--c-brand);"></div>
                    <div class="progress-dot" data-step="2" style="width: 12px; height: 12px; border-radius: 50%; background: #ddd;"></div>
                    <div class="progress-dot" data-step="3" style="width: 12px; height: 12px; border-radius: 50%; background: #ddd;"></div>
                </div>
            </div>
        </div>`;

        // PASO 1: Burger y sus modificaciones
        html += `
        <div class="combo-step step-1 active" data-step="1">
            <div class="step-header" style="background: linear-gradient(135deg, var(--c-warn), #ffeaa7); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <h4 style="color: var(--c-dark); margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: var(--c-brand); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">1</span>
                    馃崝 Tu Burger
                </h4>
                <p style="font-size: 1.1em; color: var(--c-dark); font-weight: 600; margin: 0;">${escapeHtml(
                  (producto && producto.incluye && producto.incluye.burger) ? producto.incluye.burger : 'Burger a elegir'
                )}</p>
            </div>
            
            ${producto.modificaciones?.length ? `
            <div class="burger-modifications" style="background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid var(--c-warn);">
                <h5 style="color: var(--c-dark); margin-bottom: 10px;">鉁忥笍 Personaliza tu burger:</h5>
                <div class="mod-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                    ${producto.modificaciones
                      .map((mod) => {
                        const modEscaped = mod
                          .replace(/'/g, "\\'")
                          .replace(/"/g, "&quot;");
                        return `<div class="mod-item burger-mod" onclick="toggleModificacion(this, '${modEscaped}')" style="padding: 8px 12px; background: white; border: 2px solid #e9ecef; border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; color: #2c3e50; font-weight: 600;">${escapeHtml(
                          mod
                        )}</div>`;
                      })
                      .join("")}
                </div>
            </div>` : ''}
            
            <div class="step-actions" style="text-align: center; margin-top: 20px;">
                <button class="btn-step-next" onclick="nextComboStep(2)" style="background: var(--c-brand); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1em;">
                    ${'Continuar 鈫?Bebida 馃イ'}
                </button>
            </div>
        </div>`;

        // PASO 2: Patatas
        html += `
        <div class="combo-step step-2" data-step="2" style="display: none;">
            <div class="step-header" style="background: linear-gradient(135deg, #fab1a0, #e17055); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <h4 style="color: white; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: white; color: var(--c-brand); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">2</span>
                    馃崯 Elige tus Patatas
                </h4>
            </div>
            
            <div class="patatas-selection" style="background: #fff3e0; padding: 15px; border-radius: 12px; border-left: 4px solid #fab1a0;">
                <div class="patatas-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;">
                    ${(producto && producto.incluye && Array.isArray(producto.incluye.patatas) ? producto.incluye.patatas : ['Cl谩sicas', 'Gajo (+1.00)', 'Cheddar (+1.50)'])
                      .map((patata) => {
                        const extra = patata.includes("(+")
                          ? parseFloat(patata.match(/\+(\d+\.?\d*)/)[1])
                          : 0;
                        const nombre = patata.split("(")[0].trim();
                        return `<div class="patatas-option" data-patata="${nombre.replace(
                          /"/g,
                          "&quot;"
                        )}" data-extra="${extra}" onclick="seleccionarPatatasCombo(this, ${extra})" style="padding: 15px; background: white; border: 3px solid #ddd; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #2c3e50; font-size: 1em;">${escapeHtml(
                          patata
                        )}</div>`;
                      })
                      .join("")}
                </div>
            </div>
            
            <div class="step-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn-step-back" onclick="prevComboStep(1)" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer;">
                    鈫?Volver
                </button>
                <button class="btn-step-next" onclick="nextComboStep(3)" style="background: var(--c-brand); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1em;">
                    Continuar 鈫?Bebida 馃イ
                </button>
            </div>
        </div>`;

        // PASO 3: Bebida
        html += `
        <div class="combo-step step-3" data-step="3" style="display: none;">
            <div class="step-header" style="background: linear-gradient(135deg, #74b9ff, #0984e3); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <h4 style="color: white; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: white; color: var(--c-brand); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold;">3</span>
                    馃イ Elige tu Bebida
                </h4>
            </div>
            
            <div class="bebida-selection" style="background: #e3f2fd; padding: 15px; border-radius: 12px; border-left: 4px solid #74b9ff;">
                <div class="bebida-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    ${(producto && producto.incluye && Array.isArray(producto.incluye.bebida) ? producto.incluye.bebida : ['Agua', 'Refresco', 'Cerveza (+1.00)'])
                      .map(
                        (bebida) =>
                          `<div class="bebida-option" data-bebida="${bebida.replace(
                            /"/g,
                            "&quot;"
                          )}" onclick="seleccionarBebidaCombo(this)" style="padding: 15px; background: white; border: 3px solid #ddd; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #2c3e50; font-size: 1em;">${escapeHtml(
                            bebida
                          )}</div>`
                      )
                      .join("")}
                </div>
            </div>
            
            <div class="step-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn-step-back" onclick="prevComboStep(2)" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer;">
                    鈫?Volver
                </button>
                <button class="btn-step-final" onclick="showComboSummary()" style="background: var(--c-accent); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1em;">
                    Ver Resumen 馃搵
                </button>
            </div>
        </div>`;

        // RESUMEN FINAL
        html += `
        <div class="combo-step step-summary" data-step="summary" style="display: none;">
            <div class="summary-header" style="background: linear-gradient(135deg, var(--c-accent-light), var(--c-accent)); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <h4 style="color: var(--c-dark); font-size: 1.2em; margin-bottom: 10px;">馃搵 Resumen de tu Combo</h4>
            </div>
            
            <div id="combo-summary-content" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <!-- El contenido se llenar谩 din谩micamente -->
            </div>

            ${producto.alergenos?.length ? `
            <div class="allergens-info" style="background: var(--c-brand-light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h5 style="color: var(--c-dark); margin-bottom: 10px;">鈿狅笍 Al茅rgenos:</h5>
                <div class="allergen-tags" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${producto.alergenos
                      .map(
                        (alergeno) =>
                          `<div class="allergen-tag" style="background: var(--c-brand); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">${escapeHtml(
                            alergeno
                          ).toUpperCase()}</div>`
                      )
                      .join("")}
                </div>
            </div>` : ''}
            
            <div id="comboTotal" style="text-align: center; padding: 20px; background: linear-gradient(135deg, var(--c-accent-light), #a8e6cf); border-radius: 15px; margin-bottom: 20px;">
                <div style="font-size: 1.4em; font-weight: 800; color: var(--c-dark);">
                    Total: <span id="precioTotalCombo" style="color: var(--c-brand);">${Number((producto && producto.precio) ?? 0).toFixed(2)}鈧?/span>
                </div>
            </div>
            
            <div class="final-actions" style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="prevComboStep(3)" style="flex: 1; padding: 15px; border-radius: 12px; font-weight: bold;">鈫?Editar</button>
                <button class="btn btn-danger" onclick="volverAProductos()" style="flex: 1; padding: 15px; border-radius: 12px; font-weight: bold;">Cancelar</button>
                <button class="btn btn-success" onclick='confirmarCombo(${JSON.stringify(producto).replace(/'/g, "&apos;")}, "${categoria}")' style="flex: 2; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.1em;">馃崝 A帽adir al Pedido</button>
            </div>
        </div>`;

        modalBody.innerHTML = html;

        // Inicializar el combo
        initializeCombo(producto);
      }
      function seleccionarPatatasCombo(elemento, extra) {
        document
          .querySelectorAll(".patatas-option")
          .forEach((el) => {
            el.classList.remove("selected");
            el.style.borderColor = "#ddd";
            el.style.background = "white";
          });
        
        elemento.classList.add("selected");
        elemento.style.borderColor = "var(--c-brand)";
        elemento.style.background = "var(--c-accent-light)";
        
        // Guardar selecci贸n
        window.comboSelections.patatas = elemento.dataset.patata;
        
        actualizarPrecioCombo();
      }

      function seleccionarBebidaCombo(elemento) {
        document
          .querySelectorAll(".bebida-option")
          .forEach((el) => {
            el.classList.remove("selected");
            el.style.borderColor = "#ddd";
            el.style.background = "white";
          });
        
        elemento.classList.add("selected");
        elemento.style.borderColor = "var(--c-brand)";
        elemento.style.background = "var(--c-accent-light)";
        
        // Guardar selecci贸n
        window.comboSelections.bebida = elemento.dataset.bebida;
      }

      function toggleModificacion(elemento, modificacion) {
        if (elemento.classList.contains("selected")) {
          elemento.classList.remove("selected");
          elemento.style.borderColor = "#e9ecef";
          elemento.style.background = "white";
          window.comboSelections.modificaciones.delete(modificacion);
        } else {
          elemento.classList.add("selected");
          elemento.style.borderColor = "var(--c-brand)";
          elemento.style.background = "var(--c-accent-light)";
          window.comboSelections.modificaciones.add(modificacion);
        }
      }

      function actualizarPrecioCombo() {
        const patatasSeleccionada = document.querySelector(
          ".patatas-option.selected"
        );
        let extra = 0;

        if (patatasSeleccionada) {
          extra = parseFloat(patatasSeleccionada.dataset.extra) || 0;
        }

        const precioFinal = window.comboPrecioOriginal + extra;
        document.getElementById("precioTotalCombo").textContent =
          precioFinal.toFixed(2) + "鈧?;
      }

      // Nuevas funciones para navegaci贸n paso a paso
      function initializeCombo(producto) {
        // Guardar precio original del combo
        window.comboPrecioOriginal = producto.precio;
        window.comboProducto = producto;
        
        // Seleccionar primeras opciones por defecto (pero no visualmente hasta llegar al paso)
        window.comboSelections = {
          patatas: null,
          bebida: null,
          modificaciones: new Set()
        };
        
        // Asegurar que solo el primer paso est茅 visible
        setTimeout(() => {
          document.querySelectorAll('.combo-step').forEach((el, index) => {
            if (index === 0) {
              el.style.display = 'block';
              el.style.opacity = '1';
              el.style.transform = 'translateX(0)';
            } else {
              el.style.display = 'none';
              el.style.opacity = '0';
            }
          });
        }, 50);
      }

      function nextComboStep(step) {
        // Siempre que entremos en el paso de patatas (step 2) seleccionamos autom谩ticamente
        // la primera opci贸n de patatas (si existe) y saltamos directamente al paso de bebida (step 3).
        if (step === 2) {
          const patataOpts = document.querySelectorAll('.patatas-option');
          if (patataOpts && patataOpts.length > 0) {
            const firstPatata = patataOpts[0];
            if (firstPatata && !window.comboSelections.patatas) {
              const extra = parseFloat(firstPatata.dataset.extra) || 0;
              seleccionarPatatasCombo(firstPatata, extra);
            }
          }
          // Continuar al paso 3 directamente
          nextComboStep(3);
          return;
        }
        // Ocultar todos los pasos con transici贸n
        document.querySelectorAll('.combo-step').forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            el.style.display = 'none';
          }, 200);
        });
        
        // Mostrar nuevo paso con animaci贸n
        setTimeout(() => {
          const newStep = document.querySelector(`.step-${step}`);
          newStep.style.display = 'block';
          newStep.style.opacity = '0';
          newStep.style.transform = 'translateX(100%)';
          
          requestAnimationFrame(() => {
            newStep.style.transition = 'all 0.3s ease-out';
            newStep.style.opacity = '1';
            newStep.style.transform = 'translateX(0)';
          });
        }, 250);
        
        // Actualizar indicadores de progreso
        updateProgressDots(step);
        
        // Auto-seleccionar primera opci贸n si no hay selecci贸n
        if (step === 2 && !window.comboSelections.patatas) {
          setTimeout(() => {
            const firstPatata = document.querySelector('.patatas-option');
            if (firstPatata) {
              seleccionarPatatasCombo(firstPatata, parseFloat(firstPatata.dataset.extra) || 0);
            }
          }, 400);
        }
        
        if (step === 3 && !window.comboSelections.bebida) {
          setTimeout(() => {
            const firstBebida = document.querySelector('.bebida-option');
            if (firstBebida) {
              seleccionarBebidaCombo(firstBebida);
            }
          }, 400);
        }
      }

      function prevComboStep(step) {
        // Ocultar todos los pasos con transici贸n
        document.querySelectorAll('.combo-step').forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateX(100%)';
          setTimeout(() => {
            el.style.display = 'none';
          }, 200);
        });
        
        // Mostrar paso anterior con animaci贸n
        setTimeout(() => {
          const prevStep = document.querySelector(`.step-${step}`);
          prevStep.style.display = 'block';
          prevStep.style.opacity = '0';
          prevStep.style.transform = 'translateX(-100%)';
          
          requestAnimationFrame(() => {
            prevStep.style.transition = 'all 0.3s ease-out';
            prevStep.style.opacity = '1';
            prevStep.style.transform = 'translateX(0)';
          });
        }, 250);
        
        // Actualizar indicadores de progreso
        updateProgressDots(step);
      }

      function updateProgressDots(activeStep) {
        document.querySelectorAll('.progress-dot').forEach((dot, index) => {
          if (index < activeStep) {
            dot.style.background = 'var(--c-brand)';
          } else {
            dot.style.background = '#ddd';
          }
        });
      }

      function showComboSummary() {
        // Ocultar todos los pasos con transici贸n
        document.querySelectorAll('.combo-step').forEach(el => {
          el.style.opacity = '0';
          el.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            el.style.display = 'none';
          }, 200);
        });
        
        // Mostrar resumen con animaci贸n
        setTimeout(() => {
          const summaryStep = document.querySelector('.step-summary');
          summaryStep.style.display = 'block';
          summaryStep.style.opacity = '0';
          summaryStep.style.transform = 'translateY(50px)';
          
          requestAnimationFrame(() => {
            summaryStep.style.transition = 'all 0.4s ease-out';
            summaryStep.style.opacity = '1';
            summaryStep.style.transform = 'translateY(0)';
          });
          
          // Generar contenido del resumen despu茅s de la animaci贸n
          setTimeout(() => {
            generateComboSummary();
          }, 100);
        }, 250);
      }

      function generateComboSummary() {
        const summaryContent = document.getElementById('combo-summary-content');
        const producto = window.comboProducto;
        
        let html = `
        <div class="summary-item" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--c-warn);">
            <span style="font-size: 1.5em;">馃崝</span>
            <div>
                <div style="font-weight: bold; color: var(--c-dark);">${escapeHtml(producto.incluye.burger)}</div>
                ${window.comboSelections.modificaciones.size > 0 ? 
                  `<div style="font-size: 0.9em; color: var(--c-accent); margin-top: 5px;">
                    Modificaciones: ${Array.from(window.comboSelections.modificaciones).join(', ')}
                  </div>` : ''}
            </div>
        </div>`;
        
        if (window.comboSelections.patatas) {
          html += `
          <div class="summary-item" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #fab1a0;">
              <span style="font-size: 1.5em;">馃崯</span>
              <div>
                  <div style="font-weight: bold; color: var(--c-dark);">${escapeHtml(window.comboSelections.patatas)}</div>
              </div>
          </div>`;
        }
        
        if (window.comboSelections.bebida) {
          html += `
          <div class="summary-item" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #74b9ff;">
              <span style="font-size: 1.5em;">馃イ</span>
              <div>
                  <div style="font-weight: bold; color: var(--c-dark);">${escapeHtml(window.comboSelections.bebida)}</div>
              </div>
          </div>`;
        }
        
        summaryContent.innerHTML = html;
        
        // Actualizar precio final
        actualizarPrecioCombo();
      }

      function confirmarCombo(producto, categoria) {
        const patatasSeleccionada = document.querySelector(
          ".patatas-option.selected"
        );
        const bebidaSeleccionada = document.querySelector(
          ".bebida-option.selected"
        );

        if (!patatasSeleccionada || !bebidaSeleccionada) {
          mostrarToast("Selecciona patatas y bebida", "error");
          return;
        }

        const extra = parseFloat(patatasSeleccionada.dataset.extra) || 0;
        const precioFinal = producto.precio + extra;

        // Crear el item del combo con las selecciones
        const comboItem = {
          ...producto,
          precio: precioFinal,
          categoria,
          categoria_impresion: "combo",
          cantidad: 1,
          modificaciones: Array.from(estado.modificacionesActuales),
          selecciones: {
            patatas: patatasSeleccionada.dataset.patata,
            bebida: bebidaSeleccionada.dataset.bebida,
          },
          // Desglose para impresi贸n
          desglose_impresion: [
            {
              nombre: `${producto.incluye.burger} (del ${producto.nombre})`,
              modificaciones: Array.from(estado.modificacionesActuales),
              categoria_impresion: "cocina",
              cantidad: 1,
            },
            {
              nombre: patatasSeleccionada.dataset.patata,
              categoria_impresion: "cocina",
              cantidad: 1,
            },
            {
              nombre: bebidaSeleccionada.dataset.bebida,
              categoria_impresion: "barra",
              cantidad: 1,
            },
          ],
        };

        const key = `${categoria}_${producto.id}_${Date.now()}`;
        estado.currentOrder.items.set(key, comboItem);

        estado.modificacionesActuales.clear();
        actualizarVistaCarrito();
        mostrarToast(`${producto.nombre} a帽adido`, "success", 1500);
        volverAProductos();
      }

      function mostrarPanelModificaciones(producto, categoria) {
        const modalBody = document.querySelector(".modal-body");

        let html = `
                <div style="padding: 20px; border-bottom: 3px solid var(--c-accent-light); margin-bottom: 20px;">
                    <h3 style="color: var(--c-brand); font-weight: 800;">${escapeHtml(
                      producto.nombre
                    )}</h3>
                    <div style="color: var(--c-accent); margin-top: 5px; font-weight: 700; font-size: 1.2em;">${producto.precio.toFixed(
                      2
                    )}鈧?/div>
                </div>`;

        if (producto.ingredientes) {
          html += `<div class="modifications-panel" style="background: var(--c-warn);"><h4>馃搵 Ingredientes</h4><p style="font-size:0.9em; color: var(--c-accent);">${escapeHtml(
            producto.ingredientes
          )}</p></div>`;
        }

        // Opciones espec铆ficas por categor铆a
        // Caf茅s: Con leche fr铆a, Con hielo, En vaso corto de caf茅 (opcionales y combinables)
        if (categoria === "cafes") {
          const modsCafe = [
            "Con leche fr铆a",
            "Con hielo",
            "En vaso corto de caf茅",
          ];
          html += `
                    <div class="modifications-panel">
                        <h4>鈽?Opciones de Caf茅</h4>
                        <div class="mod-grid">
                            ${modsCafe
                              .map((mod) => {
                                const modEscaped = mod
                                  .replace(/'/g, "\\'")
                                  .replace(/"/g, "&quot;");
                                return `<div class="mod-item" onclick="toggleModificacion(this, '${modEscaped}')">${escapeHtml(
                                  mod
                                )}</div>`;
                              })
                              .join("")}
                        </div>
                    </div>`;
        }

        // Cervezas: Servicio Vaso/Botella (exclusivo). Por defecto Vaso. Persistir "botella" cuando se elija.
        if (categoria === "cervezas") {
          // Asegurar estado por defecto (sin 'botella')
          try {
            estado.modificacionesActuales.delete("botella");
          } catch (e) {}
          html += `
                    <div class="modifications-panel">
                        <h4>馃嵑 Servicio</h4>
                        <div class="mod-grid">
                            <div class="mod-item servicio-option selected" data-servicio="vaso" onclick="seleccionarServicioCerveza(this, 'vaso')">Vaso</div>
                            <div class="mod-item servicio-option" data-servicio="botella" onclick="seleccionarServicioCerveza(this, 'botella')">Botella</div>
                        </div>
                        <div style="color: var(--c-accent); font-size: 0.85em; margin-top: 6px;">Por defecto: Vaso</div>
                    </div>`;
        }

        // Bebidas (no cerveza): Sin hielo, Mucho hielo, Sin lim贸n, Natural (opcionales, con conflictos)
        if (categoria === "bebidas") {
          const modsBebida = [
            "Sin hielo",
            "Mucho hielo",
            "Sin lim贸n",
            "Natural",
          ];
          html += `
                    <div class="modifications-panel">
                        <h4>馃イ Preferencias</h4>
                        <div class="mod-grid">
                            ${modsBebida
                              .map((mod) => {
                                const modEscaped = mod
                                  .replace(/'/g, "\\'")
                                  .replace(/"/g, "&quot;");
                                return `<div class="mod-item bebida-mod" data-mod="${escapeHtml(
                                  mod
                                )}" onclick="toggleBebidaMod(this, '${modEscaped}')">${escapeHtml(
                                  mod
                                )}</div>`;
                              })
                              .join("")}
                        </div>
                        <div style="color: var(--c-accent); font-size: 0.85em; margin-top: 6px;">Nota: "Natural" es exclusivo de opciones de hielo.</div>
                    </div>`;
        }

        if (producto.modificaciones?.length) {
          html += `
                    <div class="modifications-panel">
                        <h4>鉁忥笍 Modificaciones</h4>
                        <div class="mod-grid">
                            ${producto.modificaciones
                              .map((mod) => {
                                const modEscaped = mod
                                  .replace(/'/g, "\\'")
                                  .replace(/"/g, "&quot;");
                                return `<div class="mod-item" onclick="toggleModificacion(this, '${modEscaped}')">${escapeHtml(
                                  mod
                                )}</div>`;
                              })
                              .join("")}
                        </div>
                    </div>`;
        }

        if (producto.alergenos?.length) {
          html += `
                    <div class="modifications-panel" style="background: var(--c-brand-light);">
                        <h4>鈿狅笍 Al茅rgenos</h4>
                        <div class="allergen-tags">
                            ${producto.alergenos
                              .map(
                                (alergeno) =>
                                  `<div class="allergen-tag">${escapeHtml(
                                    alergeno
                                  ).toUpperCase()}</div>`
                              )
                              .join("")}
                        </div>
                    </div>`;
        }

        const productoJson = JSON.stringify(producto).replace(/'/g, "&apos;");
        html += `
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="volverAProductos()">Volver</button>
                    <button class="btn btn-success" onclick='confirmarProductoConModificaciones(${productoJson}, "${categoria}")'>A帽adir</button>
                </div>`;

        modalBody.innerHTML = html;
      }

      function toggleModificacion(elemento, mod) {
        elemento.classList.toggle("selected");
        if (elemento.classList.contains("selected")) {
          estado.modificacionesActuales.add(mod);
        } else {
          estado.modificacionesActuales.delete(mod);
        }
      }

      // Exclusividad Vaso/Botella para cervezas
      function seleccionarServicioCerveza(elemento, tipo) {
        // Limpiar selecci贸n visual
        document
          .querySelectorAll(".servicio-option")
          .forEach((el) => el.classList.remove("selected"));
        elemento.classList.add("selected");

        // Actualizar estado: s贸lo persistimos "botella" cuando se elija
        if (tipo === "botella") {
          estado.modificacionesActuales.add("botella");
        } else {
          estado.modificacionesActuales.delete("botella");
        }
      }

      // Reglas de conflicto para bebidas no cerveza
      function toggleBebidaMod(elemento, mod) {
        const activar = !elemento.classList.contains("selected");

        if (activar) {
          elemento.classList.add("selected");
          estado.modificacionesActuales.add(mod);

          if (mod === "Natural") {
            // Natural excluye opciones de hielo
            document
              .querySelectorAll(
                '.bebida-mod[data-mod="Sin hielo"], .bebida-mod[data-mod="Mucho hielo"]'
              )
              .forEach((el) => el.classList.remove("selected"));
            estado.modificacionesActuales.delete("Sin hielo");
            estado.modificacionesActuales.delete("Mucho hielo");
          } else if (mod === "Sin hielo") {
            // Excluir Mucho hielo y Natural
            const otros = ["Mucho hielo", "Natural"];
            otros.forEach((m) => {
              const el = document.querySelector(`.bebida-mod[data-mod="${m}"]`);
              if (el) el.classList.remove("selected");
              estado.modificacionesActuales.delete(m);
            });
          } else if (mod === "Mucho hielo") {
            // Excluir Sin hielo y Natural
            const otros = ["Sin hielo", "Natural"];
            otros.forEach((m) => {
              const el = document.querySelector(`.bebida-mod[data-mod="${m}"]`);
              if (el) el.classList.remove("selected");
              estado.modificacionesActuales.delete(m);
            });
          }
        } else {
          elemento.classList.remove("selected");
          estado.modificacionesActuales.delete(mod);
        }
      }

      function volverAProductos() {
        const modalBody = document.querySelector(".modal-body");
        modalBody.innerHTML = generarFormularioPedido();
        mostrarCategoria(estado.categoriaActiva);
        actualizarVistaCarrito();
        setTimeout(() => {
          const searchInput = document.querySelector(".search-bar input");
          if (searchInput) {
            searchInput.focus();
            searchInput.click();
          }
        }, 100);
      }

      function confirmarProductoConModificaciones(producto, categoria) {
        agregarAlCarrito(producto, categoria);
        volverAProductos();
      }

      function agregarAlCarrito(producto, categoria) {
        const key = `${categoria}_${producto.id}_${Date.now()}`;

        estado.currentOrder.items.set(key, {
          ...producto,
          categoria,
          cantidad: 1,
          modificaciones: Array.from(estado.modificacionesActuales),
        });

        estado.modificacionesActuales.clear();
        actualizarVistaCarrito();
        mostrarToast(`${producto.nombre} a帽adido`, "success", 1500);
      }

      function actualizarVistaCarrito() {
        const cartItems = document.getElementById("cartItems");
        const totalElement = document.getElementById("totalPedido");
        const btnConfirmar = document.getElementById("btnConfirmar");

        if (!cartItems || !totalElement) return;

        let total = 0;
        if (estado.currentOrder && estado.currentOrder.items) {
          estado.currentOrder.items.forEach(
            (item) => (total += item.precio * item.cantidad)
          );
        }

        if (estado.currentOrder) {
          estado.currentOrder.total = total;
        }

        if (
          estado.currentOrder &&
          estado.currentOrder.items &&
          estado.currentOrder.items.size > 0
        ) {
          cartItems.innerHTML = Array.from(estado.currentOrder.items.entries())
            .map(([key, item]) => {
              let detalles = "";
              if (item.selecciones) {
                detalles = `馃崯 ${item.selecciones.patatas} | 馃イ ${item.selecciones.bebida}`;
                if (item.modificaciones?.length) {
                  detalles += ` | 馃摑 ${item.modificaciones
                    .map((m) => escapeHtml(m))
                    .join(", ")}`;
                }
              } else if (item.modificaciones?.length) {
                detalles = `馃摑 ${item.modificaciones
                  .map((m) => escapeHtml(m))
                  .join(", ")}`;
              }

              return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${escapeHtml(
                                  item.nombre
                                )}</div>
                                ${
                                  detalles
                                    ? `<div class="cart-item-details">${detalles}</div>`
                                    : ""
                                }
                            </div>
                            <div class="cart-item-controls">
                                <button class="quantity-btn" onclick="cambiarCantidad('${key}', -1)">-</button>
                                <span class="quantity-value">${
                                  item.cantidad
                                }</span>
                                <button class="quantity-btn" onclick="cambiarCantidad('${key}', 1)">+</button>
                                <span class="cart-item-price">${(
                                  item.precio * item.cantidad
                                ).toFixed(2)}鈧?/span>
                            </div>
                        </div>
                    `;
            })
            .join("");
        } else {
          cartItems.innerHTML =
            '<p style="text-align: center; color: var(--c-accent); padding: 20px;">Carrito vac铆o</p>';
        }

        totalElement.textContent = total.toFixed(2) + "鈧?;
        if (btnConfirmar) {
          btnConfirmar.disabled =
            !estado.currentOrder ||
            !estado.currentOrder.items ||
            estado.currentOrder.items.size === 0;
        }
      }

      function cambiarCantidad(key, delta) {
        if (!estado.currentOrder || !estado.currentOrder.items) return;
        const item = estado.currentOrder.items.get(key);
        if (!item) return;

        item.cantidad += delta;
        if (item.cantidad <= 0) {
          estado.currentOrder.items.delete(key);
        }
        actualizarVistaCarrito();
      }

      // CONFIRMAR PEDIDO CON M脷LTIPLES IMPRESORAS
      function confirmarPedido() {
        if (!estado.currentOrder || estado.currentOrder.items.size === 0) {
          return mostrarToast("Pedido vac铆o", "error");
        }

        let pedidoFinal = {
          ...estado.currentOrder,
          items: Array.from(estado.currentOrder.items.values()),
          id: Date.now(),
        };

        // Determinar si es pedido nuevo o adici锟絥
        let itemsNuevos = pedidoFinal.items;
        let esAdicion = false;

        if (pedidoFinal.tipo === "MESA") {
          const mesa = estado.mesas.get(pedidoFinal.mesa);

          if (mesa.estado === "ocupada" && mesa.pedido) {
            // Es una adici锟絥
            esAdicion = true;
            // Solo los items que no estaban antes
            const itemsAnteriores = mesa.pedido.items || [];
            itemsNuevos = pedidoFinal.items.slice(itemsAnteriores.length);

            // Combinar items anteriores con nuevos
            pedidoFinal.items = [...itemsAnteriores, ...itemsNuevos];
          }

          mesa.estado = "ocupada";
          mesa.pedido = pedidoFinal;
          mesa.horaOcupacion = mesa.horaOcupacion || new Date();

          // Actualizar visual de la mesa
          actualizarVisualMesa(mesa.numero);
        } else if (
          pedidoFinal.tipo === "PARALLEVAR" &&
          estado.currentOrder.esAdicion
        ) {
          // Es adici贸n a pedido para llevar existente
          esAdicion = true;
          const pedidoOriginal = estado.pedidos.find(
            (p) => p.id == estado.currentOrder.pedidoOriginalId
          );

          if (pedidoOriginal) {
            // Solo los items nuevos que se est锟絥 a锟絘diendo
            const itemsAnteriores = pedidoOriginal.items || [];
            itemsNuevos = pedidoFinal.items.slice(itemsAnteriores.length);

            // Actualizar el pedido original con los nuevos items
            pedidoOriginal.items = [...itemsAnteriores, ...itemsNuevos];
            pedidoOriginal.total += itemsNuevos.reduce(
              (sum, item) => sum + item.precio * item.cantidad,
              0
            );

            // No crear un nuevo pedido, solo actualizar el existente
            pedidoFinal = pedidoOriginal;
          }
        }

        // Solo a锟絘dir a la lista si no es una adici锟絥 a pedido existente
        if (!esAdicion || pedidoFinal.tipo === "MESA") {
          estado.pedidos.push(pedidoFinal);
        }

        guardarEstado();
        actualizarEstadisticas();

        // Separar items por impresora
        const itemsCocina = [];
        const itemsBarra = [];

        itemsNuevos.forEach((item) => {
          if (item.desglose_impresion) {
            // Es un combo, desglosar
            item.desglose_impresion.forEach((subitem) => {
              if (subitem.categoria_impresion === "cocina") {
                itemsCocina.push({
                  ...subitem,
                  mesa: pedidoFinal.mesa,
                  esCombo: true,
                });
              } else if (subitem.categoria_impresion === "barra") {
                itemsBarra.push({
                  ...subitem,
                  mesa: pedidoFinal.mesa,
                  esCombo: true,
                });
              }
            });
          } else {
            // Item normal
            if (item.categoria_impresion === "cocina") {
              itemsCocina.push({
                ...item,
                mesa: pedidoFinal.mesa,
              });
            } else if (item.categoria_impresion === "barra") {
              itemsBarra.push({
                ...item,
                mesa: pedidoFinal.mesa,
              });
            }
          }
        });

        // Marcar en el pedido si es una adici贸n para reflejarlo en el ticket
        pedidoFinal.esAdicion = !!esAdicion;

        // Enviar a impresoras configuradas: s贸lo l铆neas correspondientes y s贸lo de los items nuevos
        try {
          const cfgImp = estado.impresoras || {};
          if (itemsCocina.length && cfgImp.comida?.habilitada && cfgImp.comida.ip) {
            const lineasC = itemsCocina.map(formatearLineaItem);
            const txtC = construirTicket(pedidoFinal, lineasC, 'COCINA');
            enviarAImpresora(cfgImp.comida, txtC);
          }
          if (itemsBarra.length && cfgImp.bebida?.habilitada && cfgImp.bebida.ip) {
            const lineasB = itemsBarra.map(formatearLineaItem);
            const txtB = construirTicket(pedidoFinal, lineasB, 'BARRA');
            enviarAImpresora(cfgImp.bebida, txtB);
          }
        } catch (e) {
          console.warn('Impresi贸n no ejecutada:', e);
        }

        // IMPRESI脫N DESACTIVADA TEMPORALMENTE
        /*
        // Imprimir si hay items
        const config = cargarConfigImpresoras();
        if (config.mode === "auto") {
          let promesasImpresion = [];

          if (itemsCocina.length > 0 && config.cocina.activa) {
            promesasImpresion.push(
              enviarAImpresora(pedidoFinal, itemsCocina, "cocina", esAdicion)
            );
          }

          if (itemsBarra.length > 0 && config.barra.activa) {
            promesasImpresion.push(
              enviarAImpresora(pedidoFinal, itemsBarra, "barra", esAdicion)
            );
          }

          Promise.all(promesasImpresion)
            .then((resultados) => {
              const todosCorrecto = resultados.every((r) => r.success);
              const mensajeAdicional = esAdicion ? " (ADICI脫N)" : "";

              if (todosCorrecto) {
                alert(
                  `鉁?PEDIDO CONFIRMADO${mensajeAdicional}\n\n` +
                    `Pedido #${pedidoFinal.id}\n` +
                    `${
                      pedidoFinal.tipo === "MESA"
                        ? "Mesa: " + pedidoFinal.mesa
                        : "PARA LLEVAR"
                    }\n` +
                    `Total: ${pedidoFinal.total.toFixed(2)}鈧琝n\n` +
                    `鉁?Enviado a COCINA: ${itemsCocina.length} items\n` +
                    `鉁?Enviado a BARRA: ${itemsBarra.length} items`
                );
              } else {
                alert(
                  `鈿狅笍 PEDIDO CONFIRMADO${mensajeAdicional} PERO HAY ERRORES\n\n` +
                    `Pedido #${pedidoFinal.id}\n` +
                    `${
                      pedidoFinal.tipo === "MESA"
                        ? "Mesa: " + pedidoFinal.mesa
                        : "PARA LLEVAR"
                    }\n` +
                    `Total: ${pedidoFinal.total.toFixed(2)}鈧琝n\n` +
                    `ERROR: Algunas impresoras no respondieron.\n` +
                    `Por favor, avise manualmente.`
                );
              }
            })
            .catch((error) => {
              console.error('鉂?Error en Promise.all de impresoras:', error);
              const mensajeAdicional = esAdicion ? " (ADICI脫N)" : "";
              alert(
                `鈿狅笍 PEDIDO CONFIRMADO${mensajeAdicional} PERO ERROR DE IMPRESI脫N\n\n` +
                  `Pedido #${pedidoFinal.id}\n` +
                  `${
                    pedidoFinal.tipo === "MESA"
                      ? "Mesa: " + pedidoFinal.mesa
                      : "PARA LLEVAR"
                  }\n` +
                  `Total: ${pedidoFinal.total.toFixed(2)}鈧琝n\n` +
                  `ERROR: No se pudo conectar con las impresoras.\n` +
                  `El pedido se guard贸 correctamente.`
              );
            });
        } else {
          const mensajeAdicional = esAdicion ? " (ADICI脫N)" : "";
          alert(
            `鉁?PEDIDO CONFIRMADO${mensajeAdicional}\n\n` +
              `Pedido #${pedidoFinal.id}\n` +
              `${
                pedidoFinal.tipo === "MESA"
                  ? "Mesa: " + pedidoFinal.mesa
                  : "PARA LLEVAR"
              }\n` +
              `Total: ${pedidoFinal.total.toFixed(2)}鈧琡
          );
        }
        */

        // MENSAJE SIMPLE SIN IMPRESI脫N
        const mensajeAdicional = esAdicion ? " (ADICI脫N)" : "";
        alert(
          `鉁?PEDIDO CONFIRMADO${mensajeAdicional}\n\n` +
            `Pedido #${pedidoFinal.id}\n` +
            `${
              pedidoFinal.tipo === "MESA"
                ? "Mesa: " + pedidoFinal.mesa
                : "PARA LLEVAR"
            }\n` +
            `Total: ${pedidoFinal.total.toFixed(2)}鈧琡
        );

        // Forzar repintado inmediato (visual) de la mesa confirmada
        if (pedidoFinal.tipo === "MESA") {
          const m = estado.mesas.get(pedidoFinal.mesa);
          if (m) {
            m.estado = "ocupada";
            m.horaOcupacion = m.horaOcupacion || new Date();
            m.pedido = m.pedido || pedidoFinal; // solo visual
            actualizarVisualMesa(m.numero);
          }
          cerrarModal();
        } else if (pedidoFinal.tipo === "PARALLEVAR") {
          // Volver al hub de nombres para seguir creando/a帽adiendo
          estado.currentOrder = null;
          if (
            estado.modificacionesActuales &&
            estado.modificacionesActuales.clear
          ) {
            estado.modificacionesActuales.clear();
          }
          nuevoPedidoParaLlevar();
        }
      }

      function generarVistaOcupada(mesa) {
        const tiempo = calcularTiempoOcupacion(mesa.horaOcupacion);
        return `
                <div style="background: var(--c-accent-light); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: var(--c-dark);">Informaci贸n del Pedido</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div><div style="color: var(--c-accent); font-size: 0.85em;">Mesa</div><div style="font-weight: 800; font-size: 1.1em; color: var(--c-brand);">${escapeHtml(
                          mesa.numero
                        )} - ${escapeHtml(mesa.zona)}</div></div>
                        <div><div style="color: var(--c-accent); font-size: 0.85em;">Tiempo</div><div style="font-weight: 800; font-size: 1.1em; color: var(--c-brand);">${tiempo}</div></div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    ${mesa.pedido.items
                      .map(
                        (item) => `
                        <div style="padding: 14px; background: var(--c-accent-light); border-radius: 12px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 700; color: var(--c-dark);">${
                                      item.cantidad
                                    }x ${escapeHtml(item.nombre)}</div>
                                    ${
                                      item.selecciones
                                        ? `<div style="color: var(--c-accent); font-size: 0.85em; margin-top: 5px;">馃崯 ${item.selecciones.patatas} | 馃イ ${item.selecciones.bebida}</div>`
                                        : ""
                                    }
                                    ${
                                      item.modificaciones?.length
                                        ? `<div style="color: var(--c-accent); font-size: 0.85em; margin-top: 5px;">馃摑 ${item.modificaciones
                                            .map((m) => escapeHtml(m))
                                            .join(", ")}</div>`
                                        : ""
                                    }
                                </div>
                                <div style="font-weight: 800; color: var(--c-brand);">${(
                                  item.precio * item.cantidad
                                ).toFixed(2)}鈧?/div>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div style="background: linear-gradient(135deg, var(--c-brand) 0%, var(--c-brand-light) 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 0.9em; opacity: 0.9;">Total a Pagar</div>
                    <div style="font-size: 2.2em; font-weight: 900; margin-top: 5px;">${mesa.pedido.total.toFixed(
                      2
                    )}鈧?/div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="continuarPedido('${
                      mesa.numero
                    }')">鉃?A帽adir</button>
                    <button class="btn btn-success" onclick="cobrarMesa('${
                      mesa.numero
                    }')">馃挵 Cobrar</button>
                    <button class="btn btn-danger" onclick="cancelarPedido('${
                      mesa.numero
                    }')">鉂?Cancelar</button>
                </div>`;
      }

      function actualizarVisualMesa(numero) {
        const mesa = estado.mesas.get(numero);
        if (!mesa || !mesa.elemento) return;

        const el = mesa.elemento;
        // reset de clases visuales (manteniendo clase base 'table')
        el.classList.remove("libre", "ocupada", "pagado");
        el.classList.add(mesa.estado);

        // subnodos propios de la mesa
        const badge = el.querySelector(".time-badge");
        const numEl = el.querySelector(".numero-mesa");
        const priceEl = el.querySelector(".precio-mesa");

        if (numEl) numEl.textContent = mesa.numero;
        const total = mesa.pedido?.total ?? 0;
        if (priceEl)
          priceEl.textContent = total > 0 ? `${total.toFixed(2)}鈧琡 : "";

        if (mesa.estado === "ocupada" && mesa.horaOcupacion) {
          const mins = Math.max(
            0,
            Math.floor((Date.now() - new Date(mesa.horaOcupacion)) / 60000)
          );
          if (badge) {
            badge.style.display = "block";
            badge.textContent = `${mins}m`;
          }
        } else {
          if (badge) badge.style.display = "none";
        }
      }

      function calcularTiempoOcupacion(horaOcupacion) {
        if (!horaOcupacion) return "0m";
        const minutos = Math.floor(
          (new Date() - new Date(horaOcupacion)) / 60000
        );
        if (minutos < 60) return `${minutos}m`;
        return `${Math.floor(minutos / 60)}h ${minutos % 60}m`;
      }

      function continuarPedido(numeroMesa) {
        const mesa = estado.mesas.get(numeroMesa);
        estado.currentOrder = {
          ...mesa.pedido,
          items: new Map(
            mesa.pedido.items.map((item, index) => [`existing_${index}`, item])
          ),
        };

        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = generarFormularioPedido();
        mostrarCategoria(estado.categoriaActiva);
        actualizarVistaCarrito();
        setTimeout(() => {
          const searchInput = document.querySelector(".search-bar input");
          if (searchInput) {
            searchInput.focus();
            searchInput.click();
          }
        }, 100);
      }

      function cobrarMesa(numeroMesa) {
        console.log('馃攳 cobrarMesa iniciada - numeroMesa:', numeroMesa);
        const mesa = estado.mesas.get(numeroMesa);
        console.log('馃攳 Mesa encontrada:', mesa);
        
        if (!mesa) {
          console.error('鉂?Mesa no encontrada:', numeroMesa);
          mostrarToast(`Error: Mesa ${numeroMesa} no encontrada`, "error");
          return;
        }
        
        if (!mesa.pedido) {
          console.error('鉂?Mesa sin pedido:', numeroMesa);
          mostrarToast(`Error: Mesa ${numeroMesa} no tiene pedido`, "error");
          return;
        }
        
        console.log('馃攳 Pedido de la mesa:', mesa.pedido);
        console.log('馃攳 Total del pedido:', mesa.pedido.total);
        
        if (
          confirm(
            `驴Cobrar mesa ${numeroMesa}?\nTotal: ${mesa.pedido.total.toFixed(
              2
            )}鈧琡
          )
        ) {
          console.log('鉁?Usuario confirm贸 el cobro');
          console.log('鉁?Usuario confirm贸 el cobro');
          // CAMBIAR ESTADO COMO EN V04
          console.log('馃攳 Cambiando estado de mesa...');
          // Registrar el pago en el pedido antes de liberar la mesa
          const pedidoPagado = mesa.pedido;
          if (pedidoPagado) {
            pedidoPagado.pagado = true;
            pedidoPagado.horaPago = new Date();
          }
          // Liberar la mesa autom谩ticamente tras el cobro
          mesa.estado = "libre";
          mesa.pedido = null;
          mesa.horaOcupacion = null;
          console.log('鉁?Estado cambiado a libre tras cobro');

          // CAPTURAR EVENTO DE ANALYTICS
          console.log('馃攳 Capturando evento de analytics...');
          try {
            analytics.capturarEvento('venta', {
              mesa: numeroMesa,
              total: mesa.pedido.total,
              productos: mesa.pedido.productos,
              metodoPago: 'efectivo', // Se puede extender para otros m茅todos
              tiempo: new Date() - mesa.pedido.horaInicio
            });
            console.log('鉁?Evento de analytics capturado');
          } catch (e) {
            console.error('鉂?Error en analytics:', e);
          }

          // ACTUALIZAR VISUAL INMEDIATAMENTE
          console.log('馃攳 Actualizando visual de mesa...');
          try {
            actualizarVisualMesa(numeroMesa);
            console.log('鉁?Visual de mesa actualizado');
          } catch (e) {
            console.error('鉂?Error actualizando visual:', e);
          }

          console.log('馃攳 Guardando estado...');
          try {
            guardarEstado();
            console.log('鉁?Estado guardado');
          } catch (e) {
            console.error('鉂?Error guardando estado:', e);
          }

          console.log('馃攳 Actualizando estad铆sticas...');
          try {
            actualizarEstadisticas();
            console.log('鉁?Estad铆sticas actualizadas');
          } catch (e) {
            console.error('鉂?Error actualizando estad铆sticas:', e);
          }

          console.log('馃攳 Mostrando toast de 茅xito...');
          try {
            mostrarToast(`馃挵 Mesa ${numeroMesa} cobrada`, "success");
            console.log('鉁?Toast mostrado');
          } catch (e) {
            console.error('鉂?Error mostrando toast:', e);
          }

          console.log('馃攳 Cerrando modal...');
          try {
            cerrarModal();
            console.log('鉁?Modal cerrado');
          } catch (e) {
            console.error('鉂?Error cerrando modal:', e);
          }
          
          console.log('馃帀 cobrarMesa completada exitosamente');
        } else {
          console.log('鉂?Usuario cancel贸 el cobro');
        }
      }

      function cancelarPedido(numeroMesa) {
        if (confirm(`驴Cancelar TODO el pedido de la mesa ${numeroMesa}?`)) {
          estado.pedidos = estado.pedidos.filter(
            (p) => p.id !== estado.mesas.get(numeroMesa).pedido.id
          );
          liberarMesa(numeroMesa);
          mostrarToast("Pedido cancelado", "error");
          cerrarModal();
        }
      }

      function liberarMesa(numeroMesa) {
        const mesa = estado.mesas.get(numeroMesa);
        if (!mesa) return;
        if (confirm(`驴Liberar mesa ${numeroMesa}?`)) {
          // Visual inmediato
          mesa.estado = "libre";
          mesa.pedido = null;
          mesa.horaOcupacion = null;
          actualizarVisualMesa(numeroMesa);
          cerrarModal();
          mostrarToast("Mesa liberada", "success");

          // Mantener persistencia y estad铆sticas
          guardarEstado();
          actualizarEstadisticas();
        }
      }

      function nuevoPedidoParaLlevar() {
        // CAPTURAR EVENTO DE NAVEGACI脫N (con verificaci贸n)
        try {
          if (typeof analytics !== 'undefined' && analytics.capturarEvento) {
            analytics.capturarEvento('navegacion', {
              seccion: 'nuevo_pedido_llevar',
              hora: new Date()
            });
          }
        } catch (e) {
          console.warn('Analytics no disponible:', e);
        }

        const contenido = generarFormularioNombreCliente();
        mostrarModalEstandar("Nuevo Pedido Para Llevar", contenido);
      }

      function generarFormularioNombreCliente() {
        // Pedidos para llevar activos: pendientes de pago
        const pedidosActivos = estado.pedidos.filter(
          (p) => p.tipo === "PARALLEVAR" && !p.pagado
        );

        let pedidosExistentesHTML = "";
        if (pedidosActivos.length > 0) {
          pedidosExistentesHTML = `
            <div style="background: var(--c-accent-light); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="color: var(--c-dark); margin-bottom: 10px;">馃Ь Pedidos Para Llevar (pendientes)</h4>
              ${pedidosActivos
                .map(
                  (p) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--c-light); border-radius: 8px; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: bold; color: var(--c-dark); margin-bottom: 4px;">${p.nombreCliente || 'Cliente sin nombre'}</div>
                    <div style="font-size: 0.9em; color: var(--c-accent);">馃挵 ${p.total.toFixed(2)}鈧?鈥?馃晵 ${new Date(
                      p.fecha
                    ).toLocaleTimeString()}</div>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-warning" onclick="cobrarPedidoParaLlevar('${
                      p.id
                    }')" style="padding: 8px 12px; font-size: 0.8em;">馃挵 Cobrar</button>
                    <button class="btn btn-info" onclick="continuarPedidoParaLlevar('${
                      p.id
                    }')" style="padding: 8px 12px; font-size: 0.8em;">+ A脩ADIR</button>
                    <button class="btn btn-success" onclick="marcarPedidoEntregado('${
                      p.id
                    }')" style="padding: 8px 12px; font-size: 0.8em;">驴 ENTREGADO?</button>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        return `
          <div style="padding: 20px;">
            ${pedidosExistentesHTML}
            
            <div style="background: var(--c-warn); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="color: var(--c-dark); margin-bottom: 15px;">馃啎 Nuevo Pedido Para Llevar</h3>
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--c-dark);">Nombre del Cliente:</label>
              <input type="text" id="nombreCliente" placeholder="Introduce el nombre..." 
                     style="width: 100%; padding: 15px; border: 3px solid var(--c-accent); border-radius: 12px; font-size: 16px; margin-bottom: 15px;"
                     onkeyup="if(event.key === 'Enter') confirmarNombreCliente()">
              <div id="errorNombre" style="color: var(--c-brand); font-weight: 600; margin-bottom: 10px; display: none;"></div>
            </div>
            
            <div class="action-buttons">
              <button class="btn btn-danger" onclick="cerrarModal()">Cancelar</button>
              <button class="btn btn-success" onclick="confirmarNombreCliente()">Continuar Pedido</button>
            </div>
          </div>
        `;
      }

      function confirmarNombreCliente() {
        const nombreInput = document.getElementById("nombreCliente");
        const errorDiv = document.getElementById("errorNombre");
        const nombre = nombreInput.value.trim();

        if (!nombre) {
          errorDiv.textContent = "El nombre es obligatorio";
          errorDiv.style.display = "block";
          nombreInput.focus();
          return;
        }

        // Verificar si ya existe un pedido activo (pendiente de pago) con ese nombre
        const pedidoExistente = estado.pedidos.find(
          (p) =>
            p.tipo === "PARALLEVAR" &&
            !p.pagado &&
            p.nombreCliente &&
            p.nombreCliente.toLowerCase() === nombre.toLowerCase()
        );

        if (pedidoExistente) {
          errorDiv.textContent = `Ya existe un pedido activo para "${nombre}". Usa el bot贸n "+ A脩ADIR" para agregar m谩s productos.`;
          errorDiv.style.display = "block";
          nombreInput.focus();
          return;
        }

        // Crear nuevo pedido
        estado.currentOrder = {
          tipo: "PARALLEVAR",
          nombreCliente: nombre,
          items: new Map(),
          total: 0,
          fecha: new Date(),
          camarero: estado.usuarioActual.nombre,
          entregado: false,
          pagado: false,
        };

        iniciarPedidoParaLlevar(nombre);
      }

      function continuarPedidoParaLlevar(pedidoId) {
        const pedido = estado.pedidos.find((p) => p.id == pedidoId);
        if (!pedido) {
          mostrarToast("Pedido no encontrado", "error");
          return;
        }

        // Configurar currentOrder basado en el pedido existente
        estado.currentOrder = {
          ...pedido,
          items: new Map(
            pedido.items.map((item, index) => [`existing_${index}`, item])
          ),
          esAdicion: true,
          pedidoOriginalId: pedido.id,
        };

        iniciarPedidoParaLlevar(pedido.nombreCliente, true);
      }

      function iniciarPedidoParaLlevar(nombreCliente, esAdicion = false) {
        const titulo = esAdicion
          ? `Para Llevar - ${nombreCliente} (A脩ADIR)`
          : `Para Llevar - ${nombreCliente}`;

        const contenido = generarFormularioPedido();
        
        if (actualizarModalLegacy(titulo, contenido)) {
          mostrarCategoria("combos");
          actualizarVistaCarrito();

          setTimeout(() => {
            const searchInput = document.querySelector(".search-bar input");
            if (searchInput) {
              searchInput.focus();
              searchInput.click();
            }
          }, 100);
        }
      }

      function cobrarPedidoParaLlevar(pedidoId) {
        console.log('馃攳 cobrarPedidoParaLlevar iniciada - pedidoId:', pedidoId);
        const pedido = estado.pedidos.find((p) => p.id == pedidoId);
        console.log('馃攳 Pedido encontrado:', pedido);
        
        if (!pedido) {
          console.error('鉂?Pedido no encontrado:', pedidoId);
          return mostrarToast("Pedido no encontrado", "error");
        }
        
        const total = pedido.total?.toFixed(2) ?? "0.00";
        console.log('馃攳 Total del pedido:', total);
        
        const ok = confirm(
          `驴Cobrar pedido para llevar de "${pedido.nombreCliente}"?\nTotal: ${total}鈧琡
        );
        console.log('馃攳 Resultado del confirm:', ok);
        
        if (!ok) {
          console.log('鉂?Usuario cancel贸 el cobro para llevar');
          return;
        }
        
        console.log('鉁?Usuario confirm贸 el cobro para llevar');
        
        console.log('馃攳 Marcando pedido como pagado...');
        pedido.pagado = true;
        pedido.horaPago = new Date();
        console.log('鉁?Pedido marcado como pagado');

        // CAPTURAR EVENTO DE ANALYTICS
        console.log('馃攳 Capturando evento de analytics...');
        try {
          analytics.capturarEvento('venta', {
            tipo: 'para_llevar',
            pedidoId: pedidoId,
            cliente: pedido.nombreCliente,
            total: pedido.total,
            productos: pedido.productos,
            metodoPago: 'efectivo',
            tiempo: new Date() - pedido.horaCreacion
          });
          console.log('鉁?Evento de analytics capturado');
        } catch (e) {
          console.error('鉂?Error en analytics:', e);
        }

        console.log('馃攳 Guardando estado...');
        try {
          guardarEstado();
          console.log('鉁?Estado guardado');
        } catch (e) {
          console.error('鉂?Error guardando estado:', e);
        }

        console.log('馃攳 Actualizando estad铆sticas...');
        try {
          actualizarEstadisticas();
          console.log('鉁?Estad铆sticas actualizadas');
        } catch (e) {
          console.error('鉂?Error actualizando estad铆sticas:', e);
        }

        console.log('馃攳 Mostrando toast de 茅xito...');
        try {
          mostrarToast(`馃挵 Cobrado ${pedido.nombreCliente}`, "success");
          console.log('鉁?Toast mostrado');
        } catch (e) {
          console.error('鉂?Error mostrando toast:', e);
        }

        console.log('馃攳 Verificando modal...');
        if (document.getElementById("modal").classList.contains("show")) {
          console.log('馃攳 Modal abierto, llamando nuevoPedidoParaLlevar...');
          try {
            nuevoPedidoParaLlevar();
            console.log('鉁?nuevoPedidoParaLlevar ejecutado');
          } catch (e) {
            console.error('鉂?Error en nuevoPedidoParaLlevar:', e);
          }
        }
        
        console.log('馃帀 cobrarPedidoParaLlevar completada exitosamente');
      }

      // SISTEMA DE M脷LTIPLES IMPRESORAS - READY TO USE
      /*
      function configurarImpresora() {
        const config = cargarConfigImpresoras();
        const titulo = "馃枿锔?Configurar Impresoras";
        const contenido = `
                <div class="form-gestor">
                    <h3 style="color: var(--c-accent); margin-bottom: 15px;">Sistema de Impresoras M煤ltiples</h3>
                    
                    <div style="background: var(--c-accent-light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: var(--c-dark); margin-bottom: 10px;">馃崝 IMPRESORA COCINA</h4>
                        <label>IP Cocina:</label>
                        <input type="text" id="printerIPCocina" value="${config.cocina.ip}" placeholder="192.168.1.100">
                        <label>Puerto:</label>
                        <input type="number" id="printerPortCocina" value="${config.cocina.port}" placeholder="9100">
                        <label>Activa:</label>
                        <select id="printerActivaCocina">
                            <option value="true" ${config.cocina.activa ? "selected" : ""}>S铆</option>
                            <option value="false" ${!config.cocina.activa ? "selected" : ""}>No</option>
                        </select>
                    </div>
                    
                    <div style="background: var(--c-warn); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: var(--c-dark); margin-bottom: 10px;">馃嵑 IMPRESORA BARRA</h4>
                        <label>IP Barra:</label>
                        <input type="text" id="printerIPBarra" value="${config.barra.ip}" placeholder="192.168.1.101">
                        <label>Puerto:</label>
                        <input type="number" id="printerPortBarra" value="${config.barra.port}" placeholder="9100">
                        <label>Activa:</label>
                        <select id="printerActivaBarra">
                            <option value="true" ${config.barra.activa ? "selected" : ""}>S铆</option>
                            <option value="false" ${!config.barra.activa ? "selected" : ""}>No</option>
                        </select>
                    </div>
                    
                    <label>Modo de Impresi贸n:</label>
                    <select id="printMode">
                        <option value="auto" ${config.mode === "auto" ? "selected" : ""}>Autom谩tico (al confirmar pedido)</option>
                        <option value="manual" ${config.mode === "manual" ? "selected" : ""}>Manual (bot贸n imprimir)</option>
                    </select>
                    
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <p style="font-size: 0.85em; color: var(--c-accent);">
                            <strong>Nota:</strong> Los productos de cocina (burgers, snacks, postres) se enviar谩n a la impresora de cocina. 
                            Las bebidas y caf茅s se enviar谩n a la impresora de barra.
                            Solo se imprimir谩n los items nuevos al a帽adir a una mesa.
                        </p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="cerrarModal()">Cancelar</button>
                    <button class="btn btn-info" onclick="probarImpresoraCocina()">馃И Test Cocina</button>
                    <button class="btn btn-info" onclick="probarImpresoraBarra()">馃И Test Barra</button>
                    <button class="btn btn-success" onclick="guardarConfigImpresoras()">馃捑 Guardar</button>
                </div>`;
        
        mostrarModalEstandar(titulo, contenido);
      }
      */

      // FUNCI脫N DESACTIVADA - Solo muestra mensaje
      function configurarImpresora() {
        const titulo = "馃枿锔?Configurar Impresoras";
        const contenido = `
          <div style="text-align: center; padding: 40px 20px; color: var(--c-accent);">
            <div style="font-size: 4em; margin-bottom: 20px;">鈿狅笍</div>
            <h3 style="margin-bottom: 15px;">FUNCI脫N DE IMPRESORAS DESACTIVADA</h3>
            <p style="font-size: 1.1em; opacity: 0.8;">Las impresoras est谩n temporalmente deshabilitadas.</p>
            <div style="margin-top: 30px;">
              <button class="btn btn-danger" onclick="cerrarModal()">Cerrar</button>
            </div>
          </div>
        `;
        
        mostrarModalEstandar(titulo, contenido);
      }

      /*
      function cargarConfigImpresoras() {
        const configGuardada = localStorage.getItem("printersConfig");
        if (configGuardada) {
          return JSON.parse(configGuardada);
        }
        return {
          cocina: {
            ip: "192.168.1.100",
            port: 9100,
            activa: true,
          },
          barra: {
            ip: "192.168.1.101",
            port: 9100,
            activa: true,
          },
          mode: "auto",
        };
      }

      function guardarConfigImpresoras() {
        const config = {
          cocina: {
            ip: document.getElementById("printerIPCocina").value,
            port: document.getElementById("printerPortCocina").value,
            activa:
              document.getElementById("printerActivaCocina").value === "true",
          },
          barra: {
            ip: document.getElementById("printerIPBarra").value,
            port: document.getElementById("printerPortBarra").value,
            activa:
              document.getElementById("printerActivaBarra").value === "true",
          },
          mode: document.getElementById("printMode").value,
        };

        localStorage.setItem("printersConfig", JSON.stringify(config));
        mostrarToast("鉁?Configuraci贸n de impresoras guardada", "success");
        cerrarModal();
      }

      async function enviarAImpresora(
        pedido,
        items,
        tipoImpresora,
        esAdicion = false
      ) {
        const config = cargarConfigImpresoras();

        try {
          const ticketHTML = generarTicketHTML(
            pedido,
            items,
            tipoImpresora,
            esAdicion
          );
          const printWindow = window.open("", "_blank");
          printWindow.document.write(ticketHTML);
          printWindow.document.close();
          printWindow.print();

          return { success: true, method: "browser" };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      function generarTicketHTML(
        pedido,
        items,
        tipoImpresora,
        esAdicion = false
      ) {
        const fecha = new Date();
        const titulo = tipoImpresora === "cocina" ? "馃崝 COCINA" : "馃嵑 BARRA";
        const mensajeAdicional = esAdicion ? "*** ADICI脫N ***" : "";

        let itemsHTML = "";
        items.forEach((item) => {
          const nombreItem = item.nombre || item;
          const cantidad = item.cantidad || 1;
          itemsHTML += `
                    <div style="font-weight: bold; margin-top: 10px;">
                        ${cantidad}x ${nombreItem}
                        ${item.esCombo ? " (COMBO)" : ""}
                    </div>
                    ${
                      item.modificaciones?.length
                        ? `<div style="font-size: 11px; margin-left: 10px;">馃摑 ${item.modificaciones.join(
                            ", "
                          )}</div>`
                        : ""
                    }
                `;
        });

        return `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        @page { size: 80mm 200mm; margin: 0; }
                        body { font-family: monospace; font-size: 13px; width: 80mm; padding: 5mm; }
                        h1 { text-align: center; font-size: 20px; margin: 10px 0; background: #000; color: white; padding: 5px; }
                        h2 { text-align: center; font-size: 16px; margin: 5px 0; }
                        .center { text-align: center; }
                        .line { border-bottom: 2px dashed #000; margin: 10px 0; }
                        .importante { font-size: 16px; font-weight: bold; background: yellow; padding: 5px; text-align: center; }
                    </style>
                </head>
                <body onload="window.print(); setTimeout(window.close, 500);">
                    <h1>${titulo}</h1>
                    ${
                      mensajeAdicional
                        ? `<div class="importante">${mensajeAdicional}</div>`
                        : ""
                    }
                    <div class="line"></div>
                    <h2>${
                      pedido.tipo === "MESA"
                        ? `MESA: ${pedido.mesa}`
                        : "PARA LLEVAR"
                    }</h2>
                    <div class="center">Pedido: #${pedido.id}</div>
                    <div class="center">${fecha.toLocaleTimeString()}</div>
                    <div class="line"></div>
                    ${itemsHTML}
                    <div class="line"></div>
                    <div class="center" style="margin-top: 20px;">
                        <strong>${CONFIG.EMPRESA}</strong>
                    </div>
                </body>
            `;
      }

      async function probarImpresoraCocina() {
        mostrarToast("馃枿锔?Enviando test a impresora COCINA...", "info");
        const pedidoTest = {
          id: "TEST-" + Date.now(),
          tipo: "TEST",
          mesa: "TEST",
                </style>
        };
                </head>
                <body>
                <!-- LOGIN SCREEN -->
                <div id="loginScreen">
        const itemsTest = [{ nombre: "TEST COCINA - Si ves esto, funciona!" }];

        const resultado = await enviarAImpresora(
          pedidoTest,
          itemsTest,
          "cocina"
        );

        if (resultado.success) {
          mostrarToast("鉁?Test COCINA enviado", "success");
        } else {
          mostrarToast(`鉂?Error COCINA: ${resultado.error}`, "error");
        }
      }

      async function probarImpresoraBarra() {
        mostrarToast("馃枿锔?Enviando test a impresora BARRA...", "info");
        const pedidoTest = {
          id: "TEST-" + Date.now(),
          tipo: "TEST",
          mesa: "TEST",
        };
        const itemsTest = [{ nombre: "TEST BARRA - Si ves esto, funciona!" }];

        const resultado = await enviarAImpresora(
          pedidoTest,
          itemsTest,
          "barra"
        );

        if (resultado.success) {
          mostrarToast("鉁?Test BARRA enviado", "success");
        } else {
          mostrarToast(`鉂?Error BARRA: ${resultado.error}`, "error");
        }
      }
      */

      // FUNCIONES DE IMPRESORAS DESACTIVADAS - Solo devuelven valores por defecto
      function cargarConfigImpresoras() {
        return {
          cocina: { ip: "localhost", port: 9100, activa: false },
          barra: { ip: "localhost", port: 9100, activa: false },
          mode: "manual",
        };
      }

      function guardarConfigImpresoras() {
        alert("鈿狅笍 Configuraci贸n de impresoras desactivada");
      }

      async function enviarAImpresora() {
        return { success: true, message: "Impresi贸n desactivada" };
      }

      async function probarImpresoraCocina() {
        alert("鈿狅笍 Prueba de impresora desactivada");
      }

      async function probarImpresoraBarra() {
        alert("鈿狅笍 Prueba de impresora desactivada");
      }

      // INFORMES AVANZADOS
      function verResumenDia() {
  // Compatibilidad con c贸digo antiguo: delega en el nuevo resumen simple
  mostrarResumenSimple();
}

function mostrarResumenSimple() {
  try {
    const hoy = new Date().toDateString();

    const pedidosHoy = estado.pedidos.filter(p => esPedidoDeHoy(p));
    const ventasHoy = pedidosHoy.reduce((sum, p) => sum + (p.total || 0), 0);

    const mesasOcupadas = Array.from(estado.mesas.values())
      .filter(m => m.estado === "ocupada").length;

    const pedidosLlevar = pedidosHoy.filter(p => p.tipo === "PARALLEVAR").length;

    const ticketMedio = pedidosHoy.length > 0
      ? (ventasHoy / pedidosHoy.length)
      : 0;

    const contenido = `
      <div style="padding: 16px 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; margin-bottom: 16px;">
          <div style="background: #111827; color: #f9fafb; padding: 16px; border-radius: 16px;">
            <div style="font-size: 13px; opacity: .8; margin-bottom: 4px;">Ventas hoy</div>
            <div style="font-size: 24px; font-weight: 700;">鈧?{ventasHoy.toFixed(2)}</div>
          </div>
          <div style="background: #111827; color: #f9fafb; padding: 16px; border-radius: 16px;">
            <div style="font-size: 13px; opacity: .8; margin-bottom: 4px;">Pedidos hoy</div>
            <div style="font-size: 24px; font-weight: 700;">${pedidosHoy.length}</div>
          </div>
          <div style="background: #111827; color: #f9fafb; padding: 16px; border-radius: 16px;">
            <div style="font-size: 13px; opacity: .8; margin-bottom: 4px;">Ticket medio</div>
            <div style="font-size: 24px; font-weight: 700;">鈧?{ticketMedio.toFixed(2)}</div>
          </div>
          <div style="background: #111827; color: #f9fafb; padding: 16px; border-radius: 16px;">
            <div style="font-size: 13px; opacity: .8; margin-bottom: 4px;">Mesas ocupadas</div>
            <div style="font-size: 24px; font-weight: 700;">${mesasOcupadas}</div>
          </div>
        </div>
        <div style="font-size: 13px; opacity: .8; margin-bottom: 6px;">Pedidos para llevar hoy</div>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${pedidosLlevar}</div>
        <div style="font-size: 12px; opacity: .6;">Resumen basado solo en los pedidos cerrados/guardados hoy.</div>
      </div>
    `;

    mostrarModalEstandar("馃搳 Resumen del D铆a", contenido, false);
  } catch (error) {
    console.error('鉂?Error en mostrarResumenSimple():', error);
    mostrarToast('Error mostrando resumen del d铆a: ' + error.message, 'error');
  }
}

function esPedidoDeHoy(pedido) {
  const hoy = new Date().toDateString();
  const posiblesFechas = [
    pedido.fecha,
    pedido.fechaHora,
    pedido.horaCreacion,
    pedido.horaPago
  ].filter(Boolean);

  for (const f of posiblesFechas) {
    const d = new Date(f);
    if (!isNaN(d) && d.toDateString() === hoy) return true;
  }
  return false;
}

function actualizarInformes(fechaSeleccionada) {
        console.log('馃攳 actualizarInformes() iniciada con fecha:', fechaSeleccionada);
        try {
          const contenidoDiv = document.getElementById("informesContenido");
          if (!contenidoDiv) {
            console.error('鉂?Elemento informesContenido no encontrado');
            return;
          }

          console.log('馃攳 Total de pedidos en estado:', estado.pedidos.length);
          console.log('馃攳 Estructura de pedidos:', estado.pedidos);
          
          const pedidosDelDia = estado.pedidos.filter(
            (p) => {
              const fechaPedidoDate = new Date(p.fecha);
              const fechaPedido = `${fechaPedidoDate.getFullYear()}-${String(fechaPedidoDate.getMonth()+1).padStart(2,"0")}-${String(fechaPedidoDate.getDate()).padStart(2,"0")}`;
              const coincide = fechaPedido === fechaSeleccionada;
              if (coincide) {
                console.log('馃攳 Pedido del d铆a encontrado:', p);
                console.log('馃攳 Items del pedido:', p.items);
                console.log('馃攳 Camarero del pedido:', p.camarero);
              }
              return coincide;
            }
          );

          console.log('馃攳 Pedidos del d铆a filtrados:', pedidosDelDia.length);

          if (pedidosDelDia.length === 0) {
            console.warn('鈿狅笍 No hay datos para la fecha seleccionada');
            contenidoDiv.innerHTML = `<p style="text-align:center; padding: 40px; color: var(--c-brand);">No hay datos para la fecha seleccionada.</p>`;
            return;
          }

          const ventasTotal = pedidosDelDia.reduce((sum, p) => sum + (p.total || 0), 0);
          const ticketMedio = ventasTotal / pedidosDelDia.length;
          console.log('馃攳 Ventas totales:', ventasTotal, 'Ticket medio:', ticketMedio);

          // VENTAS POR CAMARERO - MEJORADO
          const ventasPorCamarero = pedidosDelDia.reduce((acc, p) => {
            const nombre = (p.camarero && String(p.camarero).trim()) || "";
            if (!nombre || nombre.toLowerCase() === "admin") return acc; // excluir admin y vac铆os
            acc[nombre] = (acc[nombre] || 0) + (p.total || 0);
            return acc;
          }, {});
          console.log('馃攳 Ventas por camarero FINAL:', ventasPorCamarero);
          console.log('馃攳 N煤mero de camareros:', Object.keys(ventasPorCamarero).length);

          // PRODUCTOS M脕S VENDIDOS - MEJORADO
          const contadorProductos = {};
          pedidosDelDia.forEach(p => {
            console.log('馃攳 Procesando pedido para productos:', p.id, 'Items type:', typeof p.items, 'Is Map:', p.items instanceof Map);
            if (p.items) {
              // Manejar tanto Map como Array
              const items = p.items instanceof Map ? Array.from(p.items.values()) : p.items;
              console.log('馃攳 Items convertidos:', items.length, 'items');
              items.forEach(item => {
                console.log('馃攳 Item individual:', item.nombre, 'Cantidad:', item.cantidad);
                contadorProductos[item.nombre] = (contadorProductos[item.nombre] || 0) + (item.cantidad || 1);
                console.log('馃攳 Producto contado:', item.nombre, 'Total acumulado:', contadorProductos[item.nombre]);
              });
            }
          });
          console.log('馃攳 Contador productos FINAL:', contadorProductos);
          console.log('馃攳 N煤mero de productos 煤nicos:', Object.keys(contadorProductos).length);

          const topProductos = Object.entries(contadorProductos)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
          console.log('馃攳 Top productos:', topProductos);

          // VENTAS POR CATEGOR脥A - MEJORADO
          const ventasPorCategoria = {};
          pedidosDelDia.forEach(p => {
            if (p.items) {
              // Manejar tanto Map como Array
              const items = p.items instanceof Map ? Array.from(p.items.values()) : p.items;
              items.forEach(item => {
                const categoria = item.categoria || "Sin Categor铆a";
                const totalItem = (item.precio || 0) * (item.cantidad || 1);
                ventasPorCategoria[categoria] = (ventasPorCategoria[categoria] || 0) + totalItem;
                console.log('馃攳 Categor铆a:', categoria, 'Total item:', totalItem);
              });
            }
          });
          console.log('馃攳 Ventas por categor铆a FINAL:', ventasPorCategoria);
          console.log('馃攳 N煤mero de categor铆as:', Object.keys(ventasPorCategoria).length);

        // Generar HTML de camareros
        let htmlCamareros = '';
        if (Object.keys(ventasPorCamarero).length > 0) {
          console.log('馃攳 Generando HTML para camareros');
          htmlCamareros = Object.entries(ventasPorCamarero)
            .sort((a, b) => b[1] - a[1])
            .map(([camarero, total]) => `
              <div class="report-item camarero-item">
                  <span>${escapeHtml(camarero)}</span>
                  <span>${total.toFixed(2)}鈧?/span>
              </div>
            `).join('');
        } else {
          htmlCamareros = '<p style="text-align: center; padding: 20px; color: #666;">No hay datos de camareros</p>';
        }

        // Generar HTML de productos
        let htmlProductos = '';
        if (topProductos.length > 0) {
          console.log('馃攳 Generando HTML para productos');
          htmlProductos = topProductos
            .map(([nombre, cantidad]) => `
              <div class="report-item camarero-item">
                  <span>${escapeHtml(nombre)}</span>
                  <span>${cantidad} unidades</span>
              </div>
            `).join('');
        } else {
          htmlProductos = '<p style="text-align: center; padding: 20px; color: #666;">No hay productos registrados</p>';
        }

        // Generar HTML de categor铆as
        let htmlCategorias = '';
        if (Object.keys(ventasPorCategoria).length > 0) {
          console.log('馃攳 Generando HTML para categor铆as');
          htmlCategorias = Object.entries(ventasPorCategoria)
            .map(([categoria, total]) => `
              <div style="margin-bottom: 15px;">
                  <div style="display:flex; justify-content: space-between; margin-bottom: 5px; font-weight:600;">
                      <span>${escapeHtml(categoria.charAt(0).toUpperCase() + categoria.slice(1))}</span>
                      <span>${total.toFixed(2)}鈧?(${((total / ventasTotal) * 100).toFixed(1)}%)</span>
                  </div>
                  <div style="background: #e0e0e0; border-radius: 5px; height: 20px; overflow: hidden;">
                     <div style="background: var(--c-brand); height: 100%; width: ${((total / ventasTotal) * 100).toFixed(2)}%;; display:flex; align-items:center; height:100%; color:#fff; font-weight:700; padding-left:8px; text-shadow:0 1px 2px rgba(0,0,0,0.4); border-radius:5px;">${escapeHtml(categoria.charAt(0).toUpperCase() + categoria.slice(1))}</div>
                  </div>
              </div>
            `).join('');
        } else {
          htmlCategorias = '<p style="text-align: center; padding: 20px; color: #666;">No hay datos de categor铆as</p>';
        }

        contenidoDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--c-brand) 0%, var(--c-brand-light) 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.2em; font-weight: 900;">${ventasTotal.toFixed(2)}鈧?/div>
                    <div style="opacity: 0.9; margin-top: 5px;">Ventas Totales (${new Date(fechaSeleccionada).toLocaleDateString()})</div>
                    <div style="margin-top: 10px; opacity: 0.9;">
                        <span>Ticket Medio: ${ticketMedio.toFixed(2)}鈧?/span> | 
                        <span>Total Pedidos: ${pedidosDelDia.length}</span>
                    </div>
                </div>

                <details class="report-section" open>
                    <summary>馃懁 Ventas por Camarero</summary>
                    <div class="report-content">
                        ${htmlCamareros}
                    </div>
                </details>

                <details class="report-section">
                    <summary>猸?Productos M谩s Vendidos</summary>
                    <div class="report-content">
                        ${htmlProductos}
                    </div>
                </details>
                
                <details class="report-section">
                    <summary>馃搳 Ventas por Categor铆a</summary>
                    <div class="report-content">
                        ${htmlCategorias}
                    </div>
                </details>
            `;
            
            console.log('鉁?Informes actualizados exitosamente');
        } catch (error) {
          console.error('鉂?Error en actualizarInformes():', error);
          if (contenidoDiv) {
            contenidoDiv.innerHTML = `<p style="text-align:center; padding: 40px; color: var(--c-brand);">Error cargando informes: ${error.message}</p>`;
          }
        }
      }

      function exportarInformes() {
        console.log('馃攳 exportarInformes() iniciada');
        try {
          const fecha = new Date().toISOString().split("T")[0];
          console.log('馃攳 Fecha para exportar:', fecha);
          
          const pedidosDelDia = estado.pedidos.filter(
            (p) => new Date(p.fecha).toISOString().split("T")[0] === fecha
          );
          console.log('馃攳 Pedidos del d铆a encontrados:', pedidosDelDia.length);

          if (pedidosDelDia.length === 0) {
            console.warn('鈿狅笍 No hay datos para exportar hoy');
            return mostrarToast("No hay datos para exportar hoy", "error");
          }

          const ventasTotal = pedidosDelDia.reduce((sum, p) => sum + p.total, 0);
          console.log('馃攳 Ventas totales:', ventasTotal);

          if (typeof CONFIG === 'undefined') {
            console.error('鉂?CONFIG no est谩 definido');
            return mostrarToast("Error: Configuraci贸n no disponible", "error");
          }

          console.log('馃攳 Generando contenido HTML...');
          const htmlContent = `
                  <!DOCTYPE html>
                  <html>
                  <head>
                      <meta charset="UTF-8">
                      <title>Informe ${CONFIG.EMPRESA} - ${fecha}</title>
                      <style>
                          body { font-family: Arial, sans-serif; }
                          h1 { color: #F85065; }
                          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                          th { background-color: #F85065; color: white; }
                          .total { font-weight: bold; background-color: #f0f0f0; }
                      </style>
                  </head>
                  <body>
                      <h1>${CONFIG.EMPRESA} - Informe del ${new Date(
            fecha
          ).toLocaleDateString()}</h1>
                      <h2>Resumen General</h2>
                      <p><strong>Total Ventas:</strong> ${ventasTotal.toFixed(
                        2
                      )}鈧?/p>
                      <p><strong>Total Pedidos:</strong> ${
                        pedidosDelDia.length
                      }</p>
                      <p><strong>Ticket Medio:</strong> ${(
                        ventasTotal / pedidosDelDia.length
                      ).toFixed(2)}鈧?/p>
                      
                      <h2>Detalle de Pedidos</h2>
                      <table>
                          <thead>
                              <tr>
                                  <th>Hora</th>
                                  <th>Tipo</th>
                                  <th>Mesa</th>
                                  <th>Camarero</th>
                                  <th>Productos</th>
                                  <th>Total</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${pedidosDelDia
                                .map(
                                  (p) => `
                                  <tr>
                                      <td>${new Date(
                                        p.fecha
                                      ).toLocaleTimeString()}</td>
                                      <td>${p.tipo}</td>
                                      <td>${p.mesa || "-"}</td>
                                      <td>${p.camarero}</td>
                                      <td>${p.items
                                        .map((i) => `${i.cantidad}x ${i.nombre}`)
                                        .join(", ")}</td>
                                      <td>${p.total.toFixed(2)}鈧?/td>
                                  </tr>
                              `
                                )
                                .join("")}
                              <tr class="total">
                                  <td colspan="5">TOTAL</td>
                                  <td>${ventasTotal.toFixed(2)}鈧?/td>
                              </tr>
                          </tbody>
                      </table>
                  </body>
                  </html>
              `;

          console.log('馃攳 Creando archivo para descarga...');
          const blob = new Blob([htmlContent], {
            type: "application/vnd.ms-excel",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `informe-${CONFIG.EMPRESA.toLowerCase().replace(
            / /g,
            "-"
          )}-${fecha}.xls`;
          link.click();

          console.log('鉁?Archivo descargado exitosamente');
          mostrarToast("馃摜 Informe exportado", "success");
          console.log('馃帀 exportarInformes() completada exitosamente');
        } catch (error) {
          console.error('鉂?Error en exportarInformes():', error);
          mostrarToast('Error exportando informes: ' + error.message, 'error');
        }
      }

      // GESTI脫N DE DATOS
      function mostrarPanelGestion() {
        console.log('馃攳 mostrarPanelGestion() iniciada');
        try {
          const contenido = `
            <div class="admin-grid" style="padding: 20px;">
              <button class="admin-btn" onclick="gestionarUsuarios()">
                <span class="icon">馃懃</span>
                <span>Usuarios</span>
              </button>
              <button class="admin-btn" onclick="gestionarProductos()">
                <span class="icon">馃崝</span>
                <span>Productos</span>
              </button>
              <button class="admin-btn" onclick="gestionarImpresoras()">
                <span class="icon">馃枿锔?/span>
                <span>Impresoras</span>
              </button>
            </div>
          `;
          
          if (mostrarModalEstandar("馃梻锔?Gestionar Datos", contenido)) {
            console.log('鉁?Panel de gesti贸n mostrado exitosamente');
          }
        } catch (error) {
          console.error('鉂?Error en mostrarPanelGestion():', error);
          mostrarToast('Error mostrando panel de gesti贸n: ' + error.message, 'error');
        }
      }

      // Funci贸n de compatibilidad para migrar modales antiguos
      function actualizarModalLegacy(titulo, contenidoHTML) {
        const modal = document.getElementById("modal");
        if (!modal) return false;
        
        // Crear estructura nueva si no existe
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title">${titulo}</h1>
              <button onclick="cerrarModal()" class="modal-close">脳</button>
            </div>
            <div class="modal-body">
              ${contenidoHTML}
            </div>
          </div>
        `;
        
        document.body.classList.add("modal-open");
        modal.classList.add("show");
        return true;
      }

      function gestionarUsuarios() {
        let usersHTML = Object.keys(estado.usuarios)
          .map((username) => {
            const user = estado.usuarios[username];
            return `<div class="item-gestor">
                    <div class="item-gestor-info">${escapeHtml(
                      user.nombre
                    )} (${escapeHtml(user.rol)})</div>
                    <div class="item-gestor-actions">
                        <button onclick="editarUsuario('${username}')">鉁忥笍</button>
                        ${
                          username !== "admin"
                            ? `<button onclick="eliminarUsuario('${username}')">馃棏锔?/button>`
                            : ""
                        }
                    </div>
                </div>`;
          })
          .join("");

        const contenido = `
          <div class="categorias-productos">${usersHTML}</div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="mostrarPanelGestion()">Volver</button>
            <button class="btn btn-success" onclick="editarUsuario()">鉃?A帽adir Usuario</button>
          </div>
        `;
        
        actualizarModalLegacy("馃懃 Gestionar Usuarios", contenido);
      }

      // Exportaci贸n global para handlers inline
      window.gestionarUsuarios = gestionarUsuarios;

      function editarUsuario(username = null) {
        const user = username
          ? estado.usuarios[username]
          : { nombre: "", password: "", rol: "camarero" };

        const titulo = username ? "鉁忥笍 Editar Usuario" : "鉃?A帽adir Usuario";
        const contenido = `
          <div class="form-gestor">
            <label>Nombre:</label>
            <input id="nombre" type="text" value="${escapeHtml(user.nombre)}">
            <label>Contrase帽a:</label>
            <input id="password" type="password" placeholder="${
              username ? "Dejar vac铆o para no cambiar" : "Contrase帽a"
            }">
            <label>Rol:</label>
            <select id="rol">
              <option value="camarero" ${user.rol === "camarero" ? "selected" : ""}>Camarero</option>
              <option value="cajero" ${user.rol === "cajero" ? "selected" : ""}>Cajero</option>
              <option value="admin" ${user.rol === "admin" ? "selected" : ""}>Admin</option>
            </select>
          </div>
          <div class="action-buttons">
            <button class="btn btn-danger" onclick="gestionarUsuarios()">Cancelar</button>
            <button class="btn btn-success" onclick="guardarUsuario('${username || ""}')">Guardar</button>
          </div>
        `;
        
        actualizarModalLegacy(titulo, contenido);
      }

      // Exportaci贸n global para handlers inline
      window.editarUsuario = editarUsuario;

      function guardarUsuario(username) {
        const nombre = document.getElementById("nombre").value;
        const password = document.getElementById("password").value;
        const rol = document.getElementById("rol").value;

        if (!nombre) return mostrarToast("El nombre es obligatorio", "error");
        if (!username && !password)
          return mostrarToast(
            "La contrase帽a es obligatoria para nuevos usuarios",
            "error"
          );

        const nuevoUsername =
          username || nombre.toLowerCase().replace(/\s/g, "");
        if (!username && estado.usuarios[nuevoUsername])
          return mostrarToast("Ese usuario ya existe", "error");

        if (username && nuevoUsername !== username)
          delete estado.usuarios[username];

        if (username && password) {
          estado.usuarios[nuevoUsername] = { nombre, password, rol };
        } else if (username) {
          estado.usuarios[nuevoUsername] = {
            ...estado.usuarios[username],
            nombre,
            rol,
          };
        } else {
          estado.usuarios[nuevoUsername] = { nombre, password, rol };
        }

        guardarEstado();
        mostrarToast("Usuario guardado", "success");
        gestionarUsuarios();
      }

      // Exportaci贸n global para handlers inline
      window.guardarUsuario = guardarUsuario;

      function eliminarUsuario(username) {
        const usuario = estado.usuarios && estado.usuarios[username];
        const nombre = usuario ? usuario.nombre : username;
        if (confirm(`驴Eliminar a ${nombre}?`)) {
          if (usuario) delete estado.usuarios[username];
          guardarEstado();
          mostrarToast("Usuario eliminado", "success");
          gestionarUsuarios();
        }
      }

      // Exportaci贸n global para handlers inline
      window.eliminarUsuario = eliminarUsuario;

      function gestionarProductos() {
        const categoriasOrdenadas = [
          "combos",
          "burgers", 
          "snacks",
          "postres",
          "bebidas",
          "cervezas",
          "cafes",
        ];
        let categoriesHTML = categoriasOrdenadas
          .map((cat) => {
            if (!estado.productos[cat]) return "";
            const productsHTML = estado.productos[cat]
              .map(
                (p) => `
                    <div class="item-gestor">
                        <span>${escapeHtml(p.nombre)} - ${Number((p && p.precio) ?? 0).toFixed(2)}鈧?/span>
                        <div>
                            <button onclick="editarProducto('${cat}', ${p.id})">鉁忥笍</button>
                            <button onclick="eliminarProducto('${cat}', ${p.id})">馃棏锔?/button>
                        </div>
                    </div>`
              )
              .join("");
            return `
                <details open>
                    <summary>${cat.toUpperCase()}</summary>
                    <div>${productsHTML}</div>
                </details>`;
          })
          .join("");

        const contenido = `
          <div class="categorias-productos">${categoriesHTML}</div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="mostrarPanelGestion()">Volver</button>
            <button class="btn btn-success" onclick="editarProducto()">鉃?A帽adir Producto</button>
          </div>
        `;
        
        actualizarModalLegacy("馃崝 Gestionar Productos", contenido);
      }

      // Exportaci贸n global para handlers inline
      window.gestionarProductos = gestionarProductos;

      function editarProducto(cat = null, id = null) {
        const producto =
          cat && id
            ? estado.productos[cat].find((p) => p.id === id)
            : {
                id: Date.now(),
                nombre: "",
                precio: 0,
                descripcion: "",
                ingredientes: "",
                alergenos: [],
                modificaciones: [],
              };
        const esNuevo = !cat;

        const titulo = esNuevo
          ? "鉃?A帽adir Producto"
          : "鉁忥笍 Editar Producto";

        const contenido = `
                <div class="form-gestor">
                    <label>Nombre:</label><input id="nombre" value="${escapeHtml(
                      producto.nombre
                    )}">
                    <label>Precio:</label><input id="precio" type="number" step="0.01" value="${
                      producto.precio
                    }">
                    <label>Categor铆a:</label>
                    <select id="categoria" ${esNuevo ? "" : "disabled"}>
                        ${Object.keys(estado.productos)
                          .map(
                            (c) =>
                              `<option value="${c}" ${
                                cat === c ? "selected" : ""
                              }>${escapeHtml(c)}</option>`
                          )
                          .join("")}
                    </select>
                    <label>Descripci贸n:</label><input id="descripcion" value="${escapeHtml(
                      producto.descripcion || ""
                    )}">
                    <label>Ingredientes:</label><textarea id="ingredientes">${escapeHtml(
                      producto.ingredientes || ""
                    )}</textarea>
                    <label>Al茅rgenos (separados por coma):</label><input id="alergenos" value="${(
                      producto.alergenos || []
                    )
                      .map((a) => escapeHtml(a))
                      .join(", ")}">
                    <label>Modificaciones (separadas por coma):</label><textarea id="modificaciones">${(
                      producto.modificaciones || []
                    )
                      .map((m) => escapeHtml(m))
                      .join(", ")}</textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="gestionarProductos()">Cancelar</button>
                    <button class="btn btn-success" onclick='guardarProducto(${
                      esNuevo ? null : `"${cat}"`
                    }, ${producto.id})'>Guardar</button>
                </div>`;
        
        mostrarModalEstandar(titulo, contenido);
      }

      // Exportaci贸n global para handlers inline
      window.editarProducto = editarProducto;

      function guardarProducto(cat, id) {
        const nombre = document.getElementById("nombre").value.trim();
        const precio = Number(document.getElementById("precio").value);
        const categoria = document.getElementById("categoria").value;

        // Validaciones mejoradas
        if (!nombre) return mostrarToast("El nombre es obligatorio", "error");
        if (isNaN(precio) || precio < 0)
          return mostrarToast("El precio debe ser un n煤mero v谩lido", "error");
        if (!categoria)
          return mostrarToast("La categor铆a es obligatoria", "error");

        // Crear producto con validaciones
        const newProd = {
          id: id || Date.now(), // Si no hay ID, generar uno nuevo
          nombre,
          precio: isFinite(precio) ? precio : 0,
          descripcion: document.getElementById("descripcion").value.trim(),
          ingredientes: document.getElementById("ingredientes").value.trim(),
          alergenos: document
            .getElementById("alergenos")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean),
          modificaciones: document
            .getElementById("modificaciones")
            .value.split(",")
            .map((s) => s.trim())
            .filter(Boolean),
          categoria_impresion: [
            "burgers",
            "snacks",
            "postres",
            "combos",
          ].includes(categoria)
            ? "cocina"
            : "barra",
        };

        // Si es combo, asegurar estructura 'incluye' y normalizar 'ahorro'
        if (categoria === 'combos') {
          // Asegurar estructura b谩sica
          if (!newProd.incluye || typeof newProd.incluye !== 'object') {
            newProd.incluye = {};
          }
          if (!Array.isArray(newProd.incluye.patatas)) {
            newProd.incluye.patatas = ['Cl谩sicas', 'Gajo (+1.00)', 'Cheddar (+1.50)'];
          }
          if (!Array.isArray(newProd.incluye.bebida)) {
            newProd.incluye.bebida = ['Agua', 'Refresco', 'Cerveza (+1.00)'];
          }
          if (typeof newProd.incluye.burger !== 'string') {
            newProd.incluye.burger = 'Burger a elegir';
          }
          // Normalizar ahorro si existe en el producto original editable (si se a帽ade un campo ahorro en UI m谩s tarde)
          if (typeof newProd.ahorro !== 'undefined') {
            const ahorroNum = Number(newProd.ahorro);
            newProd.ahorro = isFinite(ahorroNum) ? ahorroNum : undefined;
          }
        }

        try {
          if (cat) {
            // Actualizar producto existente
            const index = estado.productos[cat].findIndex((p) => p.id === id);
            if (index === -1) {
              return mostrarToast("Producto no encontrado", "error");
            }
            estado.productos[cat][index] = newProd;
          } else {
            // Crear nuevo producto
            if (!estado.productos[categoria]) {
              estado.productos[categoria] = [];
            }
            estado.productos[categoria].push(newProd);
          }

          guardarEstado();
          mostrarToast("鉁?Producto guardado correctamente", "success");
          gestionarProductos();
        } catch (error) {
          console.error("Error guardando producto:", error);
          mostrarToast("Error al guardar el producto", "error");
        }
      }

      // Exportaci贸n global para handlers inline
      window.guardarProducto = guardarProducto;

      function eliminarProducto(cat, id) {
        if (confirm("驴Eliminar este producto?")) {
          estado.productos[cat] = estado.productos[cat].filter(
            (p) => p.id !== id
          );
          guardarEstado();
          mostrarToast("Producto eliminado", "success");
          gestionarProductos();
        }
      }

  // Exportaci贸n global para handlers inline
  window.eliminarProducto = eliminarProducto;

      // IMPRESORAS (configuraci贸n inicial, sin conexi贸n activa)
      function gestionarImpresoras() {
        // Exportaci贸n global
        window.gestionarImpresoras = gestionarImpresoras;
        // Asegurar estructura por defecto
        if (!estado.impresoras) estado.impresoras = {};
        const def = (obj) => ({ habilitada: false, ip: '', puerto: 9100, ...obj });
        estado.impresoras.comida = def(estado.impresoras.comida || {});
        estado.impresoras.bebida = def(estado.impresoras.bebida || {});

        const c = estado.impresoras.comida;
        const b = estado.impresoras.bebida;

        const contenido = `
          <div class="form-gestor">
            <h3 style="color: var(--c-brand); font-weight: 900;">馃崝 Impresora de Comida</h3>
            <label><input type="checkbox" id="impComidaHabilitada" ${c.habilitada ? 'checked' : ''}> Habilitada</label>
            <label>IP / Host:</label>
            <input id="impComidaIP" placeholder="192.168.1.50" value="${escapeHtml(c.ip || '')}">
            <label>Puerto (RAW):</label>
            <input id="impComidaPuerto" type="number" placeholder="9100" value="${Number(c.puerto || 9100)}">
            <div style="color:#666; font-size: 0.85em;">Estado: <strong>Desconectada</strong> (preparado)</div>

            <hr style="margin: 16px 0; border: 0; border-top: 2px solid var(--c-accent-light);"/>

            <h3 style="color: var(--c-accent); font-weight: 900;">馃イ Impresora de Bebida</h3>
            <label><input type="checkbox" id="impBebidaHabilitada" ${b.habilitada ? 'checked' : ''}> Habilitada</label>
            <label>IP / Host:</label>
            <input id="impBebidaIP" placeholder="192.168.1.51" value="${escapeHtml(b.ip || '')}">
            <label>Puerto (RAW):</label>
            <input id="impBebidaPuerto" type="number" placeholder="9100" value="${Number(b.puerto || 9100)}">
            <div style="color:#666; font-size: 0.85em;">Estado: <strong>Desconectada</strong> (preparado)</div>

            <div style="margin-top:10px; color:#555; font-size: 0.85em;">
              Consejo: deja desmarcado "Habilitada" para mantener una impresora desconectada. La impresi贸n ser谩 por WiFi (RAW 9100) cuando se active.
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="mostrarPanelGestion()">Volver</button>
            <button class="btn btn-success" onclick="guardarImpresoras()">Guardar</button>
          </div>
        `;
        actualizarModalLegacy('馃枿锔?Impresoras (Configuraci贸n)', contenido);
      }

      function guardarImpresoras() {
        // Exportaci贸n global
        window.guardarImpresoras = guardarImpresoras;
        const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
        const getNum = (id, def=9100) => {
          const n = Number(document.getElementById(id)?.value);
          return Number.isFinite(n) && n > 0 ? n : def;
        };
        const getChk = (id) => !!document.getElementById(id)?.checked;

        const comida = {
          habilitada: getChk('impComidaHabilitada'),
          ip: getVal('impComidaIP'),
          puerto: getNum('impComidaPuerto', 9100),
        };
        const bebida = {
          habilitada: getChk('impBebidaHabilitada'),
          ip: getVal('impBebidaIP'),
          puerto: getNum('impBebidaPuerto', 9100),
        };

        // Validaci贸n simple: si est谩 habilitada, requiere IP/host
        if (comida.habilitada && !comida.ip) {
          return mostrarToast('IP/Host de impresora de comida es obligatorio si est谩 habilitada', 'error');
        }
        if (bebida.habilitada && !bebida.ip) {
          return mostrarToast('IP/Host de impresora de bebida es obligatorio si est谩 habilitada', 'error');
        }

        estado.impresoras = { comida, bebida };
        try {
          guardarEstado();
          mostrarToast('馃枿锔?Configuraci贸n de impresoras guardada', 'success');
          gestionarImpresoras();
        } catch (e) {
          console.error('Error guardando impresoras', e);
          mostrarToast('Error al guardar la configuraci贸n de impresoras', 'error');
        }
      }

      

      // ==============================
      // Impresi贸n: preparaci贸n (stubs)
      // ==============================
      function imprimirTicketPedido(pedido) {
        // Divide l铆neas por destino seg煤n categoria_impresion: cocina -> comida, barra -> bebida
        try {
          const lineasComida = [];
          const lineasBebida = [];
          (pedido.items || []).forEach(item => {
            const linea = formatearLineaItem(item);
            if ((item.categoria_impresion || 'cocina') === 'cocina') lineasComida.push(linea);
            else lineasBebida.push(linea);
          });

          if (estado.impresoras?.comida?.habilitada && lineasComida.length) {
            const txt = construirTicket(pedido, lineasComida, 'COCINA');
            enviarAImpresora(estado.impresoras.comida, txt);
          }
          if (estado.impresoras?.bebida?.habilitada && lineasBebida.length) {
            const txt = construirTicket(pedido, lineasBebida, 'BARRA');
            enviarAImpresora(estado.impresoras.bebida, txt);
          }
        } catch (e) {
          console.error('Error preparando impresi贸n', e);
          mostrarToast('Error preparando impresi贸n', 'error');
        }
      }

      function formatearLineaItem(item) {
        const nombre = item?.nombre || '脥tem';
        const cant = Number(item?.cantidad || 1);
        let mods = '';
        if (Array.isArray(item?.modificaciones) && item.modificaciones.length) {
          mods = ' [' + item.modificaciones.join(', ') + ']';
        }
        return `${cant}x ${nombre}${mods}`;
      }

      function construirTicket(pedido, lineas, destino) {
        const now = new Date();
        const esLlevar = pedido?.tipo === 'PARALLEVAR';
        const zona = pedido?.zona || (pedido?.mesa && estado?.mesas?.get?.(pedido.mesa)?.zona) || '';
        const encabezadoUbicacion = esLlevar
          ? `PARA LLEVAR: ${pedido?.nombreCliente || 'Sin nombre'}`
          : `${zona ? zona.toUpperCase() + ' - ' : ''}MESA ${pedido?.mesa ?? '-'}`;

        const cab = [
          `MY LITTLE DINER`,
          encabezadoUbicacion,
          `Destino: ${destino}`,
          pedido?.esAdicion ? '*** ADICI脫N ***' : '',
          now.toLocaleString(),
          '------------------------------'
        ].filter(Boolean);
        return cab.concat(lineas).concat(['', '']).join('\n');
      }

      async function enviarAImpresora(cfg, contenido) {
        // Stub: intenta enviar a un bridge HTTP si existe. Si no, s贸lo loguea.
        // Ejemplo de bridge: http://<IP>:<PUERTO>/print con body JSON { data: string }
        try {
          const url = `http://${cfg.ip}:${cfg.puerto}/print`;
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: contenido })
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          mostrarToast('馃枿锔?Enviado a ' + cfg.ip, 'success');
        } catch (e) {
          console.warn('No se pudo enviar a impresora, mostrando en consola. Error:', e);
          console.log('--- Contenido de impresi贸n ---\n' + contenido);
          mostrarToast('Impresi贸n simulada (ver consola)', 'info');
        }
      }

      // Vista previa desde el modal de pedido actual
      function vistaPreviaPedidoActual() {
        try {
          if (!estado.currentOrder || !estado.currentOrder.items || estado.currentOrder.items.size === 0) {
            return mostrarToast('No hay items en el pedido', 'error');
          }
          // Construir un objeto pedido similar al final
          const pedidoVista = {
            tipo: estado.currentOrder.tipo,
            mesa: estado.currentOrder.mesa,
            zona: estado.currentOrder.zona,
            nombreCliente: estado.currentOrder.nombreCliente,
            items: Array.from(estado.currentOrder.items.values())
          };
          // Separar por destino
          const itemsC = [];
          const itemsB = [];
          pedidoVista.items.forEach((item) => {
            if (item.desglose_impresion) {
              item.desglose_impresion.forEach((sub) => {
                (sub.categoria_impresion === 'barra' ? itemsB : itemsC).push(sub);
              });
            } else {
              (item.categoria_impresion === 'barra' ? itemsB : itemsC).push(item);
            }
          });

          const txtC = itemsC.length ? construirTicket(pedidoVista, itemsC.map(formatearLineaItem), 'COCINA') : '鈥?sin l铆neas 鈥?;
          const txtB = itemsB.length ? construirTicket(pedidoVista, itemsB.map(formatearLineaItem), 'BARRA') : '鈥?sin l铆neas 鈥?;

          const contenido = `
            <div style="display:grid; gap:16px;">
              <div>
                <h3 style="margin:0 0 6px 0;">馃嵔锔?Pedido actual (COCINA)</h3>
                <pre style="white-space:pre-wrap; background:#111; color:#0f0; padding:12px; border-radius:8px;">${escapeHtml(txtC)}</pre>
              </div>
              <div>
                <h3 style="margin:0 0 6px 0;">馃嵐 Pedido actual (BARRA)</h3>
                <pre style="white-space:pre-wrap; background:#111; color:#0f0; padding:12px; border-radius:8px;">${escapeHtml(txtB)}</pre>
              </div>
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="const c=generarFormularioPedido(); actualizarModalLegacy(document.querySelector('.modal h2')?.textContent||'Pedido', c); setTimeout(()=>mostrarCategoria(estado.categoriaActiva||'combos'),0)">Volver</button>
              </div>
            </div>`;
          actualizarModalLegacy('馃憗锔?Vista previa del pedido', contenido);
        } catch (e) {
          console.error('Error en vistaPreviaPedidoActual', e);
          mostrarToast('Error generando vista previa', 'error');
        }
      }
      window.vistaPreviaPedidoActual = vistaPreviaPedidoActual;

      // FUNCIONES DE ADMIN
      function limpiarTodo() {
        console.log('馃攳 limpiarTodo() iniciada');
        try {
          if (
            confirm(
              "鈿狅笍 驴BORRAR ABSOLUTAMENTE TODO?\n\nSe perder谩n todos los datos guardados."
            )
          ) {
            console.log('鉁?Usuario confirm贸 limpiar todo');
            const pass = prompt(
              "Introduce la contrase帽a de un administrador para continuar:"
            );
            console.log('馃攳 Contrase帽a introducida, verificando...');
            
            const adminUser = Object.values(estado.usuarios).find(
              (u) => u.rol === "admin" && u.password === pass
            );
            console.log('馃攳 Usuario admin encontrado:', !!adminUser);

            if (adminUser) {
              console.log('鉁?Contrase帽a correcta, procediendo con la limpieza...');
              
              console.log('馃攳 Limpiando localStorage...');
              localStorage.clear();
              console.log('馃攳 Limpiando sessionStorage...');
              sessionStorage.clear();
              
              mostrarToast(
                "Todos los datos han sido borrados. Reiniciando...",
                "success"
              );
              console.log('馃攳 Recargando p谩gina en 2 segundos...');
              setTimeout(() => {
                console.log('馃攧 Recargando p谩gina...');
                location.reload();
              }, 2000);
              console.log('馃帀 limpiarTodo() completado exitosamente');
            } else {
              console.warn('鈿狅笍 Contrase帽a incorrecta');
              mostrarToast("Contrase帽a incorrecta", "error");
            }
          } else {
            console.log('鉂?Usuario cancel贸 la limpieza');
          }
        } catch (error) {
          console.error('鉂?Error en limpiarTodo():', error);
          mostrarToast('Error limpiando datos: ' + error.message, 'error');
        }
      }

      function resetearDia() {
        console.log('馃攳 resetearDia() iniciada');
        try {
          if (confirm("驴Resetear todos los datos del d铆a?")) {
            console.log('鉁?Usuario confirm贸 resetear d铆a');
            const pass = prompt(
              "Introduce la contrase帽a de un administrador para continuar:"
            );
            console.log('馃攳 Contrase帽a introducida, verificando...');
            
            const adminUser = Object.values(estado.usuarios).find(
              (u) => u.rol === "admin" && u.password === pass
            );
            console.log('馃攳 Usuario admin encontrado:', !!adminUser);

            if (adminUser) {
              console.log('鉁?Contrase帽a correcta, procediendo con el reseteo...');
              
              console.log('馃攳 Limpiando pedidos...');
              estado.pedidos = [];

              // Limpiar posibles backups para evitar restauraciones autom谩ticas de pedidos antiguos
              try {
                localStorage.removeItem('estado-tpv-backup');
                console.log('馃Ч Backup autom谩tico eliminado (estado-tpv-backup)');
              } catch (e) {
                console.warn('鈿狅笍 No se pudo eliminar el backup autom谩tico:', e);
              }
              
              console.log('馃攳 Reseteando mesas...');
              estado.mesas.forEach((mesa) => {
                if (mesa.estado !== "libre") {
                  console.log(`馃攳 Liberando mesa ${mesa.numero}`);
                  mesa.estado = "libre";
                  mesa.pedido = null;
                  mesa.horaOcupacion = null;
                  try {
                    actualizarVisualMesa(mesa.numero);
                  } catch (e) {
                    console.error(`鉂?Error actualizando visual de mesa ${mesa.numero}:`, e);
                  }
                }
              });
              
              console.log('馃攳 Guardando estado...');
              try {
                guardarEstado();
                console.log('鉁?Estado guardado');
              } catch (e) {
                console.error('鉂?Error guardando estado:', e);
              }
              
              console.log('馃攳 Actualizando estad铆sticas...');
              try {
                actualizarEstadisticas();
                console.log('鉁?Estad铆sticas actualizadas');
              } catch (e) {
                console.error('鉂?Error actualizando estad铆sticas:', e);
              }
              
              mostrarToast("馃攧 D铆a reseteado correctamente", "success");
              console.log('馃帀 resetearDia() completado exitosamente');
            } else {
              console.warn('鈿狅笍 Contrase帽a incorrecta');
              mostrarToast("Contrase帽a incorrecta", "error");
            }
          } else {
            console.log('鉂?Usuario cancel贸 el reseteo');
          }
        } catch (error) {
          console.error('鉂?Error en resetearDia():', error);
          mostrarToast('Error reseteando el d铆a: ' + error.message, 'error');
        }
      }

      // PERSISTENCIA
      function cargarEstado() {
        // Preferir la clave moderna 'estado-tpv', pero aceptar la legacy 'myLittleDinerTPV_v35' por compatibilidad
        const modernKey = localStorage.getItem("estado-tpv");
        const legacyKey = localStorage.getItem("myLittleDinerTPV_v35");
        const estadoGuardado = modernKey || legacyKey;

        if (estadoGuardado) {
          try {
            const estadoParseado = JSON.parse(estadoGuardado);
            // Fusionar de forma segura sobre el estado actual
            estado = { ...estado, ...estadoParseado };

            // Restaurar mapa de mesas si viene como array
            if (estadoParseado.mesas && Array.isArray(estadoParseado.mesas)) {
              estado.mesas = new Map(
                estadoParseado.mesas.map((m) => [m.numero, m])
              );
            }
          } catch (e) {
            console.error("Error al cargar estado", e);
            Object.assign(estado, getDefaultData());
          }
        } else {
          Object.assign(estado, getDefaultData());
        }
        // Asegurar que siempre existan usuarios por defecto si la carga qued贸 vac铆a
        if (!estado.usuarios || Object.keys(estado.usuarios).length === 0) {
          estado.usuarios = getDefaultData().usuarios;
        }
        // Asegurar configuraci贸n de impresoras por defecto
        if (!estado.impresoras) estado.impresoras = {};
        if (!estado.impresoras.comida) estado.impresoras.comida = { habilitada: false, ip: '', puerto: 9100 };
        if (!estado.impresoras.bebida) estado.impresoras.bebida = { habilitada: false, ip: '', puerto: 9100 };
        
        // Si no hab铆a datos en localStorage, guardar los datos por defecto
        if (!estadoGuardado || !estado.usuarios || !Object.keys(estado.usuarios).length) {
          console.log('[TPV] Inicializando datos por defecto...');
          Object.assign(estado, getDefaultData());
          guardarEstado();
          console.log('[TPV] Datos por defecto guardados en localStorage');
        }
      }

      function guardarEstado() {
        try {
          const estadoParaGuardar = {
            ...estado,
            mesas: Array.from(estado.mesas.values()),
          };
          // Remover referencias no serializables
          estadoParaGuardar.mesas.forEach((m) => delete m.elemento);
          delete estadoParaGuardar.currentOrder;
          delete estadoParaGuardar.modificacionesActuales;

          const serialized = JSON.stringify(estadoParaGuardar);

          // Guardar en la clave legacy para compatibilidad
          localStorage.setItem("myLittleDinerTPV_v35", serialized);

          // Guardar tambi茅n en la nueva clave usada por otras utilidades
          try {
            localStorage.setItem("estado-tpv", serialized);
          } catch (innerErr) {
            // Si falla por espacio o pol铆ticas, al menos la legacy qued贸 escrita
            console.warn('No se pudo escribir estado-tpv, se conserv贸 myLittleDinerTPV_v35', innerErr);
          }
        } catch (e) {
          console.error("Error guardando estado:", e);
        }
      }

      // ACTUALIZACI脫N DE ESTAD脥STICAS
      function actualizarEstadisticas() {
        const hoy = new Date().toDateString();
        const pedidosHoy = estado.pedidos.filter(
          (p) => new Date(p.fecha).toDateString() === hoy
        );
        const mesasOcupadas = Array.from(estado.mesas.values()).filter(
          (m) => m.estado === "ocupada"
        ).length;
        const ventasHoy = pedidosHoy.reduce((sum, p) => sum + p.total, 0);
        const pedidosLlevar = pedidosHoy.filter(
          (p) => p.tipo === "PARALLEVAR"
        ).length;
        const pedidosLlevarPendientes = pedidosHoy.filter(
          (p) => p.tipo === "PARALLEVAR" && !p.pagado
        ).length;

        const setText = (id, text) => {
          const el = document.getElementById(id);
          if (el) el.textContent = text;
        };

        setText("mesasOcupadas", mesasOcupadas);
        setText("serviciosHoy", pedidosHoy.length);
        setText("ventasHoy", ventasHoy.toFixed(0) + "鈧?);
        setText(
          "ticketMedio",
          pedidosHoy.length > 0
            ? (ventasHoy / pedidosHoy.length).toFixed(0) + "鈧?
            : "0鈧?
        );
        setText("pedidosLlevar", pedidosLlevar);

        const badge = document.getElementById("takeawayBadge");
        if (badge) {
          badge.style.display = pedidosLlevarPendientes > 0 ? "flex" : "none";
          badge.textContent = pedidosLlevarPendientes;
        }
      }

      // Funci贸n global para mostrar modales
      function mostrarModal() {
        const modal = document.getElementById("modal");
        if (modal) {
          document.body.classList.add("modal-open");
          modal.classList.add("show");
        }
      }

      // UTILIDADES
      function cerrarModal() {
        document.getElementById("modal").classList.remove("show");
        document.body.classList.remove("modal-open");
        estado.currentOrder = null;
        estado.modificacionesActuales.clear();

        // Actualizar visual de todas las mesas al cerrar el modal
        estado.mesas.forEach((mesa) => actualizarVisualMesa(mesa.numero));
      }

      // Funci贸n est谩ndar para mostrar modales con bot贸n cerrar
      function mostrarModalEstandar(titulo, contenido, usarPantallaCompleta = true) {
        const modal = document.getElementById("modal");
        
        if (!modal) {
          console.error('鉂?Modal no encontrado');
          mostrarToast('Error: No se pudo abrir el modal', 'error');
          return false;
        }

        // Limpiar contenido previo
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title">${titulo}</h1>
              <button onclick="cerrarModal()" class="modal-close">脳</button>
            </div>
            <div class="modal-body">
              ${contenido}
            </div>
          </div>
        `;
        
        document.body.classList.add("modal-open");
        modal.classList.add("show");
        return true;
      }

      function mostrarToast(mensaje, tipo = "info", duracion = 3000, acciones = null) {
        console.log('馃攳 mostrarToast llamada - mensaje:', mensaje, 'tipo:', tipo);
        // Sistema de toasts avanzado con queue
        const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Crear contenedor de toasts si no existe
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
            pointer-events: none;
          `;
          document.body.appendChild(toastContainer);
        }

        // Configuraci贸n de tipos de toast
        const tiposToast = {
          success: { 
            icono: '鉁?, 
            color: '#10b981', 
            bgColor: '#ecfdf5', 
            borderColor: '#6ee7b7',
            sonido: 'success'
          },
          error: { 
            icono: '鉂?, 
            color: '#ef4444', 
            bgColor: '#fef2f2', 
            borderColor: '#fca5a5',
            sonido: 'error'
          },
          warning: { 
            icono: '鈿狅笍', 
            color: '#f59e0b', 
            bgColor: '#fffbeb', 
            borderColor: '#fcd34d',
            sonido: 'warning'
          },
          info: { 
            icono: '鈩癸笍', 
            color: '#3b82f6', 
            bgColor: '#eff6ff', 
            borderColor: '#93c5fd',
            sonido: 'info'
          },
          loading: { 
            icono: '鈴?, 
            color: '#6b7280', 
            bgColor: '#f9fafb', 
            borderColor: '#d1d5db',
            sonido: null
          }
        };

        const config = tiposToast[tipo] || tiposToast.info;

        // Crear elemento toast
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.style.cssText = `
          background: ${config.bgColor};
          color: ${config.color};
          border: 2px solid ${config.borderColor};
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 10px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
          display: flex;
          align-items: flex-start;
          gap: 12px;
          font-weight: 600;
          font-size: 14px;
          line-height: 1.4;
          transform: translateX(100%);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          pointer-events: all;
          max-width: 100%;
          word-wrap: break-word;
        `;

        // Contenido del toast
        let contenidoHTML = `
          <div style="font-size: 18px; margin-top: 2px;">${config.icono}</div>
          <div style="flex: 1;">
            <div style="margin-bottom: ${acciones ? '8px' : '0'};">${mensaje}</div>
        `;

        // Agregar botones de acci贸n si existen
        if (acciones && Array.isArray(acciones)) {
          contenidoHTML += '<div style="display: flex; gap: 8px; margin-top: 8px;">';
          acciones.forEach(accion => {
            contenidoHTML += `
              <button onclick="ejecutarAccionToast('${toastId}', ${accion.callback})" style="
                background: ${config.color};
                color: white;
                border: none;
                border-radius: 6px;
                padding: 6px 12px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
              " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                ${accion.texto}
              </button>
            `;
          });
          contenidoHTML += '</div>';
        }

        contenidoHTML += '</div>';

        // Bot贸n de cerrar
        contenidoHTML += `
          <button onclick="cerrarToast('${toastId}')" style="
            background: none;
            border: none;
            color: ${config.color};
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
          " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
            脳
          </button>
        `;

        toast.innerHTML = contenidoHTML;
        toastContainer.appendChild(toast);

        // Reproducir sonido contextual
        if (config.sonido) {
          reproducirSonidoToast(config.sonido);
        }

        // Animar entrada
        requestAnimationFrame(() => {
          toast.style.transform = 'translateX(0)';
        });

        // Auto-cerrar despu茅s de la duraci贸n especificada
        if (duracion > 0) {
          setTimeout(() => {
            cerrarToast(toastId);
          }, duracion);
        }

        // Vibraci贸n contextual
        vibrarContextual(tipo);

        return toastId;
      }

      // Funci贸n para cerrar toast espec铆fico
      function cerrarToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
          toast.style.transform = 'translateX(100%)';
          toast.style.opacity = '0';
          setTimeout(() => {
            if (toast && toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }
      }

      // Funci贸n para ejecutar acciones de toast
      function ejecutarAccionToast(toastId, callback) {
        if (typeof callback === 'function') {
          callback();
        }
        cerrarToast(toastId);
      }

      // Sistema de sonidos para toasts
      function reproducirSonidoToast(tipo) {
        if (!window.AudioContext && !window.webkitAudioContext) return;
        
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscilador = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscilador.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // Configurar frecuencias seg煤n el tipo
          const frecuencias = {
            success: [523, 659, 784], // Do-Mi-Sol (acorde mayor)
            error: [440, 415, 392],   // La-Lab-Sol (acorde menor descendente)
            warning: [659, 659],      // Mi-Mi (repetici贸n)
            info: [523]               // Do simple
          };
          
          const secuencia = frecuencias[tipo] || frecuencias.info;
          
          secuencia.forEach((freq, i) => {
            setTimeout(() => {
              const osc = audioContext.createOscillator();
              const gain = audioContext.createGain();
              
              osc.connect(gain);
              gain.connect(audioContext.destination);
              
              osc.frequency.setValueAtTime(freq, audioContext.currentTime);
              gain.gain.setValueAtTime(0.1, audioContext.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
              
              osc.start(audioContext.currentTime);
              osc.stop(audioContext.currentTime + 0.1);
            }, i * 100);
          });
        } catch (e) {
          // Silenciar errores de audio en caso de que no sea compatible
        }
      }

      // Toasts especializados para casos comunes
      function mostrarToastCargando(mensaje, duracion = 0) {
        return mostrarToast(mensaje, 'loading', duracion);
      }

      function mostrarToastExito(mensaje, duracion = 3000) {
        return mostrarToast(mensaje, 'success', duracion);
      }

      function mostrarToastError(mensaje, acciones = null, duracion = 5000) {
        return mostrarToast(mensaje, 'error', duracion, acciones);
      }

      function mostrarToastConfirmacion(mensaje, callback, duracion = 0) {
        const acciones = [
          { texto: 'Confirmar', callback: callback },
          { texto: 'Cancelar', callback: () => {} }
        ];
        return mostrarToast(mensaje, 'warning', duracion, acciones);
      }

      // =====================================
      // SISTEMA DE NOTIFICACIONES PUSH
      // =====================================

      class SistemaNotificaciones {
        constructor() {
          this.permisosConcedidos = false;
          this.intervalosActivos = new Map();
          this.notificacionesActivas = new Map();
          this.configuracion = {
            pedidosListos: { habilitado: true, sonido: true, intervalo: 30000 },
            mesasLargoTiempo: { habilitado: true, sonido: true, intervalo: 900000 }, // 15 min
            recordatoriosCierre: { habilitado: true, sonido: true, intervalo: 3600000 }, // 1 hora
            alertasCriticas: { habilitado: true, sonido: true, intervalo: 0 }
          };
          // No inicializar autom谩ticamente, se har谩 manualmente despu茅s
        }

        async inicializar() {
          // Verificar soporte de notificaciones
          if (!('Notification' in window)) {
            console.warn('馃敃 Notificaciones no soportadas en este navegador');
            return;
          }

          // No solicitar permisos autom谩ticamente para evitar mostrar mensajes al usuario
          // Las notificaciones se mantendr谩n deshabilitadas a menos que el usuario las active manualmente.
          this.permisosConcedidos = false;
          
          // Iniciar monitores autom谩ticos
          this.iniciarMonitores();
          
          console.log('馃敂 Sistema de notificaciones inicializado');
        }

        async solicitarPermisos() {
          try {
            if (Notification.permission === 'granted') {
              this.permisosConcedidos = true;
              return true;
            }

            if (Notification.permission === 'denied') {
              if (typeof mostrarToast === 'function') {
                mostrarToast('馃敃 Notificaciones bloqueadas. Act铆valas en configuraci贸n del navegador', 'warning', 5000);
              }
              return false;
            }

            // Mostrar explicaci贸n antes de solicitar permisos
            const solicitarPermisos = () => {
              Notification.requestPermission()
                .then(permission => {
                  this.permisosConcedidos = permission === 'granted';
                  if (this.permisosConcedidos) {
                    if (typeof mostrarToast === 'function') {
                      mostrarToast('馃敂 Notificaciones activadas correctamente', 'success');
                    }
                    this.enviarNotificacion('隆Perfecto!', 'Sistema de notificaciones activado', 'success');
                  } else {
                    if (typeof mostrarToast === 'function') {
                      mostrarToast('馃敃 Notificaciones rechazadas. Puedes activarlas despu茅s en configuraci贸n', 'info');
                    }
                  }
                })
                .catch(error => {
                  console.error('鉂?Error solicitando permisos de notificaci贸n:', error);
                  if (typeof mostrarToast === 'function') {
                    mostrarToast('馃敃 Error activando notificaciones', 'error');
                  }
                  this.permisosConcedidos = false;
                });
            };

            // Solicitar permisos de notificaci贸n de forma directa sin mostrar di谩logos emergentes.
            // Se elimina la alerta de confirmaci贸n para activar notificaciones y se solicita el permiso
            // inmediatamente. Esto simplifica el flujo y evita mostrar mensajes al usuario.
            solicitarPermisos();
          } catch (error) {
            console.error('鉂?Error en solicitarPermisos:', error);
            this.permisosConcedidos = false;
            return false;
          }
        }

        enviarNotificacion(titulo, mensaje, tipo = 'info', acciones = null) {
          if (!this.permisosConcedidos) return null;

          const iconos = {
            success: '鉁?,
            error: '鉂?,
            warning: '鈿狅笍',
            info: '鈩癸笍',
            pedido: '馃崝',
            mesa: '馃獞',
            tiempo: '鈴?
          };

          const opciones = {
            body: mensaje,
            icon: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>${iconos[tipo] || iconos.info}</text></svg>`,
            badge: `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>馃崝</text></svg>`,
            tag: tipo + '-' + Date.now(),
            requireInteraction: tipo === 'error' || tipo === 'warning',
            silent: false,
            vibrate: [200, 100, 200],
            data: { tipo, acciones, timestamp: Date.now() }
          };

          try {
            const notificacion = new Notification(titulo, opciones);
            
            // Auto-cerrar despu茅s de tiempo determinado (excepto cr铆ticas)
            if (tipo !== 'error' && tipo !== 'warning') {
              setTimeout(() => {
                notificacion.close();
              }, 8000);
            }

            // Manejar clics en la notificaci贸n
            notificacion.onclick = () => {
              window.focus();
              notificacion.close();
              
              // Ejecutar acciones espec铆ficas seg煤n el tipo
              this.manejarClicNotificacion(tipo, opciones.data);
            };

            // Registrar notificaci贸n activa
            this.notificacionesActivas.set(opciones.tag, notificacion);
            
            return notificacion;
          } catch (error) {
            console.error('Error al enviar notificaci贸n:', error);
            // Fallback a toast si las notificaciones fallan
            mostrarToast(`${titulo}: ${mensaje}`, tipo);
            return null;
          }
        }

        manejarClicNotificacion(tipo, data) {
          switch(tipo) {
            case 'pedido':
              // Abrir vista de pedidos pendientes
              nuevoPedidoParaLlevar();
              break;
            case 'mesa':
              // Mostrar mesas con tiempo largo
              this.mostrarMesasLargoTiempo();
              break;
            case 'tiempo':
              // Abrir estad铆sticas
              actualizarEstadisticas();
              break;
            default:
              // Simplemente enfocar la ventana
              vibrarContextual('tap');
          }
        }

        iniciarMonitores() {
          // Monitor de pedidos pendientes (cada 30 segundos)
          this.intervalosActivos.set('pedidos', setInterval(() => {
            this.verificarPedidosPendientes();
          }, this.configuracion.pedidosListos.intervalo));

          // Monitor de mesas con tiempo largo (cada 15 minutos)
          this.intervalosActivos.set('mesas', setInterval(() => {
            this.verificarMesasLargoTiempo();
          }, this.configuracion.mesasLargoTiempo.intervalo));

          // Monitor de recordatorios de cierre (cada hora)
          this.intervalosActivos.set('cierre', setInterval(() => {
            this.verificarRecordatoriosCierre();
          }, this.configuracion.recordatoriosCierre.intervalo));
        }

        verificarPedidosPendientes() {
          if (!this.configuracion.pedidosListos.habilitado) return;

          const pedidosPendientes = estado.pedidos.filter(p => !p.entregado);
          const pedidosListos = pedidosPendientes.filter(p => {
            const tiempoEspera = (Date.now() - new Date(p.fechaHora)) / 60000; // minutos
            return tiempoEspera >= 10; // Pedidos con m谩s de 10 minutos
          });

          if (pedidosListos.length > 0) {
            const mensaje = pedidosListos.length === 1 
              ? `Pedido de ${pedidosListos[0].nombreCliente} lleva ${Math.round((Date.now() - new Date(pedidosListos[0].fechaHora)) / 60000)} min esperando`
              : `${pedidosListos.length} pedidos pendientes de entrega`;

            this.enviarNotificacion(
              '馃崝 Pedidos Listos',
              mensaje,
              'pedido'
            );
          }
        }

        verificarMesasLargoTiempo() {
          if (!this.configuracion.mesasLargoTiempo.habilitado) return;

          const mesasLargoTiempo = Array.from(estado.mesas.values()).filter(mesa => {
            if (mesa.estado !== 'ocupada') return false;
            const tiempoOcupacion = (Date.now() - new Date(mesa.horaOcupacion)) / 60000; // minutos
            return tiempoOcupacion >= 90; // Mesas ocupadas m谩s de 1.5 horas
          });

          if (mesasLargoTiempo.length > 0) {
            const mensaje = mesasLargoTiempo.length === 1
              ? `Mesa ${mesasLargoTiempo[0].numero} lleva ${Math.round((Date.now() - new Date(mesasLargoTiempo[0].horaOcupacion)) / 60000)} min ocupada`
              : `${mesasLargoTiempo.length} mesas ocupadas desde hace mucho tiempo`;

            this.enviarNotificacion(
              '鈴?Mesas Largo Tiempo',
              mensaje,
              'mesa'
            );
          }
        }

        verificarRecordatoriosCierre() {
          if (!this.configuracion.recordatoriosCierre.habilitado) return;

          const ahora = new Date();
          const horaActual = ahora.getHours();
          
          // Recordatorio 1 hora antes del cierre t铆pico (asumiendo cierre a 00:00)
          if (horaActual === 23) {
            const mesasOcupadas = Array.from(estado.mesas.values()).filter(m => m.estado === 'ocupada').length;
            const pedidosPendientes = estado.pedidos.filter(p => !p.entregado).length;
            
            if (mesasOcupadas > 0 || pedidosPendientes > 0) {
              this.enviarNotificacion(
                '馃暁 Recordatorio de Cierre',
                `Quedan ${mesasOcupadas} mesas ocupadas y ${pedidosPendientes} pedidos pendientes`,
                'tiempo'
              );
            }
          }
        }

        mostrarMesasLargoTiempo() {
          const mesasLargoTiempo = Array.from(estado.mesas.values()).filter(mesa => {
            if (mesa.estado !== 'ocupada') return false;
            const tiempoOcupacion = (Date.now() - new Date(mesa.horaOcupacion)) / 60000;
            return tiempoOcupacion >= 90;
          });

          if (mesasLargoTiempo.length === 0) {
            mostrarToastExito('鉁?No hay mesas con tiempo excesivo de ocupaci贸n');
            return;
          }

          const lista = mesasLargoTiempo.map(mesa => {
            const tiempo = calcularTiempoOcupacion(mesa.horaOcupacion);
            return `Mesa ${mesa.numero}: ${tiempo}`;
          }).join('\n');

          mostrarToast(`鈴?Mesas con largo tiempo:\n${lista}`, 'warning', 8000);
        }

        // M茅todos para configuraci贸n
        configurarNotificaciones(tipo, configuracion) {
          if (this.configuracion[tipo]) {
            Object.assign(this.configuracion[tipo], configuracion);
            localStorage.setItem('notificaciones-config', JSON.stringify(this.configuracion));
          }
        }

        desactivarTodo() {
          this.intervalosActivos.forEach((intervalo, key) => {
            clearInterval(intervalo);
          });
          this.intervalosActivos.clear();
          
          this.notificacionesActivas.forEach((notif, key) => {
            notif.close();
          });
          this.notificacionesActivas.clear();
        }
      }

      // Instancia global del sistema de notificaciones
      const sistemaNotificaciones = new SistemaNotificaciones();

      // Inicializar notificaciones despu茅s de un breve delay
      setTimeout(() => {
        try {
          sistemaNotificaciones.inicializar();
          console.log('馃敂 Sistema de notificaciones inicializado');
        } catch (error) {
          console.warn('鈿狅笍 Error inicializando notificaciones:', error);
        }
      }, 2000);

      // Funciones de conveniencia para usar en el c贸digo
      function notificarPedidoListo(pedido) {
        sistemaNotificaciones.enviarNotificacion(
          '馃崝 Pedido Listo',
          `Pedido de ${pedido.nombreCliente} - Mesa ${pedido.mesa}`,
          'pedido'
        );
      }

      function notificarError(mensaje) {
        sistemaNotificaciones.enviarNotificacion(
          '鉂?Error del Sistema',
          mensaje,
          'error'
        );
      }

      function notificarAdvertencia(mensaje) {
        sistemaNotificaciones.enviarNotificacion(
          '鈿狅笍 Advertencia',
          mensaje,
          'warning'
        );
      }

      // =====================================
      // SISTEMA DE LOGS Y DEPURACI脫N
      // =====================================

      class SistemaLogs {
        constructor() {
          this.logs = [];
          this.maxLogs = 1000;
          this.niveles = {
            DEBUG: { valor: 0, color: '#6b7280', icono: '馃悰' },
            INFO: { valor: 1, color: '#3b82f6', icono: '鈩癸笍' },
            WARN: { valor: 2, color: '#f59e0b', icono: '鈿狅笍' },
            ERROR: { valor: 3, color: '#ef4444', icono: '鉂? },
            CRITICAL: { valor: 4, color: '#dc2626', icono: '馃毃' }
          };
          this.nivelActual = 1; // INFO por defecto
          this.almacenamientoActivo = true;
          this.cargarLogsGuardados();
          this.inicializar();
        }

        inicializar() {
          // Interceptar errores globales
          this.interceptarErrores();
          
          // Cargar configuraci贸n guardada
          this.cargarConfiguracion();
          
          // Log inicial
          this.info('Sistema de logs inicializado', { timestamp: new Date(), version: 'v9.0' });
          
          console.log('馃搵 Sistema de logs iniciado');
        }

        interceptarErrores() {
          // Interceptar errores de JavaScript
          window.addEventListener('error', (event) => {
            this.error('Error de JavaScript', {
              mensaje: event.message,
              archivo: event.filename,
              linea: event.lineno,
              columna: event.colno,
              stack: event.error?.stack
            });
          });

          // Interceptar promesas rechazadas
          window.addEventListener('unhandledrejection', (event) => {
            this.error('Promesa rechazada no manejada', {
              razon: event.reason,
              stack: event.reason?.stack
            });
          });

          // Interceptar errores de recursos
          window.addEventListener('error', (event) => {
            if (event.target !== window) {
              this.warn('Error al cargar recurso', {
                elemento: event.target.tagName,
                fuente: event.target.src || event.target.href,
                tipo: event.target.type
              });
            }
          }, true);
        }

        log(nivel, mensaje, datos = null) {
          const timestamp = new Date();
          const nivelInfo = this.niveles[nivel] || this.niveles.INFO;
          
          // Verificar si el nivel es suficiente para ser registrado
          if (nivelInfo.valor < this.nivelActual) return;

          const entrada = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            timestamp,
            nivel,
            mensaje,
            datos,
            url: window.location.href,
            userAgent: navigator.userAgent.substring(0, 100) // Limitado para no ocupar mucho espacio
          };

          // Agregar al array de logs
          this.logs.unshift(entrada);
          
          // Mantener el l铆mite de logs
          if (this.logs.length > this.maxLogs) {
            this.logs = this.logs.slice(0, this.maxLogs);
          }

          // Guardar en localStorage si est谩 activo
          if (this.almacenamientoActivo) {
            this.guardarLogs();
          }

          // Log en consola con formato
          this.logEnConsola(entrada);

          // Enviar a sistema de notificaciones si es cr铆tico
          if (nivel === 'ERROR' || nivel === 'CRITICAL') {
            this.enviarNotificacionError(entrada);
          }

          return entrada;
        }

        logEnConsola(entrada) {
          const nivelInfo = this.niveles[entrada.nivel];
          const tiempo = entrada.timestamp.toLocaleTimeString();
          const estilo = `color: ${nivelInfo.color}; font-weight: bold;`;
          
          const args = [
            `%c${nivelInfo.icono} [${tiempo}] ${entrada.nivel}:`,
            estilo,
            entrada.mensaje
          ];

          if (entrada.datos) {
            args.push('\n馃搵 Datos:', entrada.datos);
          }

          console.log(...args);
        }

        enviarNotificacionError(entrada) {
          if (entrada.nivel === 'CRITICAL') {
            notificarError(`Error cr铆tico: ${entrada.mensaje}`);
          } else if (entrada.nivel === 'ERROR') {
            // Solo notificar errores cada 5 minutos para evitar spam
            const ultimoError = this.logs.find(log => 
              log.nivel === 'ERROR' && 
              log.id !== entrada.id &&
              (Date.now() - new Date(log.timestamp)) < 300000
            );
            
            if (!ultimoError) {
              setTimeout(() => {
                mostrarToastError(`Error: ${entrada.mensaje}`, [
                  { texto: 'Ver Detalles', callback: () => this.mostrarDetallesError(entrada.id) }
                ]);
              }, 100);
            }
          }
        }

        // M茅todos de conveniencia para cada nivel
        debug(mensaje, datos = null) { return this.log('DEBUG', mensaje, datos); }
        info(mensaje, datos = null) { return this.log('INFO', mensaje, datos); }
        warn(mensaje, datos = null) { return this.log('WARN', mensaje, datos); }
        error(mensaje, datos = null) { return this.log('ERROR', mensaje, datos); }
        critical(mensaje, datos = null) { return this.log('CRITICAL', mensaje, datos); }

        // Funciones de gesti贸n de logs
        obtenerLogs(filtros = {}) {
          let logsFiltered = [...this.logs];

          if (filtros.nivel) {
            const nivelMinimo = this.niveles[filtros.nivel]?.valor || 0;
            logsFiltered = logsFiltered.filter(log => 
              this.niveles[log.nivel].valor >= nivelMinimo
            );
          }

          if (filtros.desde) {
            logsFiltered = logsFiltered.filter(log => 
              new Date(log.timestamp) >= new Date(filtros.desde)
            );
          }

          if (filtros.hasta) {
            logsFiltered = logsFiltered.filter(log => 
              new Date(log.timestamp) <= new Date(filtros.hasta)
            );
          }

          if (filtros.busqueda) {
            const termino = filtros.busqueda.toLowerCase();
            logsFiltered = logsFiltered.filter(log => 
              log.mensaje.toLowerCase().includes(termino) ||
              JSON.stringify(log.datos).toLowerCase().includes(termino)
            );
          }

          return logsFiltered;
        }

        exportarLogs(formato = 'json', filtros = {}) {
          const logs = this.obtenerLogs(filtros);
          
          if (formato === 'json') {
            return JSON.stringify(logs, null, 2);
          } else if (formato === 'csv') {
            const headers = 'Timestamp,Nivel,Mensaje,Datos\n';
            const filas = logs.map(log => 
              `"${log.timestamp}","${log.nivel}","${log.mensaje}","${JSON.stringify(log.datos || '')}"`
            ).join('\n');
            return headers + filas;
          } else if (formato === 'txt') {
            return logs.map(log => {
              const tiempo = new Date(log.timestamp).toLocaleString();
              const datos = log.datos ? `\nDatos: ${JSON.stringify(log.datos, null, 2)}` : '';
              return `[${tiempo}] ${log.nivel}: ${log.mensaje}${datos}`;
            }).join('\n\n');
          }
        }

        descargarLogs(formato = 'json', filtros = {}) {
          const contenido = this.exportarLogs(formato, filtros);
          const fecha = new Date().toISOString().split('T')[0];
          const nombreArchivo = `diner-logs-${fecha}.${formato}`;
          
          const blob = new Blob([contenido], { 
            type: formato === 'json' ? 'application/json' : 'text/plain' 
          });
          
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = nombreArchivo;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.info(`Logs exportados como ${nombreArchivo}`, { 
            formato, 
            cantidad: this.obtenerLogs(filtros).length,
            filtros 
          });
        }

        mostrarVisorLogs() {
          const modal = document.getElementById('modal');
          const content = document.querySelector('.modal-content');
          
          modal.classList.add('show');
          content.innerHTML = `
            <div class="header">
              <h1>馃搵 Visor de Logs del Sistema</h1>
              <button onclick="cerrarModal()" class="close-btn">脳</button>
            </div>
            
            <div style="padding: 20px;">
              <!-- Controles -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <select id="log-nivel-filtro" onchange="sistemaLogs.filtrarLogsVisor()">
                  <option value="">Todos los niveles</option>
                  <option value="DEBUG">馃悰 Debug</option>
                  <option value="INFO">鈩癸笍 Info</option>
                  <option value="WARN">鈿狅笍 Advertencias</option>
                  <option value="ERROR">鉂?Errores</option>
                  <option value="CRITICAL">馃毃 Cr铆ticos</option>
                </select>
                
                <input type="text" id="log-busqueda" placeholder="Buscar en logs..." 
                       onchange="sistemaLogs.filtrarLogsVisor()" style="padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
                
                <button onclick="sistemaLogs.limpiarLogs()" style="background: var(--c-brand); color: white; border: none; border-radius: 8px; padding: 8px 16px;">
                  馃棏锔?Limpiar
                </button>
                
                <button onclick="sistemaLogs.descargarLogs('json')" style="background: var(--c-accent); color: white; border: none; border-radius: 8px; padding: 8px 16px;">
                  馃摜 Exportar JSON
                </button>
              </div>
              
              <!-- Lista de logs -->
              <div id="logs-lista" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                ${this.generarHTMLLogs()}
              </div>
              
              <!-- Estad铆sticas -->
              <div style="margin-top: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 14px;">
                <strong>馃搳 Estad铆sticas:</strong> 
                Total: ${this.logs.length} logs | 
                Errores: ${this.logs.filter(l => l.nivel === 'ERROR').length} | 
                Advertencias: ${this.logs.filter(l => l.nivel === 'WARN').length} |
                Memoria usada: ~${Math.round(JSON.stringify(this.logs).length / 1024)}KB
              </div>
            </div>
          `;
        }

        generarHTMLLogs(filtros = {}) {
          const logs = this.obtenerLogs(filtros);
          
          if (logs.length === 0) {
            return '<div style="text-align: center; padding: 40px; color: #6b7280;">No hay logs que mostrar</div>';
          }

          return logs.map(log => {
            const nivelInfo = this.niveles[log.nivel];
            const tiempo = new Date(log.timestamp).toLocaleString();
            const datos = log.datos ? `<pre style="margin-top: 8px; font-size: 12px; background: #f3f4f6; padding: 8px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(log.datos, null, 2)}</pre>` : '';
            
            return `
              <div style="border-bottom: 1px solid #e5e7eb; padding: 12px; cursor: pointer;" onclick="sistemaLogs.mostrarDetallesError('${log.id}')">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="color: ${nivelInfo.color}; font-weight: bold;">${nivelInfo.icono} ${log.nivel}</span>
                  <span style="color: #6b7280; font-size: 12px;">${tiempo}</span>
                </div>
                <div style="margin-left: 20px; color: #374151;">${log.mensaje}</div>
                ${datos}
              </div>
            `;
          }).join('');
        }

        filtrarLogsVisor() {
          const nivel = document.getElementById('log-nivel-filtro')?.value;
          const busqueda = document.getElementById('log-busqueda')?.value;
          
          const filtros = {};
          if (nivel) filtros.nivel = nivel;
          if (busqueda) filtros.busqueda = busqueda;
          
          document.getElementById('logs-lista').innerHTML = this.generarHTMLLogs(filtros);
        }

        mostrarDetallesError(logId) {
          const log = this.logs.find(l => l.id === logId);
          if (!log) return;

          const tiempo = new Date(log.timestamp).toLocaleString();
          const nivelInfo = this.niveles[log.nivel];
          
          mostrarToast(`
            ${nivelInfo.icono} ${log.nivel} - ${tiempo}
            ${log.mensaje}
            ${log.datos ? `\nDetalles: ${JSON.stringify(log.datos, null, 2)}` : ''}
          `, log.nivel.toLowerCase(), 0);
        }

        limpiarLogs() {
          if (confirm('驴Est谩s seguro de que quieres limpiar todos los logs?')) {
            this.logs = [];
            this.guardarLogs();
            this.info('Logs limpiados por el usuario');
            
            // Actualizar visor si est谩 abierto
            if (document.getElementById('logs-lista')) {
              this.mostrarVisorLogs();
            }
            
            mostrarToastExito('馃棏锔?Logs limpiados correctamente');
          }
        }

        // Gesti贸n de almacenamiento
        guardarLogs() {
          try {
            const logsParaGuardar = this.logs.slice(0, 500); // Solo guardar los 500 m谩s recientes
            localStorage.setItem('sistema-logs', JSON.stringify(logsParaGuardar));
          } catch (error) {
            console.warn('No se pudieron guardar los logs:', error);
          }
        }

        cargarLogsGuardados() {
          try {
            const logsGuardados = localStorage.getItem('sistema-logs');
            if (logsGuardados) {
              this.logs = JSON.parse(logsGuardados);
            }
          } catch (error) {
            console.warn('No se pudieron cargar los logs guardados:', error);
            this.logs = [];
          }
        }

        cargarConfiguracion() {
          try {
            const config = localStorage.getItem('logs-config');
            if (config) {
              const configObj = JSON.parse(config);
              this.nivelActual = configObj.nivelActual || 1;
              this.almacenamientoActivo = configObj.almacenamientoActivo !== false;
            }
          } catch (error) {
            console.warn('No se pudo cargar la configuraci贸n de logs:', error);
          }
        }

        guardarConfiguracion() {
          const config = {
            nivelActual: this.nivelActual,
            almacenamientoActivo: this.almacenamientoActivo
          };
          localStorage.setItem('logs-config', JSON.stringify(config));
        }

        // Configuraci贸n
        establecerNivel(nivel) {
          if (this.niveles[nivel]) {
            this.nivelActual = this.niveles[nivel].valor;
            this.guardarConfiguracion();
            this.info(`Nivel de logs cambiado a ${nivel}`);
          }
        }

        toggleAlmacenamiento(activo) {
          this.almacenamientoActivo = activo;
          this.guardarConfiguracion();
          this.info(`Almacenamiento de logs ${activo ? 'activado' : 'desactivado'}`);
        }
      }

      // Instancia global del sistema de logs
      const sistemaLogs = new SistemaLogs();

      // Funciones de conveniencia para usar en todo el c贸digo
      function logDebug(mensaje, datos) { return sistemaLogs.debug(mensaje, datos); }
      function logInfo(mensaje, datos) { return sistemaLogs.info(mensaje, datos); }
      function logWarn(mensaje, datos) { return sistemaLogs.warn(mensaje, datos); }
      function logError(mensaje, datos) { return sistemaLogs.error(mensaje, datos); }
      function logCritical(mensaje, datos) { return sistemaLogs.critical(mensaje, datos); }

      // Objeto logs global para compatibilidad
      const logs = {
        debug: (categoria, mensaje, datos) => sistemaLogs.debug(`[${categoria}] ${mensaje}`, datos),
        info: (categoria, mensaje, datos) => sistemaLogs.info(`[${categoria}] ${mensaje}`, datos),
        warn: (categoria, mensaje, datos) => sistemaLogs.warn(`[${categoria}] ${mensaje}`, datos),
        error: (categoria, mensaje, datos) => sistemaLogs.error(`[${categoria}] ${mensaje}`, datos),
        critical: (categoria, mensaje, datos) => sistemaLogs.critical(`[${categoria}] ${mensaje}`, datos)
      };

      // =====================================
      // SISTEMA DE ANALYTICS Y M脡TRICAS
      // =====================================

      class SistemaAnalytics {
        constructor() {
          this.eventos = JSON.parse(localStorage.getItem('analytics_eventos') || '[]');
          this.metricas = JSON.parse(localStorage.getItem('analytics_metricas') || '{}');
          this.sesionActual = {
            inicio: new Date(),
            eventos: [],
            ventasTotal: 0,
            productosVendidos: 0
          };
          this.inicializar();
        }

        inicializar() {
          this.inicializarMetricas();
          this.configurarCapturadores();
          this.iniciarSesion();
          logs.info('Analytics', 'Sistema de analytics inicializado');
        }

        inicializarMetricas() {
          if (!this.metricas.resumen) {
            this.metricas = {
              resumen: {
                totalVentas: 0,
                totalProductos: 0,
                ventasHoy: 0,
                sesionesTotales: 0,
                tiempoPromedioSesion: 0
              },
              productos: {},
              horarios: {},
              errores: {},
              rendimiento: {
                tiemposCarga: [],
                erroresTotales: 0,
                crashesTotales: 0
              },
              patrones: {
                horasPico: {},
                diasSemana: {},
                productosPopulares: {}
              }
            };
          }
        }

        capturarEvento(tipo, datos = {}) {
          const evento = {
            id: Date.now() + Math.random(),
            tipo,
            timestamp: new Date(),
            datos,
            sesion: this.sesionActual.inicio.getTime()
          };

          this.eventos.push(evento);
          this.sesionActual.eventos.push(evento);
          this.procesarEvento(evento);
          this.guardarDatos();

          // Mantener solo los 煤ltimos 1000 eventos
          if (this.eventos.length > 1000) {
            this.eventos = this.eventos.slice(-1000);
          }
        }

        procesarEvento(evento) {
          const hora = evento.timestamp.getHours();
          const dia = evento.timestamp.getDay();

          switch (evento.tipo) {
            case 'venta':
              this.procesarVenta(evento);
              break;
            case 'navegacion':
              this.procesarNavegacion(evento);
              break;
            case 'error':
              this.procesarError(evento);
              break;
            case 'rendimiento':
              this.procesarRendimiento(evento);
              break;
          }

          // Actualizar patrones de uso
          this.metricas.patrones.horasPico[hora] = (this.metricas.patrones.horasPico[hora] || 0) + 1;
          this.metricas.patrones.diasSemana[dia] = (this.metricas.patrones.diasSemana[dia] || 0) + 1;
        }

        procesarVenta(evento) {
          const { productos, total, mesa } = evento.datos;
          
          this.metricas.resumen.totalVentas += total;
          this.metricas.resumen.totalProductos += productos.length;
          this.sesionActual.ventasTotal += total;
          this.sesionActual.productosVendidos += productos.length;

          // Actualizar productos populares
          productos.forEach(producto => {
            const nombre = producto.nombre;
            if (!this.metricas.productos[nombre]) {
              this.metricas.productos[nombre] = {
                vendidos: 0,
                ingresos: 0,
                ultimaVenta: null
              };
            }
            this.metricas.productos[nombre].vendidos += producto.cantidad;
            this.metricas.productos[nombre].ingresos += producto.precio * producto.cantidad;
            this.metricas.productos[nombre].ultimaVenta = new Date();
          });

          // Actualizar ventas por horario
          const hora = evento.timestamp.getHours();
          if (!this.metricas.horarios[hora]) {
            this.metricas.horarios[hora] = { ventas: 0, ingresos: 0 };
          }
          this.metricas.horarios[hora].ventas++;
          this.metricas.horarios[hora].ingresos += total;
        }

        procesarNavegacion(evento) {
          // Procesar datos de navegaci贸n y tiempo en p谩ginas
        }

        procesarError(evento) {
          const tipo = evento.datos.tipo || 'desconocido';
          this.metricas.errores[tipo] = (this.metricas.errores[tipo] || 0) + 1;
          this.metricas.rendimiento.erroresTotales++;
        }

        procesarRendimiento(evento) {
          if (evento.datos.tiempoCarga) {
            this.metricas.rendimiento.tiemposCarga.push(evento.datos.tiempoCarga);
            // Mantener solo los 煤ltimos 100 tiempos
            if (this.metricas.rendimiento.tiemposCarga.length > 100) {
              this.metricas.rendimiento.tiemposCarga = 
                this.metricas.rendimiento.tiemposCarga.slice(-100);
            }
          }
        }

        configurarCapturadores() {
          // Capturar errores globales
          window.addEventListener('error', (e) => {
            this.capturarEvento('error', {
              tipo: 'javascript',
              mensaje: e.message,
              archivo: e.filename,
              linea: e.lineno
            });
          });

          // Capturar errores de promesas
          window.addEventListener('unhandledrejection', (e) => {
            this.capturarEvento('error', {
              tipo: 'promise',
              mensaje: e.reason
            });
          });

          // Capturar tiempo de carga
          window.addEventListener('load', () => {
            const tiempoCarga = performance.timing.loadEventEnd - performance.timing.navigationStart;
            this.capturarEvento('rendimiento', { tiempoCarga });
          });
        }

        iniciarSesion() {
          this.metricas.resumen.sesionesTotales++;
          this.capturarEvento('sesion', { accion: 'inicio' });
        }

        finalizarSesion() {
          const duracion = new Date() - this.sesionActual.inicio;
          this.capturarEvento('sesion', { 
            accion: 'fin', 
            duracion,
            ventasTotal: this.sesionActual.ventasTotal,
            productosVendidos: this.sesionActual.productosVendidos
          });

          // Actualizar tiempo promedio de sesi贸n
          const sesionesTotales = this.metricas.resumen.sesionesTotales;
          const tiempoAnterior = this.metricas.resumen.tiempoPromedioSesion;
          this.metricas.resumen.tiempoPromedioSesion = 
            ((tiempoAnterior * (sesionesTotales - 1)) + duracion) / sesionesTotales;

          this.guardarDatos();
        }

        obtenerReporte(periodo = 'hoy') {
          const ahora = new Date();
          let filtroFecha;

          switch (periodo) {
            case 'hoy':
              filtroFecha = (fecha) => {
                const f = new Date(fecha);
                return f.toDateString() === ahora.toDateString();
              };
              break;
            case 'semana':
              filtroFecha = (fecha) => {
                const f = new Date(fecha);
                const hace7dias = new Date(ahora - 7 * 24 * 60 * 60 * 1000);
                return f >= hace7dias;
              };
              break;
            case 'mes':
              filtroFecha = (fecha) => {
                const f = new Date(fecha);
                return f.getMonth() === ahora.getMonth() && f.getFullYear() === ahora.getFullYear();
              };
              break;
            default:
              filtroFecha = () => true;
          }

          const eventosFiltrados = this.eventos.filter(e => filtroFecha(e.timestamp));
          
          return {
            periodo,
            totalEventos: eventosFiltrados.length,
            ventas: this.calcularVentas(eventosFiltrados),
            productos: this.calcularProductosPopulares(eventosFiltrados),
            horarios: this.calcularHorariosPico(eventosFiltrados),
            errores: this.calcularErrores(eventosFiltrados),
            rendimiento: this.calcularRendimiento(eventosFiltrados)
          };
        }

        calcularVentas(eventos) {
          const ventasEventos = eventos.filter(e => e.tipo === 'venta');
          const total = ventasEventos.reduce((sum, e) => sum + (e.datos.total || 0), 0);
          const cantidad = ventasEventos.length;
          
          return {
            total,
            cantidad,
            promedio: cantidad > 0 ? total / cantidad : 0
          };
        }

        calcularProductosPopulares(eventos) {
          const productos = {};
          eventos.filter(e => e.tipo === 'venta').forEach(evento => {
            evento.datos.productos?.forEach(producto => {
              const nombre = producto.nombre;
              if (!productos[nombre]) {
                productos[nombre] = { cantidad: 0, ingresos: 0 };
              }
              productos[nombre].cantidad += producto.cantidad;
              productos[nombre].ingresos += producto.precio * producto.cantidad;
            });
          });

          return Object.entries(productos)
            .sort((a, b) => b[1].cantidad - a[1].cantidad)
            .slice(0, 10);
        }

        calcularHorariosPico(eventos) {
          const horarios = {};
          eventos.forEach(evento => {
            const hora = new Date(evento.timestamp).getHours();
            horarios[hora] = (horarios[hora] || 0) + 1;
          });

          return Object.entries(horarios)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        }

        calcularErrores(eventos) {
          const errores = eventos.filter(e => e.tipo === 'error');
          return {
            total: errores.length,
            tipos: errores.reduce((acc, e) => {
              const tipo = e.datos.tipo || 'desconocido';
              acc[tipo] = (acc[tipo] || 0) + 1;
              return acc;
            }, {})
          };
        }

        calcularRendimiento(eventos) {
          const rendimiento = eventos.filter(e => e.tipo === 'rendimiento');
          const tiemposCarga = rendimiento
            .map(e => e.datos.tiempoCarga)
            .filter(t => t !== undefined);

          return {
            tiempoCargaPromedio: tiemposCarga.length > 0 ? 
              tiemposCarga.reduce((sum, t) => sum + t, 0) / tiemposCarga.length : 0,
            medicionesCarga: tiemposCarga.length
          };
        }

        exportarDatos() {
          const datos = {
            eventos: this.eventos,
            metricas: this.metricas,
            exportado: new Date(),
            version: '1.0'
          };

          const blob = new Blob([JSON.stringify(datos, null, 2)], { 
            type: 'application/json' 
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `analytics_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);

          mostrarToastExito('Datos de analytics exportados correctamente');
        }

        limpiarDatos() {
          if (confirm('驴Est谩s seguro de que quieres limpiar todos los datos de analytics?')) {
            this.eventos = [];
            this.metricas = {};
            this.inicializarMetricas();
            this.guardarDatos();
            mostrarToastExito('Datos de analytics limpiados');
          }
        }

        guardarDatos() {
          localStorage.setItem('analytics_eventos', JSON.stringify(this.eventos));
          localStorage.setItem('analytics_metricas', JSON.stringify(this.metricas));
        }
      }

      // =====================================
      // SISTEMA DE REPORTES AUTOM脕TICOS
      // =====================================

      class SistemaReportes {
        constructor() {
          this.configuracion = JSON.parse(localStorage.getItem('reportes_config') || '{}');
          this.reportesProgramados = new Map();
          this.alertas = [];
          this.inicializar();
        }

        inicializar() {
          this.configurarReportesPorDefecto();
          this.iniciarMonitoreoAutomatico();
          logs.info('Reportes', 'Sistema de reportes autom谩ticos inicializado');
        }

        configurarReportesPorDefecto() {
          if (!this.configuracion.reporteDiario) {
            this.configuracion = {
              reporteDiario: {
                activo: true,
                hora: '23:30',
                incluir: ['ventas', 'productos', 'errores']
              },
              reporteSemanal: {
                activo: true,
                dia: 'domingo',
                hora: '20:00',
                incluir: ['resumen', 'tendencias', 'comparativas']
              },
              reporteMensual: {
                activo: true,
                dia: 1,
                hora: '09:00',
                incluir: ['completo', 'analytics', 'recomendaciones']
              },
              alertas: {
                ventasBajas: { activo: true, umbral: 50 },
                erroresAltos: { activo: true, umbral: 5 },
                tiempoRespuestaAlto: { activo: true, umbral: 3000 }
              }
            };
            this.guardarConfiguracion();
          }
        }

        iniciarMonitoreoAutomatico() {
          // Monitoreo cada 30 minutos
          setInterval(() => {
            this.verificarAlertas();
            this.verificarReportesPendientes();
          }, 30 * 60 * 1000);

          // Primera verificaci贸n inmediata
          setTimeout(() => {
            this.verificarAlertas();
          }, 5000);
        }

        verificarAlertas() {
          console.log('[SistemaLogs] Verificando alertas...');
          
          // Verificar si analytics est谩 disponible
          if (typeof analytics === 'undefined' || !analytics) {
            console.warn('[SistemaLogs] Analytics no est谩 disponible para verificar alertas');
            return;
          }
          
          try {
            const reporteHoy = analytics.obtenerReporte('hoy');
            console.log('[SistemaLogs] Reporte obtenido:', reporteHoy);
            const config = this.configuracion.alertas;

          // Alerta de ventas bajas
          if (config.ventasBajas.activo && reporteHoy.ventas.total < config.ventasBajas.umbral) {
            this.enviarAlerta('ventas_bajas', `鈿狅笍 Ventas bajas hoy: 鈧?{reporteHoy.ventas.total.toFixed(2)} (umbral: 鈧?{config.ventasBajas.umbral})`);
          }

          // Alerta de errores altos
          if (config.erroresAltos.activo && reporteHoy.errores.total >= config.erroresAltos.umbral) {
            this.enviarAlerta('errores_altos', `馃毃 Alto n煤mero de errores: ${reporteHoy.errores.total} (umbral: ${config.erroresAltos.umbral})`);
          }

          // Alerta de tiempo de respuesta alto
          if (config.tiempoRespuestaAlto.activo && reporteHoy.rendimiento.tiempoCargaPromedio > config.tiempoRespuestaAlto.umbral) {
            this.enviarAlerta('rendimiento_bajo', `鈴憋笍 Tiempo de carga alto: ${reporteHoy.rendimiento.tiempoCargaPromedio.toFixed(0)}ms (umbral: ${config.tiempoRespuestaAlto.umbral}ms)`);
          }
          
          } catch (error) {
            console.error('[SistemaLogs] Error al verificar alertas:', error);
          }
        }

        verificarReportesPendientes() {
          const ahora = new Date();
          const config = this.configuracion;

          // Verificar reporte diario
          if (config.reporteDiario.activo) {
            const [hora, minuto] = config.reporteDiario.hora.split(':');
            if (ahora.getHours() == hora && ahora.getMinutes() == minuto) {
              this.generarReporteDiario();
            }
          }

          // Verificar reporte semanal
          if (config.reporteSemanal.activo) {
            const diasSemana = ['domingo', 'lunes', 'martes', 'mi茅rcoles', 'jueves', 'viernes', 's谩bado'];
            const diaActual = diasSemana[ahora.getDay()];
            const [hora, minuto] = config.reporteSemanal.hora.split(':');
            
            if (diaActual === config.reporteSemanal.dia && ahora.getHours() == hora && ahora.getMinutes() == minuto) {
              this.generarReporteSemanal();
            }
          }

          // Verificar reporte mensual
          if (config.reporteMensual.activo) {
            const [hora, minuto] = config.reporteMensual.hora.split(':');
            if (ahora.getDate() === config.reporteMensual.dia && ahora.getHours() == hora && ahora.getMinutes() == minuto) {
              this.generarReporteMensual();
            }
          }
        }

        generarReporteDiario() {
          console.log('[SistemaLogs] Generando reporte diario...');
          
          // Verificar si analytics est谩 disponible
          if (typeof analytics === 'undefined' || !analytics) {
            console.warn('[SistemaLogs] Analytics no est谩 disponible para generar reporte diario');
            return;
          }
          
          try {
            const reporte = analytics.obtenerReporte('hoy');
            console.log('[SistemaLogs] Reporte diario obtenido:', reporte);
            const fecha = new Date().toISOString().split('T')[0];
          
          const contenido = `
            馃搳 REPORTE DIARIO - ${fecha}
            
            馃挵 VENTAS:
            - Total: 鈧?{reporte.ventas.total.toFixed(2)}
            - Pedidos: ${reporte.ventas.cantidad}
            - Ticket promedio: 鈧?{reporte.ventas.promedio.toFixed(2)}
            
            馃弳 PRODUCTOS M脕S VENDIDOS:
            ${reporte.productos.slice(0, 3).map(p => `- ${p[0]}: ${p[1].cantidad} unidades`).join('\\n')}
            
            鈿?RENDIMIENTO:
            - Tiempo de carga: ${reporte.rendimiento.tiempoCargaPromedio.toFixed(0)}ms
            - Errores: ${reporte.errores.total}
            
            鈴?HORARIOS PICO:
            ${reporte.horarios.slice(0, 2).map(h => `- ${h[0]}:00h (${h[1]} eventos)`).join('\\n')}
          `;

          this.enviarReporte('diario', contenido, fecha);
          logs.info('Reportes', 'Reporte diario generado autom谩ticamente');
          
          } catch (error) {
            console.error('[SistemaLogs] Error al generar reporte diario:', error);
          }
        }

        generarReporteSemanal() {
          console.log('[SistemaLogs] Generando reporte semanal...');
          
          // Verificar si analytics est谩 disponible
          if (typeof analytics === 'undefined' || !analytics) {
            console.warn('[SistemaLogs] Analytics no est谩 disponible para generar reporte semanal');
            return;
          }
          
          try {
            const reporte = analytics.obtenerReporte('semana');
            console.log('[SistemaLogs] Reporte semanal obtenido:', reporte);
            const fecha = new Date().toISOString().split('T')[0];
          
          const contenido = `
            馃搱 REPORTE SEMANAL - Semana del ${fecha}
            
            馃挵 RESUMEN DE VENTAS:
            - Total semanal: 鈧?{reporte.ventas.total.toFixed(2)}
            - Pedidos totales: ${reporte.ventas.cantidad}
            - Promedio por d铆a: 鈧?{(reporte.ventas.total / 7).toFixed(2)}
            
            馃搳 TENDENCIAS:
            - Productos estrella: ${reporte.productos.slice(0, 5).map(p => p[0]).join(', ')}
            - D铆as m谩s activos: An谩lisis en curso
            
            馃幆 RECOMENDACIONES:
            - Optimizar horarios pico identificados
            - Promocionar productos con menor rotaci贸n
          `;

          this.enviarReporte('semanal', contenido, fecha);
          logs.info('Reportes', 'Reporte semanal generado autom谩ticamente');
          
          } catch (error) {
            console.error('[SistemaLogs] Error al generar reporte semanal:', error);
          }
        }

        generarReporteMensual() {
          console.log('[SistemaLogs] Generando reporte mensual...');
          
          // Verificar si analytics est谩 disponible
          if (typeof analytics === 'undefined' || !analytics) {
            console.warn('[SistemaLogs] Analytics no est谩 disponible para generar reporte mensual');
            return;
          }
          
          try {
            const reporte = analytics.obtenerReporte('mes');
            console.log('[SistemaLogs] Reporte mensual obtenido:', reporte);
            const fecha = new Date().toISOString().split('T')[0];
          
          const contenido = `
            馃搮 REPORTE MENSUAL - ${new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
            
            馃挵 AN脕LISIS FINANCIERO:
            - Ingresos totales: 鈧?{reporte.ventas.total.toFixed(2)}
            - Pedidos procesados: ${reporte.ventas.cantidad}
            - Crecimiento estimado: En an谩lisis
            
            馃搱 ANALYTICS AVANZADOS:
            - Patrones de comportamiento: Identificados
            - Productos de temporada: ${reporte.productos.slice(0, 3).map(p => p[0]).join(', ')}
            - Optimizaciones sugeridas: Disponibles en panel
            
            馃幆 OBJETIVOS PR脫XIMO MES:
            - Mejorar productos con baja rotaci贸n
            - Optimizar tiempos de servicio
            - Implementar promociones dirigidas
          `;

          this.enviarReporte('mensual', contenido, fecha);
          logs.info('Reportes', 'Reporte mensual generado autom谩ticamente');
          
          } catch (error) {
            console.error('[SistemaLogs] Error al generar reporte mensual:', error);
          }
        }

        enviarAlerta(tipo, mensaje) {
          // Las alertas del sistema se encuentran deshabilitadas.
          // Esta funci贸n se deja intencionadamente vac铆a para evitar mostrar advertencias o notificaciones.
          return;
        }

        enviarReporte(tipoReporte, contenido, fecha) {
          // Guardar en localStorage para historial
          const reportes = JSON.parse(localStorage.getItem('reportes_historial') || '[]');
          reportes.push({
            tipo: tipoReporte,
            fecha,
            contenido,
            timestamp: new Date()
          });
          
          // Mantener solo los 煤ltimos 50 reportes
          if (reportes.length > 50) {
            reportes.splice(0, reportes.length - 50);
          }
          
          localStorage.setItem('reportes_historial', JSON.stringify(reportes));
          
          // Mostrar notificaci贸n
          mostrarToastExito(`Reporte ${tipoReporte} generado y guardado`);
          
          // Si hay notificaciones habilitadas, enviar push
          if (sistemaNotificaciones) {
            sistemaNotificaciones.enviarNotificacion(
              `Reporte ${tipoReporte.charAt(0).toUpperCase() + tipoReporte.slice(1)}`,
              `Nuevo reporte ${tipoReporte} disponible para revisi贸n`,
              'info'
            );
          }
        }

        mostrarHistorialReportes() {
          const reportes = JSON.parse(localStorage.getItem('reportes_historial') || '[]');
          
          const modal = document.getElementById('modal');
          const content = document.querySelector('.modal-content');
          
          modal.classList.add('show');
          content.innerHTML = `
            <div class="header">
              <h1>馃搵 Historial de Reportes</h1>
              <button onclick="cerrarModal()" class="close-btn">脳</button>
            </div>
            
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
              ${reportes.length === 0 ? 
                '<p style="text-align: center; color: #666;">No hay reportes en el historial</p>' :
                reportes.reverse().map(reporte => `
                  <div style="background: white; margin-bottom: 15px; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h3 style="margin: 0; color: var(--c-brand);">
                        ${reporte.tipo.charAt(0).toUpperCase() + reporte.tipo.slice(1)} - ${reporte.fecha}
                      </h3>
                      <small style="color: #666;">${new Date(reporte.timestamp).toLocaleString('es-ES')}</small>
                    </div>
                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9em;">${reporte.contenido}</pre>
                  </div>
                `).join('')
              }
            </div>
          `;
        }

        configurarReportes() {
          const modal = document.getElementById('modal');
          const content = document.querySelector('.modal-content');
          
          modal.classList.add('show');
          content.innerHTML = `
            <div class="header">
              <h1>鈿欙笍 Configuraci贸n de Reportes</h1>
              <button onclick="cerrarModal()" class="close-btn">脳</button>
            </div>
            
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
              <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃搮 Reportes Autom谩ticos</h3>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.reporteDiario.activo ? 'checked' : ''} onchange="sistemaReportes.toggleReporte('diario', this.checked)" style="margin-right: 10px;">
                    Reporte Diario a las ${this.configuracion.reporteDiario.hora}
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.reporteSemanal.activo ? 'checked' : ''} onchange="sistemaReportes.toggleReporte('semanal', this.checked)" style="margin-right: 10px;">
                    Reporte Semanal los ${this.configuracion.reporteSemanal.dia}s a las ${this.configuracion.reporteSemanal.hora}
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.reporteMensual.activo ? 'checked' : ''} onchange="sistemaReportes.toggleReporte('mensual', this.checked)" style="margin-right: 10px;">
                    Reporte Mensual el d铆a ${this.configuracion.reporteMensual.dia} a las ${this.configuracion.reporteMensual.hora}
                  </label>
                </div>
              </div>

              <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃毃 Alertas Autom谩ticas</h3>
                
                <div style="margin-bottom: 15px;">
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.alertas.ventasBajas.activo ? 'checked' : ''} onchange="sistemaReportes.toggleAlerta('ventasBajas', this.checked)" style="margin-right: 10px;">
                    Alertar cuando las ventas diarias sean menores a 鈧?{this.configuracion.alertas.ventasBajas.umbral}
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.alertas.erroresAltos.activo ? 'checked' : ''} onchange="sistemaReportes.toggleAlerta('erroresAltos', this.checked)" style="margin-right: 10px;">
                    Alertar cuando haya m谩s de ${this.configuracion.alertas.erroresAltos.umbral} errores por d铆a
                  </label>
                  <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" ${this.configuracion.alertas.tiempoRespuestaAlto.activo ? 'checked' : ''} onchange="sistemaReportes.toggleAlerta('tiempoRespuestaAlto', this.checked)" style="margin-right: 10px;">
                    Alertar cuando el tiempo de carga sea mayor a ${this.configuracion.alertas.tiempoRespuestaAlto.umbral}ms
                  </label>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                  <button onclick="sistemaReportes.generarReporteDiario()" class="admin-btn" style="flex: 1;">
                    Generar Reporte Diario Ahora
                  </button>
                  <button onclick="sistemaReportes.mostrarHistorialReportes()" class="admin-btn" style="flex: 1;">
                    Ver Historial
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        toggleReporte(tipo, activo) {
          switch(tipo) {
            case 'diario':
              this.configuracion.reporteDiario.activo = activo;
              break;
            case 'semanal':
              this.configuracion.reporteSemanal.activo = activo;
              break;
            case 'mensual':
              this.configuracion.reporteMensual.activo = activo;
              break;
          }
          this.guardarConfiguracion();
          mostrarToastExito(`Reporte ${tipo} ${activo ? 'activado' : 'desactivado'}`);
        }

        toggleAlerta(tipo, activo) {
          this.configuracion.alertas[tipo].activo = activo;
          this.guardarConfiguracion();
          mostrarToastExito(`Alerta ${tipo} ${activo ? 'activada' : 'desactivada'}`);
        }

        guardarConfiguracion() {
          localStorage.setItem('reportes_config', JSON.stringify(this.configuracion));
        }
      }

      // =====================================
      // SISTEMA DE RECUPERACI脫N AUTOM脕TICA
      // =====================================

      class SistemaRecuperacion {
        constructor() {
          this.intentosMaximos = 3;
          this.tiempoEsperaBase = 1000; // 1 segundo
          this.funcionesCriticas = new Map();
          this.estadoRecuperacion = new Map();
          this.backupAutomatico = true;
          this.intervalosRecuperacion = new Map();
          this.inicializar();
        }

        inicializar() {
          // Registrar funciones cr铆ticas del sistema
          this.registrarFuncionesCriticas();
          
          // Configurar monitoreo de salud del sistema
          this.iniciarMonitoreoSalud();
          
          // Configurar backup autom谩tico
          this.configurarBackupAutomatico();
          
          logInfo('Sistema de recuperaci贸n autom谩tica inicializado');
        }

        registrarFuncionesCriticas() {
          // Funci贸n cr铆tica: Guardar estado
          this.registrarFuncionCritica('guardarEstado', () => {
            try {
              const estadoString = JSON.stringify({
                mesas: Array.from(estado.mesas.entries()),
                pedidos: estado.pedidos,
                productos: estado.productos,
                usuarios: estado.usuarios,
                configuracion: estado.configuracion,
                timestamp: Date.now()
              });
              localStorage.setItem('estado-tpv', estadoString);
              return true;
            } catch (error) {
              logError('Error al guardar estado', { error: error.message });
              return false;
            }
          });

          // Funci贸n cr铆tica: Cargar estado
          this.registrarFuncionCritica('cargarEstado', () => {
            try {
              const estadoGuardado = localStorage.getItem('estado-tpv');
              if (!estadoGuardado) return true;

              const estadoObj = JSON.parse(estadoGuardado);
              
              // Validar integridad de datos
              if (!this.validarIntegridadDatos(estadoObj)) {
                logWarn('Datos corruptos detectados, usando backup');
                return this.restaurarDesdeBackup();
              }

              // Restaurar estado
              estado.mesas = new Map(estadoObj.mesas);
              estado.pedidos = estadoObj.pedidos || [];
              estado.productos = estadoObj.productos || [];
              estado.usuarios = estadoObj.usuarios || estado.usuarios || getDefaultData().usuarios;
              estado.configuracion = estadoObj.configuracion || {};

              return true;
            } catch (error) {
              logError('Error al cargar estado', { error: error.message });
              return this.restaurarDesdeBackup();
            }
          });

          // Funci贸n cr铆tica: Conectividad de red (simulada)
          this.registrarFuncionCritica('verificarConectividad', () => {
            return navigator.onLine;
          });

          // Funci贸n cr铆tica: Integridad de localStorage
          this.registrarFuncionCritica('verificarLocalStorage', () => {
            try {
              const testKey = 'test-storage';
              localStorage.setItem(testKey, 'test');
              localStorage.removeItem(testKey);
              return true;
            } catch (error) {
              logError('LocalStorage no disponible', { error: error.message });
              return false;
            }
          });
        }

        registrarFuncionCritica(nombre, funcion) {
          this.funcionesCriticas.set(nombre, funcion);
          this.estadoRecuperacion.set(nombre, {
            ultimoExito: Date.now(),
            intentosConsecutivos: 0,
            enRecuperacion: false
          });
        }

        async ejecutarConRecuperacion(nombreFuncion, parametros = []) {
          if (!this.funcionesCriticas.has(nombreFuncion)) {
            logError(`Funci贸n cr铆tica no registrada: ${nombreFuncion}`);
            return false;
          }

          const funcion = this.funcionesCriticas.get(nombreFuncion);
          const estado = this.estadoRecuperacion.get(nombreFuncion);

          for (let intento = 1; intento <= this.intentosMaximos; intento++) {
            try {
              logDebug(`Ejecutando ${nombreFuncion}, intento ${intento}`);
              
              const resultado = await funcion(...parametros);
              
              if (resultado) {
                // 脡xito - resetear contadores
                estado.ultimoExito = Date.now();
                estado.intentosConsecutivos = 0;
                estado.enRecuperacion = false;
                
                if (intento > 1) {
                  logInfo(`Funci贸n ${nombreFuncion} recuperada exitosamente en intento ${intento}`);
                  mostrarToastExito(`鉁?Sistema recuperado: ${nombreFuncion}`);
                }
                
                return true;
              }
            } catch (error) {
              logError(`Error en ${nombreFuncion}, intento ${intento}`, {
                error: error.message,
                stack: error.stack
              });
            }

            // Si no es el 煤ltimo intento, esperar antes de reintentar
            if (intento < this.intentosMaximos) {
              const tiempoEspera = this.tiempoEsperaBase * Math.pow(2, intento - 1); // Backoff exponencial
              logDebug(`Esperando ${tiempoEspera}ms antes del siguiente intento`);
              await this.esperar(tiempoEspera);
            }
          }

          // Todos los intentos fallaron
          estado.intentosConsecutivos++;
          estado.enRecuperacion = true;
          
          logCritical(`Funci贸n cr铆tica ${nombreFuncion} fall贸 despu茅s de ${this.intentosMaximos} intentos`);
          
          // Activar modo degradado si es necesario
          this.activarModoDegradado(nombreFuncion);
          
          return false;
        }

        validarIntegridadDatos(datos) {
          try {
            // Verificaciones b谩sicas de integridad
            if (!datos || typeof datos !== 'object') return false;
            if (!Array.isArray(datos.mesas) && !(datos.mesas instanceof Map)) return false;
            if (!Array.isArray(datos.pedidos)) return false;
            if (!datos.timestamp || typeof datos.timestamp !== 'number') return false;
            
            // Verificar que el timestamp no sea muy antiguo (m谩s de 24 horas)
            const horasTranscurridas = (Date.now() - datos.timestamp) / (1000 * 60 * 60);
            if (horasTranscurridas > 24) {
              logWarn('Datos muy antiguos detectados', { horasTranscurridas });
            }

            return true;
          } catch (error) {
            logError('Error al validar integridad de datos', { error: error.message });
            return false;
          }
        }

        restaurarDesdeBackup() {
          try {
            const backup = localStorage.getItem('estado-tpv-backup');
            if (!backup) {
              logWarn('No hay backup disponible, iniciando con datos por defecto');
              this.inicializarDatosPorDefecto();
              return true;
            }

            const backupObj = JSON.parse(backup);
            if (this.validarIntegridadDatos(backupObj)) {
              estado.mesas = new Map(backupObj.mesas);
              estado.pedidos = backupObj.pedidos || [];
              estado.productos = backupObj.productos || [];
              estado.configuracion = backupObj.configuracion || {};
              
              logInfo('Estado restaurado desde backup');
              mostrarToastExito('鉁?Estado restaurado desde backup');
              return true;
            } else {
              logError('Backup tambi茅n est谩 corrupto');
              this.inicializarDatosPorDefecto();
              return true;
            }
          } catch (error) {
            logError('Error al restaurar desde backup', { error: error.message });
            this.inicializarDatosPorDefecto();
            return true;
          }
        }

        inicializarDatosPorDefecto() {
          logWarn('Inicializando con datos por defecto');
          
          // Reinicializar estado b谩sico
          estado.mesas = new Map();
          estado.pedidos = [];
          estado.productos = [...productosBase];
          estado.configuracion = {};

          // Crear mesas por defecto
          for (let i = 1; i <= 12; i++) {
            estado.mesas.set(i.toString(), {
              numero: i.toString(),
              zona: i <= 6 ? 'Terraza' : 'Interior',
              estado: 'libre',
              pedido: null,
              horaOcupacion: null
            });
          }

          mostrarToast('鈿狅笍 Sistema reiniciado con configuraci贸n por defecto', 'warning', 5000);
        }

        activarModoDegradado(funcionFallida) {
          logWarn(`Activando modo degradado para: ${funcionFallida}`);

          switch (funcionFallida) {
            case 'guardarEstado':
              // Modo degradado: guardar solo en memoria, mostrar advertencia
              mostrarToast('鈿狅笍 Modo degradado: Los datos no se guardan autom谩ticamente', 'warning', 0, [
                { texto: 'Reintentar', callback: () => this.ejecutarConRecuperacion('guardarEstado') }
              ]);
              break;

            case 'verificarLocalStorage':
              // Modo degradado: solo usar memoria RAM
              mostrarToast('鈿狅笍 Almacenamiento local no disponible. Datos solo en memoria', 'warning', 0);
              this.backupAutomatico = false;
              break;

            case 'verificarConectividad':
              // Modo degradado: funcionar offline
              mostrarToast('馃摗 Modo sin conexi贸n activado', 'info', 5000);
              break;
          }
        }

        iniciarMonitoreoSalud() {
          // Monitor cada 30 segundos
          this.intervalosRecuperacion.set('saludSistema', setInterval(() => {
            this.verificarSaludSistema();
          }, 30000));

          // Monitor de memoria cada 5 minutos
          this.intervalosRecuperacion.set('memoria', setInterval(() => {
            this.verificarUsoMemoria();
          }, 300000));
        }

        verificarSaludSistema() {
          const funcionesParaVerificar = ['verificarLocalStorage', 'verificarConectividad'];
          
          funcionesParaVerificar.forEach(async (nombreFuncion) => {
            const estado = this.estadoRecuperacion.get(nombreFuncion);
            const tiempoSinExito = Date.now() - estado.ultimoExito;
            
            // Si han pasado m谩s de 5 minutos sin 茅xito, verificar
            if (tiempoSinExito > 300000) {
              await this.ejecutarConRecuperacion(nombreFuncion);
            }
          });
        }

        verificarUsoMemoria() {
          try {
            // Verificar tama帽o de datos en localStorage
            const estadoSize = JSON.stringify(estado).length;
            const logsSize = JSON.stringify(sistemaLogs.logs).length;
            const totalSize = estadoSize + logsSize;

            if (totalSize > 4 * 1024 * 1024) { // 4MB
              logWarn('Uso de memoria alto detectado', {
                estadoSize: Math.round(estadoSize / 1024) + 'KB',
                logsSize: Math.round(logsSize / 1024) + 'KB',
                totalSize: Math.round(totalSize / 1024) + 'KB'
              });

              // Limpiar logs antiguos
              if (sistemaLogs.logs.length > 500) {
                sistemaLogs.logs = sistemaLogs.logs.slice(0, 250);
                logInfo('Logs limpiados autom谩ticamente por uso de memoria');
              }

              // Limpiar pedidos antiguos (m谩s de 7 d铆as)
              const hace7Dias = Date.now() - (7 * 24 * 60 * 60 * 1000);
              const pedidosOriginales = estado.pedidos.length;
              estado.pedidos = estado.pedidos.filter(p => new Date(p.fechaHora) > hace7Dias);
              
              if (estado.pedidos.length < pedidosOriginales) {
                const eliminados = pedidosOriginales - estado.pedidos.length;
                logInfo(`${eliminados} pedidos antiguos eliminados autom谩ticamente`);
              }
            }
          } catch (error) {
            logError('Error al verificar uso de memoria', { error: error.message });
          }
        }

        configurarBackupAutomatico() {
          if (!this.backupAutomatico) return;

          // Backup cada 10 minutos
          this.intervalosRecuperacion.set('backup', setInterval(() => {
            this.crearBackupAutomatico();
          }, 600000));

          logInfo('Backup autom谩tico configurado (cada 10 minutos)');
        }

        crearBackupAutomatico() {
          try {
            const estadoParaBackup = {
              mesas: Array.from(estado.mesas.entries()),
              pedidos: estado.pedidos,
              productos: estado.productos,
              configuracion: estado.configuracion,
              timestamp: Date.now()
            };

            localStorage.setItem('estado-tpv-backup', JSON.stringify(estadoParaBackup));
            logDebug('Backup autom谩tico creado');
          } catch (error) {
            logError('Error al crear backup autom谩tico', { error: error.message });
          }
        }

        // M茅todo para crear backup manual
        crearBackupManual() {
          const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
          const nombreBackup = `backup-${timestamp}`;
          
          try {
            const backup = {
              mesas: Array.from(estado.mesas.entries()),
              pedidos: estado.pedidos,
              productos: estado.productos,
              configuracion: estado.configuracion,
              timestamp: Date.now(),
              version: '9.0'
            };

            const contenido = JSON.stringify(backup, null, 2);
            const blob = new Blob([contenido], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nombreBackup}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logInfo(`Backup manual creado: ${nombreBackup}.json`);
            mostrarToastExito(`馃捑 Backup creado: ${nombreBackup}.json`);
          } catch (error) {
            logError('Error al crear backup manual', { error: error.message });
            mostrarToastError('Error al crear backup manual');
          }
        }

        // Restaurar desde archivo de backup
        restaurarDesdeArchivo(archivo) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const backup = JSON.parse(e.target.result);
              
              if (this.validarIntegridadDatos(backup)) {
                estado.mesas = new Map(backup.mesas);
                estado.pedidos = backup.pedidos || [];
                estado.productos = backup.productos || [];
                estado.configuracion = backup.configuracion || {};

                // Guardar estado restaurado
                this.ejecutarConRecuperacion('guardarEstado');
                
                // Actualizar vista
                estado.mesas.forEach(mesa => actualizarVisualMesa(mesa.numero));
                actualizarEstadisticas();

                logInfo('Estado restaurado desde archivo de backup');
                mostrarToastExito('鉁?Estado restaurado exitosamente');
              } else {
                logError('Archivo de backup inv谩lido o corrupto');
                mostrarToastError('鉂?Archivo de backup inv谩lido');
              }
            } catch (error) {
              logError('Error al procesar archivo de backup', { error: error.message });
              mostrarToastError('鉂?Error al procesar archivo de backup');
            }
          };
          reader.readAsText(archivo);
        }

        // Utilidades
        async esperar(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Limpiar intervalos al destruir
        destruir() {
          this.intervalosRecuperacion.forEach((intervalo, nombre) => {
            clearInterval(intervalo);
            logDebug(`Intervalo ${nombre} limpiado`);
          });
          this.intervalosRecuperacion.clear();
        }

        // Obtener estado del sistema para debugging
        obtenerEstadoSistema() {
          const estadoSistema = {};
          
          this.estadoRecuperacion.forEach((estado, funcion) => {
            estadoSistema[funcion] = {
              ...estado,
              tiempoSinExito: Date.now() - estado.ultimoExito
            };
          });

          return {
            funcionesCriticas: Array.from(this.funcionesCriticas.keys()),
            estadoFunciones: estadoSistema,
            backupAutomatico: this.backupAutomatico,
            intervalosActivos: Array.from(this.intervalosRecuperacion.keys())
          };
        }
      }

      // Instancia global del sistema de recuperaci贸n
      const sistemaRecuperacion = new SistemaRecuperacion();

      // Instancias globales de los sistemas de analytics y reportes
      const analytics = new SistemaAnalytics();
      const sistemaReportes = new SistemaReportes();

      // Funci贸n para poblar datos de ejemplo
      function poblarDatosEjemplo() {
        // Solo permitir datos de ejemplo si MODO_DEMO est谩 activo expl铆citamente
        if (!window.MODO_DEMO) {
          console.warn('鉀?Modo demo inactivo: no se poblar谩n datos de ejemplo');
          return;
        }
        console.log('馃搳 Generando datos de ejemplo...');
        
        // Poblar datos de analytics si est谩n vac铆os
        if (analytics.eventos.length === 0) {
          console.log('馃搳 Generando datos de ejemplo para analytics...');
          
          // Datos de ejemplo de ventas de hoy
          const ahora = new Date();
          const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
          
          // Simular ventas durante el d铆a
          for (let i = 0; i < 15; i++) {
            const horaVenta = new Date(hoy.getTime() + (Math.random() * 24 * 60 * 60 * 1000));
            const productos = ['Hamburguesa Cl谩sica', 'Papas Fritas', 'Coca Cola', 'Nuggets', 'Ensalada C茅sar'];
            const producto = productos[Math.floor(Math.random() * productos.length)];
            const precio = Math.random() * 15 + 5; // Entre 5 y 20 euros
            
            analytics.capturarEvento('venta', {
              producto: producto,
              precio: precio,
              cantidad: Math.floor(Math.random() * 3) + 1,
              mesa: Math.floor(Math.random() * 10) + 1,
              timestamp: horaVenta
            });
          }
          
          // Simular navegaci贸n
          for (let i = 0; i < 8; i++) {
            analytics.capturarEvento('navegacion', {
              seccion: ['menu', 'ventas', 'admin', 'mesas'][Math.floor(Math.random() * 4)],
              timestamp: new Date(hoy.getTime() + (Math.random() * 24 * 60 * 60 * 1000))
            });
          }
          
          console.log('鉁?Datos de analytics generados');
        }
        
        // Poblar pedidos de ejemplo si hay pocos
        if (estado.pedidos.length < 5) {
          console.log('馃搳 Generando pedidos de ejemplo...');
          
          const hoy = new Date();
          const productosEjemplo = [
            { nombre: 'Hamburguesa Cl谩sica', precio: 8.50, categoria: 'hamburguesas' },
            { nombre: 'Papas Fritas', precio: 3.50, categoria: 'guarniciones' },
            { nombre: 'Coca Cola', precio: 2.50, categoria: 'bebidas' },
            { nombre: 'Nuggets de Pollo', precio: 6.50, categoria: 'pollo' },
            { nombre: 'Ensalada C茅sar', precio: 7.00, categoria: 'ensaladas' }
          ];
          
          const camareros = ['Admin', 'Juan', 'Mar铆a', 'Carlos'];
          
          for (let i = 0; i < 8; i++) {
            const numItems = Math.floor(Math.random() * 4) + 1; // 1-4 items por pedido
            const items = [];
            let totalPedido = 0;
            
            for (let j = 0; j < numItems; j++) {
              const producto = productosEjemplo[Math.floor(Math.random() * productosEjemplo.length)];
              const cantidad = Math.floor(Math.random() * 3) + 1;
              const subtotal = producto.precio * cantidad;
              
              items.push({
                ...producto,
                cantidad: cantidad,
                subtotal: subtotal
              });
              
              totalPedido += subtotal;
            }
            
            const pedidoEjemplo = {
              id: `ejemplo-${Date.now()}-${i}`,
              fecha: new Date(hoy.getTime() - Math.random() * 24 * 60 * 60 * 1000).toISOString(), // 脷ltimas 24 horas
              mesa: Math.floor(Math.random() * 10) + 1,
              camarero: camareros[Math.floor(Math.random() * camareros.length)],
              items: items,
              total: totalPedido,
              estado: 'completado',
              hora: new Date().toLocaleTimeString()
            };
            
            estado.pedidos.push(pedidoEjemplo);
          }
          
          // Guardar los cambios
          guardarEstado();
          console.log('鉁?Pedidos de ejemplo generados');
        }
        
        mostrarToast('鉁?Datos de ejemplo cargados correctamente', 'success');
        console.log('馃帀 Datos de ejemplo poblados exitosamente');
      }

      // Poblar datos despu茅s de un breve delay
// setTimeout(poblarDatosEjemplo, 1000); // desactivado para evitar datos inventados


      // Sobrescribir funci贸n guardarEstado original para usar recuperaci贸n autom谩tica
      const guardarEstadoOriginal = guardarEstado;
      guardarEstado = function() {
        return sistemaRecuperacion.ejecutarConRecuperacion('guardarEstado');
      };

      // Funci贸n para mostrar estado del sistema (debug)
      function mostrarEstadoSistema() {
        console.log('馃攳 mostrarEstadoSistema() iniciada');
        try {
          if (typeof sistemaRecuperacion !== 'undefined' && sistemaRecuperacion.obtenerEstadoSistema) {
            const estadoSistema = sistemaRecuperacion.obtenerEstadoSistema();
            console.table(estadoSistema.estadoFunciones);
            mostrarToast(`
              馃敡 Estado del Sistema:
              Funciones cr铆ticas: ${estadoSistema.funcionesCriticas.length}
              Intervalos activos: ${estadoSistema.intervalosActivos.length}
              Backup autom谩tico: ${estadoSistema.backupAutomatico ? 'Activo' : 'Inactivo'}
            `, 'info', 8000);
            console.log('鉁?Estado del sistema mostrado exitosamente');
          } else {
            console.warn('鈿狅笍 sistemaRecuperacion no est谩 disponible');
            mostrarToast('Sistema de recuperaci贸n no disponible. Recargue la p谩gina.', 'warning');
          }
        } catch (error) {
          console.error('鉂?Error en mostrarEstadoSistema():', error);
          mostrarToast('Error mostrando estado del sistema: ' + error.message, 'error');
        }
      }

      // Funci贸n para mostrar dashboard de analytics
      function mostrarDashboardAnalytics() {
        console.log('馃攳 mostrarDashboardAnalytics() iniciada');
        try {
          if (typeof analytics !== 'undefined' && analytics.capturarEvento) {
            analytics.capturarEvento('navegacion', { seccion: 'dashboard_analytics' });
          }

          if (typeof analytics === 'undefined' || !analytics.obtenerReporte) {
            console.warn('鈿狅笍 Sistema de analytics no disponible');
            mostrarToast('Sistema de analytics no disponible. Recargue la p谩gina.', 'warning');
            return;
          }
          
          const reporteHoy = analytics.obtenerReporte('hoy');
          const reporteSemana = analytics.obtenerReporte('semana');
          const reporteMes = analytics.obtenerReporte('mes');
          
          console.log('鉁?Reportes obtenidos, mostrando dashboard');
          
          const contenido = `
            <!-- Selector de Per铆odo -->
            <div style="margin-bottom: 20px;">
              <label style="font-weight: bold; margin-right: 10px;">Per铆odo:</label>
              <select id="periodoAnalytics" onchange="actualizarDashboardAnalytics(this.value)" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                <option value="hoy">Hoy</option>
                <option value="semana">Esta Semana</option>
                <option value="mes">Este Mes</option>
              </select>
              <button onclick="analytics.exportarDatos()" style="margin-left: 10px; padding: 8px 15px; background: var(--c-brand); color: white; border: none; border-radius: 5px; cursor: pointer;">
                馃摜 Exportar Datos
              </button>
            </div>

            <!-- Resumen R谩pido -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="margin: 0; font-size: 2em;">鈧?{reporteHoy.ventas.total.toFixed(2)}</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Ventas de Hoy</p>
              </div>
              <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="margin: 0; font-size: 2em;">${reporteHoy.ventas.cantidad}</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Pedidos Hoy</p>
              </div>
              <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="margin: 0; font-size: 2em;">鈧?{reporteHoy.ventas.promedio.toFixed(2)}</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Ticket Promedio</p>
              </div>
              <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                <h3 style="margin: 0; font-size: 2em;">${analytics.metricas.resumen.sesionesTotales}</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Total Sesiones</p>
              </div>
            </div>

            <!-- Productos M谩s Vendidos -->
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃弳 Productos M谩s Vendidos (Hoy)</h3>
              <div id="productosPopulares">
                ${generarGraficoProductos(reporteHoy.productos)}
              </div>
            </div>

            <!-- Horarios Pico -->
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">鈴?Horarios Pico (Hoy)</h3>
              <div id="horariosPico">
                ${generarGraficoHorarios(reporteHoy.horarios)}
              </div>
            </div>

            <!-- Acciones R谩pidas -->
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃殌 Acciones R谩pidas</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="mostrarReporteDetallado()" class="admin-btn" style="width: 100%;">
                  馃搵 Reporte Detallado
                </button>
                <button onclick="analytics.limpiarDatos()" class="admin-btn" style="width: 100%;">
                  馃棏锔?Limpiar Datos
                </button>
              </div>
            </div>
          `;
          
          if (mostrarModalEstandar("馃搳 Dashboard de Analytics", contenido)) {
            console.log('馃帀 mostrarDashboardAnalytics() completado exitosamente');
          }
        } catch (error) {
          console.error('鉂?Error en mostrarDashboardAnalytics():', error);
          mostrarToast('Error mostrando dashboard de analytics: ' + error.message, 'error');
        }
      }

      function generarGraficoProductos(productos) {
        if (!productos || productos.length === 0) {
          return '<p style="text-align: center; color: #666;">No hay datos de productos</p>';
        }

        return productos.slice(0, 5).map((producto, index) => {
          const nombre = producto[0];
          const datos = producto[1];
          const porcentaje = Math.min((datos.cantidad / productos[0][1].cantidad) * 100, 100);
          
          return `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold;">${nombre}</span>
                <span style="color: var(--c-brand);">${datos.cantidad} unidades</span>
              </div>
              <div style="background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, var(--c-brand), var(--c-accent)); height: 100%; width: ${porcentaje}%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          `;
        }).join('');
      }

      function generarGraficoHorarios(horarios) {
        if (!horarios || horarios.length === 0) {
          return '<p style="text-align: center; color: #666;">No hay datos de horarios</p>';
        }

        return horarios.slice(0, 5).map((horario, index) => {
          const hora = horario[0];
          const eventos = horario[1];
          const porcentaje = Math.min((eventos / horarios[0][1]) * 100, 100);
          
          return `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: bold;">${hora}:00 - ${hora}:59</span>
                <span style="color: var(--c-brand);">${eventos} eventos</span>
              </div>
              <div style="background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #ff6b6b, #feca57); height: 100%; width: ${porcentaje}%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          `;
        }).join('');
      }

      function actualizarDashboardAnalytics(periodo) {
        // Esta funci贸n se puede expandir para actualizar solo parte del dashboard
        mostrarDashboardAnalytics();
      }

      function mostrarReporteDetallado() {
        analytics.exportarDatos();
        mostrarToastInfo('Reporte detallado exportado. Revisa tu carpeta de descargas.');
      }

      function generarReportePersonalizado() {
        mostrarToastInfo('Funci贸n de reportes personalizados en desarrollo. Pr贸ximamente disponible.');
      }

      // Funci贸n para mostrar herramientas avanzadas
      function mostrarHerramientasAvanzadas() {
        const modal = document.getElementById('modal');
        const content = document.querySelector('.modal-content');
        
        modal.classList.add('show');
        content.innerHTML = `
          <div class="header">
            <h1>馃洜锔?Herramientas Avanzadas del Sistema</h1>
            <button onclick="cerrarModal()" class="close-btn">脳</button>
          </div>
          
          <div style="padding: 20px;">
            <!-- Sistema de Notificaciones -->
            <div style="margin-bottom: 25px; padding: 15px; border: 2px solid var(--c-accent-light); border-radius: 10px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃敂 Sistema de Notificaciones</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="sistemaNotificaciones.solicitarPermisos()" class="admin-btn" style="width: 100%;">
                  Activar Notificaciones
                </button>
                <button onclick="sistemaNotificaciones.enviarNotificacion('Prueba', 'Notificaci贸n de prueba', 'info')" class="admin-btn" style="width: 100%;">
                  Probar Notificaci贸n
                </button>
                <button onclick="sistemaNotificaciones.mostrarMesasLargoTiempo()" class="admin-btn" style="width: 100%;">
                  Ver Mesas Tiempo Largo
                </button>
              </div>
            </div>

            <!-- Sistema de Logs -->
            <div style="margin-bottom: 25px; padding: 15px; border: 2px solid var(--c-accent-light); border-radius: 10px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃搵 Sistema de Logs</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="sistemaLogs.mostrarVisorLogs()" class="admin-btn" style="width: 100%;">
                  Ver Todos los Logs
                </button>
                <button onclick="sistemaLogs.descargarLogs('json')" class="admin-btn" style="width: 100%;">
                  Exportar JSON
                </button>
                <button onclick="sistemaLogs.descargarLogs('txt')" class="admin-btn" style="width: 100%;">
                  Exportar TXT
                </button>
                <button onclick="sistemaLogs.limpiarLogs()" class="admin-btn" style="width: 100%; background: var(--c-brand);">
                  Limpiar Logs
                </button>
              </div>
              <div style="margin-top: 10px;">
                <label style="display: block; margin-bottom: 5px;">Nivel de logs:</label>
                <select onchange="sistemaLogs.establecerNivel(this.value)" style="width: 100%; padding: 8px; border-radius: 5px;">
                  <option value="DEBUG">馃悰 Debug (Todos)</option>
                  <option value="INFO" selected>鈩癸笍 Info</option>
                  <option value="WARN">鈿狅笍 Advertencias</option>
                  <option value="ERROR">鉂?Solo Errores</option>
                </select>
              </div>
            </div>

            <!-- Sistema de Recuperaci贸n -->
            <div style="margin-bottom: 25px; padding: 15px; border: 2px solid var(--c-accent-light); border-radius: 10px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃洝锔?Sistema de Recuperaci贸n</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="sistemaRecuperacion.crearBackupManual()" class="admin-btn" style="width: 100%;">
                  馃捑 Backup Manual
                </button>
                <button onclick="document.getElementById('file-restore').click()" class="admin-btn" style="width: 100%;">
                  馃搨 Restaurar Backup
                </button>
                <button onclick="sistemaRecuperacion.verificarSaludSistema()" class="admin-btn" style="width: 100%;">
                  鉂わ笍 Verificar Salud
                </button>
                <button onclick="mostrarEstadoSistema()" class="admin-btn" style="width: 100%;">
                  馃敡 Estado Detallado
                </button>
                <button onclick="(typeof analytics !== 'undefined' && analytics.limpiarDatos) ? analytics.limpiarDatos() : mostrarToast('Analytics no disponible', 'error');" class="admin-btn" style="width: 100%;">
                  馃Ч Limpiar Analytics
                </button>
              </div>
              <input type="file" id="file-restore" accept=".json" onchange="handleFileRestore(this)" style="display: none;">
            </div>

            <!-- Configuraci贸n PWA -->
            <div style="margin-bottom: 25px; padding: 15px; border: 2px solid var(--c-accent-light); border-radius: 10px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃摫 PWA y Cache</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="instalarPWA()" class="admin-btn" style="width: 100%;">
                  馃摫 Instalar como App
                </button>
                <button onclick="limpiarCache()" class="admin-btn" style="width: 100%;">
                  馃棏锔?Limpiar Cache
                </button>
                <button onclick="navigator.serviceWorker.getRegistrations().then(r => console.log('SW:', r))" class="admin-btn" style="width: 100%;">
                  馃攳 Ver Service Workers
                </button>
              </div>
            </div>

            <!-- Herramientas de Desarrollo -->
            <div style="margin-bottom: 25px; padding: 15px; border: 2px solid var(--c-accent-light); border-radius: 10px;">
              <h3 style="margin: 0 0 15px 0; color: var(--c-brand);">馃И Herramientas de Desarrollo</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <button onclick="generarDatosPrueba()" class="admin-btn" style="width: 100%;">
                  馃幉 Generar Datos de Prueba
                </button>
                <button onclick="simularError()" class="admin-btn" style="width: 100%;">
                  馃挜 Simular Error
                </button>
                <button onclick="console.log('Estado:', estado)" class="admin-btn" style="width: 100%;">
                  馃枼锔?Log Estado en Consola
                </button>
                <button onclick="mostrarEstadisticasMemoria()" class="admin-btn" style="width: 100%;">
                  馃搳 Estad铆sticas Memoria
                </button>
              </div>
            </div>

            <div style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px;">
              鈿狅笍 Estas herramientas son para administradores. Usar con precauci贸n.
            </div>
          </div>
        `;
      }

      // Funci贸n para manejar restauraci贸n desde archivo
      function handleFileRestore(input) {
        const archivo = input.files[0];
        if (archivo) {
          sistemaRecuperacion.restaurarDesdeArchivo(archivo);
        }
      }

      // Funci贸n para limpiar cache del navegador
      function limpiarCache() {
        if ('caches' in window) {
          caches.keys().then(nombres => {
            nombres.forEach(nombre => {
              caches.delete(nombre);
            });
            mostrarToastExito('馃棏锔?Cache limpiado correctamente');
            logInfo('Cache del navegador limpiado manualmente');
          });
        } else {
          mostrarToast('鉂?Cache API no soportada', 'error');
        }
      }

      // Funci贸n para generar datos de prueba
      function generarDatosPrueba() {
        const mesasParaPrueba = [1, 3, 5, 7];
        const clientesPrueba = ['Juan P茅rez', 'Mar铆a Garc铆a', 'Carlos L贸pez', 'Ana Mart铆n'];
        
        mesasParaPrueba.forEach((numeroMesa, index) => {
          const mesa = estado.mesas.get(numeroMesa.toString());
          if (mesa && mesa.estado === 'libre') {
            // Simular pedido
            mesa.estado = 'ocupada';
            mesa.horaOcupacion = new Date(Date.now() - (index * 600000)); // Diferentes tiempos
            
            const pedido = {
              id: Date.now() + index,
              mesa: numeroMesa.toString(),
              nombreCliente: clientesPrueba[index],
              productos: [
                { nombre: 'COMBO MARILYN', precio: 12.50, cantidad: 1 },
                { nombre: 'Cerveza', precio: 3.00, cantidad: 2 }
              ],
              total: 18.50,
              fechaHora: mesa.horaOcupacion.toISOString(),
              entregado: Math.random() > 0.5
            };
            
            estado.pedidos.push(pedido);
            mesa.pedido = pedido;
          }
        });
        
        // Actualizar visuals
        estado.mesas.forEach(mesa => actualizarVisualMesa(mesa.numero));
        actualizarEstadisticas();
        guardarEstado();
        
        logInfo('Datos de prueba generados', { mesas: mesasParaPrueba, pedidos: mesasParaPrueba.length });
        mostrarToastExito(`馃幉 Generados ${mesasParaPrueba.length} pedidos de prueba`);
      }

      // Funci贸n para simular error (testing)
      function simularError() {
        mostrarToastConfirmacion(
          '馃挜 驴Simular error del sistema para probar recuperaci贸n?',
          () => {
            logError('Error simulado para testing', { 
              tipo: 'simulado', 
              stack: 'Error simulado desde herramientas de desarrollo' 
            });
            throw new Error('Error simulado para testing del sistema de recuperaci贸n');
          }
        );
      }

      // Funci贸n para mostrar estad铆sticas de memoria
      function mostrarEstadisticasMemoria() {
        const estadoSize = JSON.stringify(estado).length;
        const logsSize = JSON.stringify(sistemaLogs.logs).length;
        const localStorageSize = JSON.stringify(localStorage).length;
        
        const stats = {
          'Estado del TPV': Math.round(estadoSize / 1024) + ' KB',
          'Logs del sistema': Math.round(logsSize / 1024) + ' KB',
          'LocalStorage total': Math.round(localStorageSize / 1024) + ' KB',
          'Logs en memoria': sistemaLogs.logs.length + ' entradas',
          'Pedidos totales': estado.pedidos.length,
          'Mesas configuradas': estado.mesas.size
        };
        
        let mensaje = '馃搳 Estad铆sticas de Memoria:\n\n';
        Object.entries(stats).forEach(([key, value]) => {
          mensaje += `${key}: ${value}\n`;
        });
        
        mostrarToast(mensaje, 'info', 10000);
        console.table(stats);
        
        logInfo('Estad铆sticas de memoria consultadas', stats);
      }

      function filtrarProductos(termino) {
        const productosDivs = document.querySelectorAll(
          "#productosLista .product"
        );
        const terminoBusqueda = termino.toLowerCase();
        productosDivs.forEach((div) => {
          const nombreProducto = div
            .querySelector(".product-name")
            .textContent.toLowerCase();
          div.style.display = nombreProducto.includes(terminoBusqueda)
            ? "flex"
            : "none";
        });
      }

      // FUNCI脫N PARA CALCULAR TIEMPO DE OCUPACI脫N (COMO V04)
      function calcularTiempoOcupacion(horaOcupacion) {
        if (!horaOcupacion) return "0m";
        const minutos = Math.floor(
          (new Date() - new Date(horaOcupacion)) / 60000
        );
        if (minutos < 60) return `${minutos}m`;
        return `${Math.floor(minutos / 60)}h ${minutos % 60}m`;
      }

      function marcarPedidoEntregado(pedidoId) {
        if (confirm("驴Marcar este pedido como entregado?")) {
          const pedido = estado.pedidos.find((p) => p.id == pedidoId);
          if (pedido) {
            pedido.entregado = true;
            pedido.horaEntrega = new Date();
            guardarEstado();
            actualizarEstadisticas();
            mostrarToast(
              `鉁?Pedido de ${pedido.nombreCliente} entregado`,
              "success"
            );

            // Actualizar la vista si el modal est锟?abierto
            if (document.getElementById("modal").classList.contains("show")) {
              nuevoPedidoParaLlevar();
            }
          }
        }
      }

      console.log(
        "馃崝 Sistema My Little Diner v9.0 OPTIMIZADO - Cargado correctamente"
      );

      // =====================================
      // PWA - SERVICE WORKER REGISTRATION
      // =====================================
      
      let deferredPrompt = null;
      let isStandalone = false;

      // Detectar si ya est谩 instalado como PWA
      if (window.matchMedia('(display-mode: standalone)').matches || 
          window.navigator.standalone === true) {
        isStandalone = true;
        console.log('馃摫 Ejecut谩ndose como PWA instalada');
      }

      // Registrar Service Worker s贸lo si estamos en http(s) y origin no es 'null'
      try {
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:') && location.origin !== 'null') {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('鉁?Service Worker registrado:', registration.scope);
              // Verificar actualizaciones
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      mostrarToast('馃攧 Nueva versi贸n disponible. Recarga la p谩gina', 'info', 5000);
                    }
                  });
                }
              });
            })
            .catch(error => {
              console.error('鉂?Error al registrar Service Worker:', error);
            });
        } else {
          console.log('ServiceWorker: salto de registro (protocolo u origen no v谩lido)', location.protocol, location.origin);
        }
      } catch (e) {
        console.warn('ServiceWorker guard error', e);
      }

      // --- Configuraci贸n din谩mica de logo y watermark seg煤n entorno ---
      try {
        const setLogoOverride = (url) => {
          document.documentElement.style.setProperty('--logo-image-override', `url("${url}")`);
        };
        const tryLoad = (url, onOk, onFail) => {
          const img = new Image();
          img.onload = () => onOk && onOk(url);
          img.onerror = () => onFail && onFail(url);
          img.src = url;
        };

        if (location.protocol === 'file:') {
          // En file:// evitamos cargar watermark PNG para no generar errores; pero s铆 intentamos logo local
          console.log('Entorno file://: intento de logo local en la misma carpeta (logo.png)');
          tryLoad('logo.png',
            () => setLogoOverride('logo.png'),
            () => console.log('logo.png no encontrado junto al HTML; se usa logo embebido'));
        } else {
          // En http/https: activamos watermark PNG y elegimos logo preferente
          const loginScreenEl = document.getElementById('loginScreen');
          if (loginScreenEl) loginScreenEl.classList.add('watermark-loaded');

          // Preferir logo.png en la ra铆z junto al HTML si existe; si no, fallback a img/logo.png
          tryLoad('logo.png',
            () => setLogoOverride('logo.png'),
            () => tryLoad('img/logo.png',
              () => setLogoOverride('img/logo.png'),
              () => console.log('No se encontr贸 logo.png ni img/logo.png; se usa logo embebido')
            )
          );
        }
      } catch(e) {
        // no cr铆tico
        console.warn('Logo/Watermark auto-config warning:', e);
      }

      // Capturar evento de instalaci贸n
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        if (!isStandalone) {
          mostrarPromptInstalacion();
        }
      });

      // Funci贸n para mostrar prompt de instalaci贸n
      function mostrarPromptInstalacion() {
        // Crear bot贸n de instalaci贸n flotante
        const installBtn = document.createElement('div');
        installBtn.id = 'install-pwa-btn';
        installBtn.innerHTML = `
          <div style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--c-brand);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(248, 80, 101, 0.3);
            cursor: pointer;
            z-index: 9999;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
          ">
            馃摫 Instalar App
            <span style="
              background: rgba(255,255,255,0.2);
              padding: 2px 8px;
              border-radius: 10px;
              font-size: 12px;
            ">
              鉁?            </span>
          </div>
        `;
        
        document.body.appendChild(installBtn);
        
        // Evento click para instalar
        installBtn.addEventListener('click', (e) => {
          if (e.target.textContent.includes('鉁?)) {
            installBtn.remove();
            return;
          }
          instalarPWA();
        });
        
        // Auto-ocultar despu茅s de 10 segundos
        setTimeout(() => {
          if (document.getElementById('install-pwa-btn')) {
            installBtn.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => installBtn.remove(), 500);
          }
        }, 10000);
      }

      // Funci贸n para instalar PWA
      function instalarPWA() {
        if (deferredPrompt) {
          vibrar(50);
          deferredPrompt.prompt();
          
          deferredPrompt.userChoice.then(result => {
            if (result.outcome === 'accepted') {
              console.log('鉁?PWA instalada por el usuario');
              mostrarToast('馃摫 App instalada correctamente', 'success');
            } else {
              console.log('鉂?Usuario cancel贸 la instalaci贸n');
            }
            deferredPrompt = null;
            
            const btn = document.getElementById('install-pwa-btn');
            if (btn) btn.remove();
          });
        }
      }

      // Escuchar cuando la app se instala
      window.addEventListener('appinstalled', () => {
        console.log('馃帀 PWA instalada exitosamente');
        mostrarToast('馃帀 隆App instalada! Ya puedes usarla desde tu escritorio', 'success', 4000);
        
        const btn = document.getElementById('install-pwa-btn');
        if (btn) btn.remove();
      });

      // Agregar animaci贸n CSS para el bot贸n de instalaci贸n
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        
        @keyframes fadeOut {
          to { opacity: 0; transform: translateY(20px); }
        }
      `;
      document.head.appendChild(style);

      // =====================================
      // FIN PWA CONFIGURATION
      // =====================================

      // =====================================
      // GESTOS T脕CTILES AVANZADOS
      // =====================================

      let touchStartX = 0;
      let touchStartY = 0;
      let isScrolling = false;

      // Swipe para cerrar modal
      document.addEventListener('touchstart', function(e) {
        if (e.target.closest('.modal-content')) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          isScrolling = false;
        }
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (!touchStartX || !touchStartY) return;
        
        let touchEndX = e.touches[0].clientX;
        let touchEndY = e.touches[0].clientY;
        
        let diffX = touchStartX - touchEndX;
        let diffY = touchStartY - touchEndY;
        
        // Determinar si es scroll vertical
        if (Math.abs(diffY) > Math.abs(diffX)) {
          isScrolling = true;
        }
      }, { passive: true });

      document.addEventListener('touchend', function(e) {
        if (!touchStartX || !touchStartY || isScrolling) {
          touchStartX = 0;
          touchStartY = 0;
          return;
        }
        
        let touchEndX = e.changedTouches[0].clientX;
        let touchEndY = e.changedTouches[0].clientY;
        
        let diffX = touchStartX - touchEndX;
        let diffY = touchStartY - touchEndY;
        
        // Swipe hacia abajo para cerrar modal (m铆nimo 100px)
        if (diffY < -100 && Math.abs(diffY) > Math.abs(diffX)) {
          const modal = document.getElementById('modal');
          if (modal && modal.classList.contains('show')) {
            vibrarContextual('success');
            cerrarModal();
          }
        }
        
        touchStartX = 0;
        touchStartY = 0;
        isScrolling = false;
      }, { passive: true });

      // Pull-to-refresh en estad铆sticas
      let pullStartY = 0;
      let pullDist = 0;

      document.addEventListener('touchstart', function(e) {
        if (window.scrollY === 0 && !document.getElementById('modal').classList.contains('show')) {
          pullStartY = e.touches[0].clientY;
        }
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (pullStartY === 0) return;
        
        pullDist = e.touches[0].clientY - pullStartY;
        
        if (pullDist > 0) {
          e.preventDefault();
          
          // Efecto visual de pull-to-refresh
          const statsBar = document.querySelector('.stats-bar');
          if (statsBar && pullDist > 50) {
            statsBar.style.transform = `translateY(${Math.min(pullDist * 0.3, 30)}px)`;
            statsBar.style.opacity = Math.max(0.7, 1 - (pullDist * 0.002));
          }
        }
      });

      document.addEventListener('touchend', function(e) {
        if (pullDist > 100) {
          vibrarContextual('success');
          mostrarToast('馃攧 Actualizando estad铆sticas...', 'info', 1500);
          actualizarEstadisticas();
          
          // Forzar repintado de todas las mesas
          setTimeout(() => {
            estado.mesas.forEach(mesa => actualizarVisualMesa(mesa.numero));
          }, 500);
        }
        
        // Resetear efectos visuales
        const statsBar = document.querySelector('.stats-bar');
        if (statsBar) {
          statsBar.style.transform = '';
          statsBar.style.opacity = '';
        }
        
        pullStartY = 0;
        pullDist = 0;
      });

      // Tap largo en mesas para opciones r谩pidas
      let longPressTimer;
      let isLongPress = false;

      document.addEventListener('touchstart', function(e) {
        const mesa = e.target.closest('.table');
        if (mesa && mesa.dataset.mesa) {
          isLongPress = false;
          longPressTimer = setTimeout(() => {
            isLongPress = true;
            vibrarContextual('longpress');
            mostrarOpcionesRapidaMesa(mesa.dataset.mesa);
          }, 700);
        }
      }, { passive: true });

      document.addEventListener('touchend', function(e) {
        clearTimeout(longPressTimer);
        if (isLongPress) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, { passive: true });

      function mostrarOpcionesRapidaMesa(numeroMesa) {
        const mesa = estado.mesas.get(numeroMesa);
        if (!mesa) return;
        
        let opciones = [];
        
        if (mesa.estado === 'libre') {
          opciones = ['馃崝 Nuevo Pedido'];
        } else if (mesa.estado === 'ocupada') {
          opciones = ['馃憖 Ver Pedido', '鉃?A帽adir Items', '馃挵 Cobrar', '鉂?Cancelar'];
        } else if (mesa.estado === 'pagado') {
          opciones = ['馃攧 Liberar Mesa'];
        }
        
        // Crear menu contextual
        const menu = document.createElement('div');
        menu.id = 'context-menu';
        menu.style.cssText = `
          position: fixed;
          bottom: 50%;
          left: 50%;
          transform: translate(-50%, 50%);
          background: white;
          border-radius: 15px;
          padding: 15px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          z-index: 10001;
          animation: menuSlideIn 0.2s ease-out;
          min-width: 200px;
        `;
        
        menu.innerHTML = `
          <div style="text-align: center; font-weight: bold; margin-bottom: 15px; color: var(--c-brand); font-size: 16px;">
            Mesa ${numeroMesa}
          </div>
          ${opciones.map(opcion => `
            <button style="
              width: 100%;
              padding: 12px;
              margin: 5px 0;
              border: none;
              border-radius: 10px;
              background: var(--c-accent-light);
              font-weight: 600;
              cursor: pointer;
              font-size: 14px;
            " onclick="ejecutarOpcionRapida('${numeroMesa}', '${opcion}')">${opcion}</button>
          `).join('')}
          <button style="
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid var(--c-brand);
            border-radius: 10px;
            background: white;
            color: var(--c-brand);
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
          " onclick="cerrarMenuContextual()">Cancelar</button>
        `;
        
        // Backdrop para cerrar
        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.5);
          z-index: 10000;
        `;
        backdrop.onclick = cerrarMenuContextual;
        
        document.body.appendChild(backdrop);
        document.body.appendChild(menu);
      }

      function ejecutarOpcionRapida(numeroMesa, opcion) {
        cerrarMenuContextual();
        
        setTimeout(() => {
          if (opcion.includes('Nuevo Pedido') || opcion.includes('Ver Pedido')) {
            abrirModal(numeroMesa, estado.mesas.get(numeroMesa)?.zona || 'Mesa');
          } else if (opcion.includes('A帽adir Items')) {
            continuarPedido(numeroMesa);
          } else if (opcion.includes('Cobrar')) {
            cobrarMesa(numeroMesa);
          } else if (opcion.includes('Cancelar')) {
            cancelarPedido(numeroMesa);
          } else if (opcion.includes('Liberar')) {
            liberarMesa(numeroMesa);
          }
        }, 100);
      }

      function cerrarMenuContextual() {
        const menu = document.getElementById('context-menu');
        const backdrop = document.querySelector('div[style*="rgba(0,0,0,0.5)"]');
        
        if (menu) menu.remove();
        if (backdrop) backdrop.remove();
      }

      // =====================================
      // FEEDBACK T脕CTIL MEJORADO
      // =====================================

      // Vibraci贸n contextual seg煤n el tipo de acci贸n
      function vibrarContextual(tipo) {
        if (!navigator.vibrate || !window.userInteracted) return;
        
        switch(tipo) {
          case 'success':
            navigator.vibrate([50, 30, 50]);
            break;
          case 'error':
            navigator.vibrate([100, 50, 100, 50, 100]);
            break;
          case 'tap':
            navigator.vibrate(25);
            break;
          case 'longpress':
            navigator.vibrate(50);
            break;
          default:
            navigator.vibrate(30);
        }
      }

      // Funci贸n vibrar original para compatibilidad
      function vibrar(ms = 30) {
        if (navigator.vibrate && window.userInteracted) {
          navigator.vibrate(ms);
        }
      }

      // Mejorar las funciones existentes con vibraci贸n contextual
      const originalMostrarToast = mostrarToast;
      mostrarToast = function(mensaje, tipo = 'info', duracion = 3000) {
        vibrarContextual(tipo);
        return originalMostrarToast(mensaje, tipo, duracion);
      };

      // Optimizaci贸n de eventos t谩ctiles
      let touchTimeout;
      document.addEventListener("touchstart", function(e) {
        if (e.target.matches("button, .boton, .btn")) {
          clearTimeout(touchTimeout);
          touchTimeout = setTimeout(() => vibrarContextual('tap'), 10);
        }
      }, { passive: true });

      document.addEventListener("click", function(e) {
        if (e.target.matches("button, .boton, .btn")) {
          vibrarContextual('tap');
        }
      });

      // =====================================
      // OPTIMIZACIONES DE NAVEGACI脫N M脫VIL
      // =====================================

      // Teclado virtual optimization
      let initialViewportHeight = window.innerHeight;

      window.addEventListener('resize', function() {
        const currentHeight = window.innerHeight;
        const heightDifference = initialViewportHeight - currentHeight;
        
        // Si la altura se reduce significativamente, probablemente es el teclado
        if (heightDifference > 150) {
          document.body.classList.add('keyboard-visible');
          
          // Ajustar modal si est谩 abierto
          const modal = document.querySelector('.modal.show');
          if (modal) {
            modal.style.alignItems = 'flex-start';
            modal.style.paddingTop = '20px';
          }
        } else {
          document.body.classList.remove('keyboard-visible');
          
          // Restaurar modal
          const modal = document.querySelector('.modal.show');
          if (modal) {
            modal.style.alignItems = 'flex-end';
            modal.style.paddingTop = '';
          }
        }
      });

      // Scroll suave mejorado para categor铆as
      document.addEventListener('DOMContentLoaded', function() {
        const categoryTabs = document.querySelector('.category-tabs');
        if (categoryTabs) {
          // Mejora el scroll horizontal con momentum en iOS
          categoryTabs.style.webkitOverflowScrolling = 'touch';
          categoryTabs.style.scrollBehavior = 'smooth';
        }
      });

      // Optimizaci贸n de scroll en productos
      let scrollTimeout;
      document.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          // Lazy loading de im谩genes si las hubiera
          const visibleProducts = document.querySelectorAll('.product:not([data-loaded])');
          visibleProducts.forEach(product => {
            const rect = product.getBoundingClientRect();
            if (rect.top < window.innerHeight && rect.bottom > 0) {
              product.dataset.loaded = 'true';
            }
          });
        }, 100);
      }, { passive: true });

      // =====================================
      // MEJORAS DE ACCESIBILIDAD
      // =====================================

      // Focus mejorado para navegaci贸n con teclado
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const modal = document.getElementById('modal');
          if (modal && modal.classList.contains('show')) {
            cerrarModal();
          }
          
          const menu = document.getElementById('context-menu');
          if (menu) {
            cerrarMenuContextual();
          }
        }
      });

      // Agregar estilos CSS para mejoras m贸viles
      const mobileOptimizationStyles = document.createElement('style');
      mobileOptimizationStyles.textContent = `
        /* =====================================
           OPTIMIZACIONES M脫VILES ADICIONALES
           ===================================== */
        
        /* Animaci贸n para men煤 contextual */
        @keyframes menuSlideIn {
          from { transform: translate(-50%, 50%) scale(0.8); opacity: 0; }
          to { transform: translate(-50%, 50%) scale(1); opacity: 1; }
        }
        
        /* Mejora del 谩rea t谩ctil m铆nima */
        button, .table, .product, .category-tab {
          min-height: 44px;
          min-width: 44px;
        }

        /* Espaciado optimizado para dedos */
        .admin-grid {
          gap: 16px;
        }

        .tables {
          gap: 16px;
        }

        .products {
          gap: 16px;
        }

        /* Scroll mejorado */
        .category-tabs {
          -webkit-overflow-scrolling: touch;
          scroll-snap-type: x mandatory;
          padding-right: 20px;
        }

        .category-tab {
          scroll-snap-align: start;
          flex-shrink: 0;
        }

        /* Estados de carga */
        .loading-shimmer {
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }

        /* Focus mejorado */
        button:focus-visible,
        .table:focus-visible,
        .product:focus-visible {
          outline: 3px solid var(--c-brand);
          outline-offset: 2px;
        }

        /* Animaciones de tap m谩s suaves */
        .table:active,
        .product:active,
        button:active {
          transform: scale(0.97);
          transition: transform 0.1s ease-out;
        }

        /* Loading state para botones */
        button.loading {
          pointer-events: none;
          opacity: 0.7;
          position: relative;
        }

        button.loading::after {
          content: '';
          position: absolute;
          width: 16px;
          height: 16px;
          margin: auto;
          border: 2px solid transparent;
          border-top-color: currentColor;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Adaptaci贸n para teclado virtual */
        .keyboard-visible .modal-content {
          max-height: 60vh !important;
        }

        /* Optimizaci贸n para pantallas muy peque帽as */
        @media (max-height: 600px) {
          .login-box {
            padding: 25px 20px;
            max-width: 340px;
          }
          
          .modal-content {
            max-height: 85vh;
          }
          
          .header {
            padding: 12px;
          }
        }

        /* Optimizaci贸n para tablets horizontales */
        @media (min-width: 768px) and (orientation: landscape) {
          .products {
            grid-template-columns: repeat(4, 1fr);
          }
          
          .tables {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          }
          
          .admin-grid {
            grid-template-columns: repeat(4, 1fr);
          }
        }

        /* Mejoras de contraste para accesibilidad */
        @media (prefers-contrast: high) {
          :root {
            --c-brand: #d63544;
            --c-accent: #2d5a3d;
          }
          
          .table.libre {
            border-width: 4px;
          }
          
          .table.ocupada {
            border-width: 4px;
          }
        }

        /* Reducir animaciones si el usuario lo prefiere */
        @media (prefers-reduced-motion: reduce) {
          *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
          }
        }

        /* Dark mode para sistemas que lo prefieran */
        @media (prefers-color-scheme: dark) {
          .modal-content {
            background: #2d2d2d;
            color: #ffffff;
          }
          
          .search-bar input {
            background: #3d3d3d;
            color: #ffffff;
            border-color: var(--c-accent);
          }
        }

        /* Mejoras para dispositivos con notch */
        @supports (padding: max(0px)) {
          .header {
            padding-left: max(18px, env(safe-area-inset-left));
            padding-right: max(18px, env(safe-area-inset-right));
          }
          
          .fab {
            bottom: max(calc(20px + env(safe-area-inset-bottom)), 20px);
            right: max(20px, env(safe-area-inset-right));
          }
          
          .fab-resumen {
            right: max(20px, env(safe-area-inset-right));
          }
        }

        /* Mejoras de tipograf铆a para m贸viles */
        @media (max-width: 480px) {
          .product h3 {
            font-size: 14px;
            line-height: 1.3;
          }
          
          .product .price {
            font-size: 16px;
            font-weight: 700;
          }
          
          .table-number {
            font-size: 18px;
            font-weight: 800;
          }
        }

        /* ===================================== */
      `;
      document.head.appendChild(mobileOptimizationStyles);

      console.log('馃摫 Optimizaciones m贸viles avanzadas cargadas');

      // MANEJADOR GLOBAL MEJORADO DE ERRORES DE PROMESAS
      window.addEventListener('unhandledrejection', (event) => {
        console.error('馃毃 Promesa rechazada no manejada:', event.reason);
        
        // Prevenir el error en consola por defecto
        event.preventDefault();
        
        // Mostrar notificaci贸n al usuario solo si es cr铆tico
        const reason = event.reason;
        if (reason && reason.message && !reason.message.includes('Network')) {
          mostrarToast('鈿狅笍 Error del sistema detectado', 'warning', 3000);
        }
        
        // Log detallado para debugging
        if (typeof sistemaLogs !== 'undefined') {
          sistemaLogs.error('Promesa rechazada', {
            razon: reason,
            stack: (reason && reason.stack) ? reason.stack : undefined,
            timestamp: new Date().toISOString()
          });
        }
      });

      // MANEJADOR GLOBAL DE ERRORES DE JAVASCRIPT
      window.addEventListener('error', (event) => {
        console.error('馃毃 Error de JavaScript:', event.error);
        // Solo mostrar notificaci贸n para errores cr铆ticos
        if (event.error && !event.error.message.includes('Script error')) {
          mostrarToast('鈿狅笍 Error detectado', 'error', 2000);
        }
        
        // Log detallado
        if (typeof sistemaLogs !== 'undefined') {
          sistemaLogs.error('Error de JavaScript', {
            mensaje: event.message,
            archivo: event.filename,
            linea: event.lineno,
            columna: event.colno,
            error: event.error,
            timestamp: new Date().toISOString()
          });
        }
      });

      console.log('馃洝锔?Manejadores globales de errores configurados');

      // Helpers seguros para vibraci贸n y AudioContext (evitan llamadas antes de interacci贸n del usuario)
      function vibrarSeguro(pattern) {
        try {
          if (!window.userInteracted) return;
          if (navigator && typeof navigator.vibrate === 'function') navigator.vibrate(pattern);
        } catch (e) { }
      }

      function crearAudioContextSeguro() {
        try {
          if (window.__deferredAudioContext && !window.__deferredAudioContext._deferred) return window.__deferredAudioContext;
          if (window.userInteracted) {
            window.__deferredAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            return window.__deferredAudioContext;
          }
          // placeholder que ser谩 reanudado al primer gesto
          window.__deferredAudioContext = { _deferred: true, resume: () => Promise.resolve() };
          return window.__deferredAudioContext;
        } catch (e) { return null; }
      }

    </script>
</body>

</html>
